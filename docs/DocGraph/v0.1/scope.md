# DocGraph v0.1 - 功能边界文档

> **版本**：v0.1.0  
> **状态**：草案（待畅谈会确认）  
> **目的**：明确v0.1简化版MVP的功能边界，指导设计和实现

---

## 1. 版本定位与核心价值

### 1.1 版本定位
**DocGraph v0.1** 是一个**文档关系验证器**（Document Relationship Validator），专注于：
- 基于`produce`关系构建文档图（wish → 产物文档）
- 验证双向链接完整性（`produce` ↔ `produce_by`）
- 报告悬空引用和缺失的反向链接
- 实现"分散撰写，自动验证关系"的工作流

### 1.2 核心价值主张
- **对文档撰写者**：只需在frontmatter中维护`produce`关系，工具自动验证完整性
- **对项目管理者**：自动获得文档关系图，发现断裂的链接
- **对团队协作**：分散工作，集中验证，确保文档关系一致性

### 1.3 与完整版的关系
- **v0.1**：简化版，仅frontmatter解析，快速交付
- **future**：完整版，包含Markdown解析、链接分析等高级功能
- **演进路径**：v0.1 → v1.0（添加正文基础分析）→ v2.0+（添加高级功能）

---

## 2. 功能边界（做什么 vs 不做什么）

### 2.1 ✅ v0.1 明确要做

#### 核心功能
1. **Root Nodes扫描**
   - 扫描 `wishes/active` 和 `wishes/completed` 目录及子目录的所有 `.md` 文件
   - 忽略无frontmatter的文件
   - 解析frontmatter，构建root nodes集合（wish文档）

2. **Produce关系提取**
   - 从root nodes的frontmatter中提取 `produce` 关系集合
   - `produce` 关系：wish文档 → 产物文档的链接
   - 支持数组格式：`produce: ["path/to/api.md", "path/to/spec.md"]`

3. **文档图闭包构建**
   - 基于root nodes中的所有 `produce` 关系
   - 递归追踪关系，构建完整的可达文档集合
   - 支持图结构（允许环），不强制树结构

4. **双向链接验证**
   - **produce关系验证**：
     - 确保目标文档存在且有frontmatter
     - 悬空引用汇总到报告
     - 目标文件缺失frontmatter时按文档创建
   - **produce_by关系验证**：
     - 确保目标文档的frontmatter中包含对应的 `produce_by` 关系
     - 悬空引用汇总到报告
     - 缺失反向链接汇总到报告

5. **问题报告生成**
   - 生成详细的验证报告
   - 分类报告：悬空引用、缺失反向链接、格式错误等
   - 输出为人类可读的格式（Markdown表格）

6. **自动维护（极简）**
   - **produce目标缺失frontmatter**：创建最基本的frontmatter
   - **模板内容**：仅包含`docId`（从文件名推导）、`title`（占位符）、`produce_by`（源文档路径）
   - **原则**：最小干预，只创建缺失的，不修改现有的

7. **汇总文档生成（第二阶段）**
   - **输入**：内存中的完整文档图
   - **模式**：Visitor模式，C#代码直接实现具体汇总逻辑
   - **输出**：生成`.gen.md`后缀的汇总文档
   - **代码驱动**：每个汇总文档类型有独立的Visitor实现
   - **渐进抽象**：先实现具体需求，发现模式后再提炼通用功能

#### 输出约定
8. **验证报告**
   - 输出验证结果摘要
   - 按问题类型分类的详细列表
   - 建议的修复操作（仅建议，不自动修复）

9. **汇总文档**
   - 输出文件使用`.gen.md`后缀
   - 文件开头包含机器生成声明
   - 示例：`<!-- 本文档由DocGraph工具自动生成，手动编辑无效 -->`

### 2.2 ❌ v0.1 明确不做

#### 技术复杂性规避
1. **不解析Markdown正文**
   - 忽略`---`之后的所有内容
   - 不提取正文中的链接、标题、代码块等
   - 不分析正文语义

2. **不处理文档链接**
   - 不提取`[text](path.md)`格式的链接
   - 不验证链接目标是否存在
   - 不分析链接关系

3. **不自动修复双向链接**
   - 检测缺失的反向链接但仅报告
   - 不自动添加或修改`produce_by`字段
   - 维护链接关系图但仅用于验证和报告

4. **不进行路径处理**
   - 不规范化相对路径`../`
   - 不检查路径越界
   - 不处理操作系统路径差异

5. **不实现高级功能**
   - 无增量扫描
   - 无文件监听
   - 无缓存机制
   - 无并行处理

#### 业务逻辑简化
6. **不分析文档语义**
   - 不理解文档内容含义
   - 不进行分类或标签建议
   - 不提供智能摘要

7. **不管理文档状态**
   - 不跟踪文档版本历史
   - 不检测文档冲突
   - 不分配维护任务

---

## 3. 技术规范与约束

### 3.1 frontmatter schema（v0.1核心）

#### Root Nodes（Wish文档）字段
| 字段名 | 类型 | 必填 | 说明 | 示例 |
|:-------|:-----|:-----|:-----|:-----|
| `title` | string | ✅ | Wish标题 | `"需求文档模板"` |
| `produce` | string[] | ✅ | 产物关系列表 | `["atelia/docs/DocGraph/api.md", "atelia/docs/DocGraph/spec.md"]` |

**推导字段**：
- `docId`：从文件名推导（`wish-0001.md` → `W-0001`）
- `status`：从文件夹推导（`active/` → `"active"`, `completed/` → `"completed"`）

#### 关系字段（v0.1核心功能）
| 字段名 | 类型 | 说明 | 示例 |
|:-------|:-----|:-----|:-----|
| `produce` | string[] | **产物关系**：本Wish产生的文档路径列表 | `["atelia/docs/DocGraph/api.md", "atelia/docs/DocGraph/spec.md"]` |
| `produce_by` | string[] | **反向关系**：产生本文档的Wish路径列表 | `["wishes/active/wish-0002.md"]` |



#### 产物文档字段
| 字段名 | 类型 | 必填 | 说明 | 示例 |
|:-------|:-----|:-----|:-----|:-----|
| `docId` | string | ✅ | 文档标识 | `"W-0002-L2"` |
| `title` | string | ✅ | 文档标题 | `"API设计文档"` |
| `produce_by` | string[] | ✅ | 产生本文档的Wish路径列表 | `["wishes/active/wish-0002.md"]` |

### 3.2 输入处理约束

#### Root Nodes扫描
- **扫描目录**：固定扫描 `wishes/active` 和 `wishes/completed` 两个目录
- **文件过滤**：仅`.md`文件，忽略无frontmatter的文件
- **编码假设**：UTF-8，不支持自动检测

#### Produce关系处理
- **关系提取**：从`produce`字段提取文档路径数组
- **路径格式**：支持相对路径和绝对路径（相对于workspace根目录）
- **闭包构建**：递归追踪所有`produce`关系，构建完整文档图
- **环检测**：检测循环引用但不禁止，仅记录警告

#### 双向链接验证规则
1. **Produce关系验证**：
   - 目标文档必须存在
   - 目标文档必须有frontmatter
   - 悬空引用记录为错误

2. **Produce_by关系验证**：
   - 目标文档的`produce_by`必须包含源文档路径
   - 缺失反向链接记录为警告
   - 悬空`produce_by`记录为错误

#### 错误处理
- **YAML解析错误**：跳过该文件，记录错误
- **必填字段缺失**：记录警告，继续处理
- **关系验证错误**：记录详细错误信息，包括源路径、目标路径、行号等

### 3.3 输出约束

#### 3.3.1 验证报告约束

##### 报告格式
- **摘要部分**：总体统计（扫描文件数、关系数、错误数、警告数）
- **错误分类**：按问题类型分组（悬空引用、缺失反向链接、格式错误等）
- **详细列表**：每个问题的详细信息（源文件、目标文件、行号、建议修复）

##### 报告内容
1. **扫描统计**：
   - Root nodes数量
   - 产物文档数量
   - 总关系数量

2. **问题分类**：
   - **错误**：必须修复的问题（悬空引用、必填字段缺失）
   - **警告**：建议修复的问题（缺失反向链接、格式不一致）
   - **信息**：仅供参考的问题（环检测、性能提示）

3. **修复建议**：
   - 具体的修复操作建议
   - 受影响文件列表
   - 预期修复后的状态

##### 输出要求
- **幂等性**：相同输入必须产生相同报告
- **可读性**：人类可读的格式，支持Markdown和纯文本
- **可操作性**：报告内容应可直接用于修复操作

#### 3.3.2 汇总文档生成约束

##### 生成模型
- **两阶段处理**：
  1. 构建完整的文档图（包含所有节点和关系）
  2. Visitor模式遍历文档图生成汇总文档

- **Visitor模式**：
  - **基础接口**：`IDocumentGraphVisitor` 定义Visit和GenerateOutput方法
  - **具体实现**：每个汇总文档类型实现独立的Visitor
  - **执行流程**：构建图 → 遍历节点调用Visitor → 生成输出

##### 已知汇总文档类型
1. **术语表生成器** (`GlossaryVisitor`)
   - **输入字段**：`defines`（术语定义数组）
   - **输出格式**：紧凑Markdown列表（文档路径 → bullet列表）
   - **示例输出**：
     ```
     ## api.md
     - **DocumentNode**：文档图中的节点，表示一个文档
     - **Produce关系**：wish文档到产物文档的链接
     
     ## spec.md  
     - **Frontmatter**：文档头部的YAML元信息块
     - **Visitor模式**：遍历文档图生成汇总的访问者模式
     ```

2. **问题汇总器** (`IssueAggregator`)
   - **输入字段**：`issues`（问题描述数组）
   - **输出格式**：分类的问题表格或列表
   - **输出内容**：问题描述、来源文档、状态、负责人等

3. **开放扩展**
   - 其他汇总器按需实现
   - 每个汇总器定义自己需要的frontmatter字段
   - 鼓励发现和积累常见模式

##### 生成要求
- **基于完整图**：汇总时能访问完整的文档关系
- **代码驱动**：行为由C#代码直接定义，灵活可调试
- **幂等性**：相同输入产生相同输出
- **渐进抽象**：先实现具体需求，后续提炼通用模式

### 3.4 错误处理约束

#### 必须处理的错误
1. **YAML解析错误**
   - 语法错误
   - 编码错误
   - 结构错误

2. **必填字段缺失**
   - `title`缺失（Root Nodes和产物文档）
   - `produce`缺失（Root Nodes）
   - `produce_by`缺失（产物文档）

3. **字段格式错误**
   - 类型不匹配（如`defines`不是数组）
   - 值格式错误（如日期格式）

#### 可以忽略的错误
1. **正文内容错误**
   - Markdown语法错误
   - 链接目标不存在
   - 格式不一致

2. **文件系统错误**
   - 权限问题（记录但继续）
   - 符号链接问题
   - 临时文件问题

#### 错误报告格式
```yaml
errorCode: "DOCMETA_YAML_PARSE_ERROR"
severity: "Error"
message: "YAML解析失败"
filePath: "wishes/active/wish-0001.md"
details:
  line: 3
  column: 5
  snippet: "title: 需求文档模板"
suggestion: "检查YAML语法，确保缩进正确"
```

---

## 4. 接口设计原则

### 4.1 简化原则
- **接口数量**：最小集，建议1-2个核心接口
- **参数数量**：最少必需参数
- **返回值**：简单明确的数据结构

### 4.2 扩展性原则
- **为v1.0预留**：数据结构可扩展
- **配置驱动**：行为可通过配置调整
- **插件架构**：为未来插件预留钩子

### 4.3 测试友好原则
- **依赖注入**：支持测试替身
- **纯函数**：核心逻辑无副作用
- **确定性**：相同输入确定输出

---

## 5. 开发约束

### 5.1 技术栈约束
- **.NET版本**：.NET 9.0+
- **YAML库**：YamlDotNet
- **CLI框架**：System.CommandLine（可选）
- **测试框架**：xUnit

### 5.2 代码质量约束
- **测试覆盖率**：核心逻辑≥80%
- **代码规范**：遵循项目现有规范
- **文档要求**：公共API必须有XML注释

### 5.3 性能约束
- **内存使用**：可处理1000+文件
- **执行时间**：无硬性要求，但应有进度反馈
- **磁盘IO**：合理使用缓存

---

## 6. 验收标准

### 6.1 功能验收标准

#### 第一阶段：文档图构建与验证
1. ✅ 能扫描 `wishes/active` 和 `wishes/completed` 目录的wish文档
2. ✅ 能从文件名推导`docId`，从文件夹推导`status`
3. ✅ 能正确解析frontmatter中的 `produce` 和 `produce_by` 关系
4. ✅ 能基于 `produce` 关系构建完整的文档图闭包
5. ✅ 能验证双向链接完整性（`produce` ↔ `produce_by`）
6. ✅ 能自动创建缺失frontmatter的产物文档（极简模板）

#### 第二阶段：汇总文档生成
6. ✅ 能基于内存中的文档图实现Visitor模式遍历
7. ✅ 能实现术语表生成器（从`defines`字段生成紧凑列表）
8. ✅ 能实现问题汇总器（从`issues`字段生成分类表格）
9. ✅ 支持按需添加新的Visitor实现
10. ✅ 能生成详细的验证报告，分类报告问题

#### 输出验收
11. ✅ 验证报告可读且可操作
12. ✅ 汇总文档格式正确且幂等
13. ✅ 所有输出文件有明确的机器生成标识

### 6.2 质量验收标准
7. ✅ 相同输入产生相同输出（幂等性）
8. ✅ 错误处理合理，不崩溃
9. ✅ 代码有基本测试覆盖
10. ✅ 有基本的使用文档
11. ✅ 可通过命令行使用

### 6.3 用户体验标准
12. ✅ 有清晰的错误信息
13. ✅ 有进度反馈（处理文件数）
14. ✅ 输出文件易于阅读
15. ✅ 有简单的帮助信息

---

## 7. 演进考虑

### 7.1 v1.0 扩展点预留
1. **正文分析扩展**：为Markdown解析预留接口
2. **链接处理扩展**：为链接提取预留数据结构

### 7.2 数据兼容性
- v0.1的输出可作为v1.0的输入
- v0.1的配置格式可向上兼容
- v0.1的错误码体系可扩展

### 7.3 架构演进路径
```
v0.1: 文档图构建 + 双向验证 + Visitor模式汇总（代码驱动）
    ↓
v1.0: + 自动修复建议 + 增量验证 + 提炼通用Visitor模式
    ↓  
v1.5: + 正文链接分析 + 语义关系提取 + 配置系统（基于经验）
    ↓
v2.0: + 工作流集成 + 实时同步 + 团队协作
```

---

## 8. 待决策事项

### 8.1 设计决策（需畅谈会确定）
| 决策项 | 选项 | 建议 | 影响 |
|:-------|:-----|:-----|:-----|
| **接口数量** | 单接口 vs 双接口 | 双接口（解析+聚合） | 架构清晰度 |
| **frontmatter schema** | 严格 vs 宽松 | 严格必填，宽松可选 | 数据质量 |
| **错误处理策略** | 严格 vs 宽松 | 严格必填字段，宽松格式 | 用户体验 |
| **输出格式** | 简单 vs 丰富 | 简单表格，可扩展 | 使用价值 |

### 8.2 技术决策（需技术评估）
| 决策项 | 选项 | 建议 | 理由 |
|:-------|:-----|:-----|:-----|
| **YAML库配置** | 严格模式 vs 宽松模式 | 严格模式 | 数据一致性 |
| **文件编码处理** | 自动检测 vs 固定UTF-8 | 固定UTF-8 | 简化实现 |
| **并发处理** | 同步 vs 异步 | 同步 | v0.1简化 |

### 8.3 业务决策（需产品思维）
| 决策项 | 选项 | 建议 | 用户价值 |
|:-------|:-----|:-----|:---------|
| **默认表格列** | 固定 vs 可配置 | 固定核心列 | 快速上手 |
| **字段提取策略** | 全部提取 vs 选择提取 | 全部提取 | 信息完整 |
| **错误报告详细度** | 详细 vs 简洁 | 简洁但 actionable | 易于处理 |

---

## 9. 变更记录

| 版本 | 日期 | 作者 | 变更说明 |
|:-----|:-----|:-----|:---------|
| 0.1.0-draft | 2025-12-31 | 刘德智 | 初始草案，基于版本缩减决策 |
| 0.1.1 | 2026-01-01 | 畅谈会 | 待确认和细化 |

---

## 10. 下一步行动

### 10.1 立即行动（畅谈会）
1. 确认本文档的功能边界
2. 细化frontmatter schema
3. 确定接口设计方向
4. 制定开发计划

### 10.2 后续行动（实施）
5. 基于确认的scope创建api.md
6. 基于api.md创建spec.md
7. 开始v0.1实现
8. 3-5天交付可用工具

### 10.3 长期考虑
9. 收集v0.1用户反馈
10. 规划v1.0功能扩展
11. 维护版本演进路线

---

**使用说明**：本文档是v0.1所有设计和实现的**唯一权威边界参考**。任何超出本文档范围的功能需求应推迟到v1.0或future版本。