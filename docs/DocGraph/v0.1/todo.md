# DocGraph v0.1 - 待办事项与问题追踪

> **版本**：v0.1.0  
> **创建日期**：2026-01-01  
> **目的**：记录需要进一步探讨的问题、识别的风险和v1.0扩展点规划

---

## 1. 需要进一步探讨的问题

### 1.1 设计决策待确认

#### 问题 1：自动维护的交互模式 ✅ **已解决**
**背景**：scope.md 定义了"自动创建缺失frontmatter"功能，但交互细节未明确。

**解决方案**（基于2026-01-01畅谈会）：
- **CLI命令**：`docgraph validate --fix [--dry-run] [--yes]`
- **操作模式**：批量预览 + dry-run + 自动确认组合策略
- **错误恢复**：v0.1采用fail-fast策略，遇首错即停
- **模板设计**：硬编码模板，通过dry-run预览内容

**具体设计**：
- 默认：批量预览模式（显示清单 → 一键确认）
- 必选：`--dry-run` 只预览不执行
- 可选：`--yes` 跳过确认（CI/CD场景）
- 安全升级：>5文件时自动改为`[y/N]`确认

**规范更新**：
- 修改2条条款，新增4条条款
- 添加修复相关错误码和退出码
- 更新api.md接口设计

**实施状态**：✅ 设计完成，可立即开始编码

#### 问题 2：Visitor 字段契约的具体实现
**背景**：Craftsman 建议使用 Attribute 声明字段契约，但具体设计未确定。

**待决策**：
- Attribute 设计：`[FrontmatterField("defines")]` vs `[RequiresField("defines")]`
- 编译期检查如何实现？
- 运行时验证的粒度？

**影响**：影响 Visitor 扩展的开发者体验。

**建议讨论时间**：v0.1 实现中可以初步实现，v1.0 完善。

#### 问题 3：错误报告的双受众格式
**背景**：Curator 建议同时支持 Human/Machine 格式，但具体实现未确定。

**待决策**：
- 是否默认输出两种格式？
- Machine 格式的 schema 设计？
- 如何保持两种格式的一致性？

**影响**：影响 CI/CD 集成和自动化处理。

**建议讨论时间**：v0.1 可以先实现 Human 格式，v1.0 添加 Machine 格式。

### 1.2 技术细节待细化

#### 问题 4：YAML 解析的资源限制具体值
**背景**：spec.md 定义了资源上限，但具体数值可能需要调整。

**待确认**：
- 64KB frontmatter 上限是否足够？
- 10层嵌套深度是否合理？
- 是否需要根据实际使用数据调整？

**影响**：影响工具对大型文档的处理能力。

**建议**：v0.1 使用当前值，v1.0 根据实际使用反馈调整。

#### 问题 5：路径规范化的边界情况 ⚠️ **部分解决**
**背景**：路径规范化算法需要处理各种边界情况。

**v0.1简化方案**（基于2026-01-01畅谈会）：
- **基本规范化**：消解`.`/`..`，统一分隔符为`/`
- **边界处理**：遇到非常规路径时记录警告，继续处理
- **安全限制**：必须检查路径越界（workspace内）

**v1.0完善规划**：
- Unicode 路径处理（NFD/NFKC规范化）
- 混合分隔符智能处理
- 符号链接解析策略
- 完整的边界情况测试

**当前决策**：
- v0.1采用简化处理，确保核心功能可用
- 记录遇到的边界情况警告
- v1.0根据实际使用反馈完善

**实施状态**：🔧 部分解决，v0.1可开始实施基本功能

### 1.3 业务逻辑待澄清

#### 问题 6：产物文档的 docId 生成规则
**背景**：产物文档 docId 需要显式填写，但命名规则未明确。

**待确定**：
- 是否有推荐的命名约定？
- 如何避免冲突？
- 是否支持自动生成建议？

**影响**：影响文档标识的一致性和可读性。

**建议**：v0.1 不强制规则，v1.0 提供最佳实践指南。

#### 问题 7：issues 字段的状态值约定
**背景**：IssueAggregator 需要处理 issues 状态，但状态值未标准化。

**待确定**：
- 支持哪些状态值？
- 是否支持自定义状态？
- 状态转换规则？

**影响**：影响问题跟踪的规范性。

**建议**：v0.1 支持常见状态（open/in-progress/resolved/closed），v1.0 支持自定义。

---

## 2. 识别出的风险与缓解策略

### 2.1 技术风险

#### 风险 1：路径语义不闭合
**描述**：虽然修正了 scope.md 的矛盾，但路径处理仍可能遇到边界情况。

**可能性**：中
**影响**：中
**缓解策略**：
- 实现详细的路径规范化测试
- 记录遇到的边界情况
- 提供清晰的错误信息

#### 风险 2：YAML 解析性能问题
**描述**：大型或复杂的 frontmatter 可能导致解析性能问题。

**可能性**：低
**影响**：中
**缓解策略**：
- 实施资源上限约束
- 提供进度反馈
- 支持跳过问题文件继续处理

#### 风险 3：Visitor 执行不稳定
**描述**：用户自定义的 Visitor 可能包含 bug，影响整体执行。

**可能性**：中
**影响**：低
**缓解策略**：
- Visitor 独立执行，失败不阻塞其他
- 提供详细的错误信息
- 支持 dry-run 模式

### 2.2 进度风险

#### 风险 4：报告格式复杂度超预期
**描述**：实现 Curator 建议的三层错误建议可能耗时较长。

**可能性**：中
**影响**：中
**缓解策略**：
- v0.1 先实现基本错误信息
- v1.0 再完善三层建议结构
- 优先级排序：先功能后美化

#### 风险 5：测试覆盖不足
**描述**：由于时间限制，可能无法实现完整的测试覆盖。

**可能性**：高
**影响**：中
**缓解策略**：
- 聚焦核心功能的测试
- 使用快照测试减少维护成本
- 后续迭代中补充测试

### 2.3 质量风险

#### 风险 6：与 future 版本概念混淆
**描述**：v0.1 和 future 版本的功能边界可能被混淆。

**可能性**：中
**影响**：低
**缓解策略**：
- 在文档中明确区分
- 错误信息中注明"v0.1 不支持"
- 代码中隔离不同版本逻辑

#### 风险 7：用户体验不一致
**描述**：不同 Visitor 的输出格式可能不一致。

**可能性**：中
**影响**：低
**缓解策略**：
- 提供输出模板和示例
- 内置 Visitor 作为参考实现
- 文档中提供格式约定

---

## 3. v1.0 扩展点规划

### 3.1 配置系统

#### 扩展点 1：Visitor 配置化
**当前**：v0.1 Visitor 硬编码在代码中
**v1.0**：支持通过配置文件注册和配置 Visitor

**具体功能**：
- YAML/JSON 配置文件定义 Visitor
- 支持输出路径、字段映射等配置
- 动态加载 Visitor 程序集

#### 扩展点 2：路径映射规则
**当前**：v0.1 使用固定路径规则
**v1.0**：支持可配置的路径映射

**具体功能**：
- 别名映射（如 `@docs` → `./atelia/docs`）
- 路径重写规则
- 多 workspace 支持

### 3.2 高级分析功能

#### 扩展点 3：正文链接分析
**当前**：v0.1 不解析 Markdown 正文
**v1.0**：支持基础正文链接分析

**具体功能**：
- 提取 `[text](path)` 格式链接
- 验证链接目标存在性
- 报告悬空正文链接

#### 扩展点 4：语义关系提取
**当前**：v0.1 只处理显式声明的 produce 关系
**v1.0**：支持语义关系推断

**具体功能**：
- 基于内容相似度的关系建议
- 分类和标签建议
- 文档聚类分析

### 3.3 工作流集成

#### 扩展点 5：增量扫描
**当前**：v0.1 每次全量扫描
**v1.0**：支持增量扫描

**具体功能**：
- 文件监听（watch mode）
- 缓存机制
- 只处理变更的文件

#### 扩展点 6：CI/CD 集成
**当前**：v0.1 提供基本 CLI
**v1.0**：深度 CI/CD 集成

**具体功能**：
- GitHub Actions 集成
- PR 检查自动评论
- 质量门禁（quality gate）

### 3.4 开发者体验

#### 扩展点 7：插件架构
**当前**：v0.1 Visitor 需要修改代码
**v1.0**：支持插件式扩展

**具体功能**：
- 独立的 Visitor 插件项目
- 插件发现和加载机制
- 插件版本管理

#### 扩展点 8：调试和诊断
**当前**：v0.1 基本错误信息
**v1.0**：高级调试支持

**具体功能**：
- 详细执行日志
- 性能分析工具
- 交互式调试模式

---

## 4. 实施优先级建议

### 4.1 v0.1 必须完成（P0）

1. **核心功能**：文档图构建、双向链接验证
2. **基本 Visitor**：术语表生成器、问题汇总器
3. **错误处理**：基本错误信息和退出码
4. **CLI 接口**：基本命令结构

### 4.2 v0.1 应该完成（P1）

5. **进度反馈**：处理大量文件时的用户体验
6. **自动维护**：创建缺失 frontmatter（极简版）
7. **基本测试**：核心功能测试覆盖

### 4.3 v0.1 可以省略（P2）

8. **高级错误信息**：三层建议结构
9. **双受众输出**：Human + Machine 格式
10. **完整测试套件**：所有边界情况覆盖

### 4.4 v1.0 规划

11. **配置系统**：Visitor 配置化
12. **正文分析**：基础链接提取
13. **增量扫描**：文件监听和缓存
14. **插件架构**：动态扩展支持

---

## 5. 依赖关系分析

### 5.1 技术依赖

| 组件 | 依赖项 | 版本 | 用途 |
|:-----|:-------|:-----|:-----|
| YAML 解析 | YamlDotNet | ≥13.0.0 | frontmatter 解析 |
| CLI 框架 | System.CommandLine | ≥2.0.0 | 命令行接口 |
| 测试框架 | xUnit | ≥2.5.0 | 单元测试 |
| JSON 序列化 | System.Text.Json | (内置) | 报告输出 |

### 5.2 文档依赖

| 文档 | 状态 | 用途 |
|:-----|:-----|:-----|
| scope.md | ✅ 完成 | 功能边界定义 |
| api.md | ✅ 草案 | 接口设计 |
| spec.md | ✅ 草案 | 实现规范 |
| README.md | ⏳ 待创建 | 用户指南 |

### 5.3 团队依赖

| 角色 | 任务 | 时间估计 |
|:-----|:-----|:---------|
| Implementer | 核心实现 | 3-4天 |
| QA | 测试验证 | 1-2天 |
| DocOps | 文档完善 | 0.5-1天 |

---

## 6. 下一步行动

### 6.1 立即行动（今天）

1. ✅ 完成畅谈会总结
2. ✅ 创建 api.md 草案
3. ✅ 创建 spec.md 草案
4. ✅ 创建 todo.md

### 6.2 短期行动（v0.1 实现）

5. 🔄 开始核心功能实现（DocumentGraphBuilder）
6. 🔄 实现基本 Visitor（GlossaryVisitor, IssueAggregator）
7. 🔄 创建 CLI 接口
8. 🔄 编写基本测试

### 6.3 中期行动（v0.1 完善）

9. ⏳ 完善错误处理（三层建议结构）
10. ⏳ 添加进度反馈
11. ⏳ 编写用户文档
12. ⏳ 性能优化和测试

### 6.4 长期行动（v1.0 规划）

13. ⏳ 设计配置系统
14. ⏳ 规划正文分析功能
15. ⏳ 设计插件架构
16. ⏳ 社区反馈收集

---

## 7. 变更记录

| 日期 | 作者 | 变更说明 |
|:-----|:-----|:---------|
| 2026-01-01 | 刘德智 | 创建初始待办事项清单 |

---

**使用说明**：本文档用于跟踪 v0.1 实施过程中的问题和决策，以及规划 v1.0 的扩展功能。随着项目进展，应及时更新本文档。