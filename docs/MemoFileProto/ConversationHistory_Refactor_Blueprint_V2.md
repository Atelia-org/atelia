# Memo: Conversation History æŠ½è±¡é‡æ„è“å›¾ Â· V2
*ç‰ˆæœ¬ï¼š0.2-draft Â· æ›´æ–°æ—¥æœŸï¼š2025-10-12*

> æœ¬æ–‡æ¡£ä¸“æ³¨äºâ€œConversation Historyâ€é‡æ„çš„ç›®æ ‡æ¶æ„ã€å·²äº¤ä»˜è®¾è®¡ä¸å¾…å®šè®¾è®¡ã€‚å®æ–½é˜¶æ®µå®‰æ’è¯·å‚é˜…ã€ŠMemo: Conversation History æŠ½è±¡é‡æ„å®æ–½è·¯çº¿å›¾ã€‹V2ã€‚

---

## ç›®å½•
- [Memo: Conversation History æŠ½è±¡é‡æ„è“å›¾ Â· V2](#memo-conversation-history-æŠ½è±¡é‡æ„è“å›¾--v2)
  - [ç›®å½•](#ç›®å½•)
  - [æ–‡æ¡£ç›®çš„ä¸é˜…è¯»æŒ‡å—](#æ–‡æ¡£ç›®çš„ä¸é˜…è¯»æŒ‡å—)
  - [è®¾è®¡çŠ¶æ€æ€»è§ˆ](#è®¾è®¡çŠ¶æ€æ€»è§ˆ)
  - [é—®é¢˜èƒŒæ™¯ä¸åŠ¨æœº](#é—®é¢˜èƒŒæ™¯ä¸åŠ¨æœº)
    - [èƒŒæ™¯æ¦‚è¿°](#èƒŒæ™¯æ¦‚è¿°)
    - [æ ¸å¿ƒç—›ç‚¹](#æ ¸å¿ƒç—›ç‚¹)
    - [é‡æ„ç›®æ ‡](#é‡æ„ç›®æ ‡)
    - [éç›®æ ‡ä¸çº¦æŸ](#éç›®æ ‡ä¸çº¦æŸ)
  - [ç›®æ ‡æ¶æ„ï¼ˆTarget Designï¼‰](#ç›®æ ‡æ¶æ„target-design)
    - [æ ¸å¿ƒåŸåˆ™](#æ ¸å¿ƒåŸåˆ™)
      - [è®¾è®¡ä¸å˜é‡](#è®¾è®¡ä¸å˜é‡)
    - [ç³»ç»Ÿæ„æˆæ‘˜è¦](#ç³»ç»Ÿæ„æˆæ‘˜è¦)
    - [ç³»ç»Ÿè¾¹ç•Œä¸å¤–éƒ¨ä¾èµ–](#ç³»ç»Ÿè¾¹ç•Œä¸å¤–éƒ¨ä¾èµ–)
    - [èƒ½åŠ›è¦†ç›–èŒƒå›´ä¸å½“å‰è¿›åº¦](#èƒ½åŠ›è¦†ç›–èŒƒå›´ä¸å½“å‰è¿›åº¦)
    - [ä¸ V1 è“å›¾çš„å·®å¼‚å¯¹ç…§](#ä¸-v1-è“å›¾çš„å·®å¼‚å¯¹ç…§)
    - [æ•°æ®ä¸äº¤äº’æµ](#æ•°æ®ä¸äº¤äº’æµ)
    - [History â†” Context â†” Provider åä½œ](#history--context--provider-åä½œ)
      - [LiveScreen å¤„ç†çº¦å®š](#livescreen-å¤„ç†çº¦å®š)
    - [ContextMessage å±‚æ¥å£è®¾è®¡ï¼ˆâœ…ï¼‰](#contextmessage-å±‚æ¥å£è®¾è®¡)
    - [Provider å®¢æˆ·ç«¯è®¾è®¡è¦ç‚¹ï¼ˆğŸ› ï¸ï¼‰](#provider-å®¢æˆ·ç«¯è®¾è®¡è¦ç‚¹ï¸)
      - [é€šç”¨å¥‘çº¦ï¼ˆâœ…ï¼‰](#é€šç”¨å¥‘çº¦)
      - [OpenAI å®¢æˆ·ç«¯è¦ç‚¹ï¼ˆğŸ› ï¸ï¼‰](#openai-å®¢æˆ·ç«¯è¦ç‚¹ï¸)
      - [Anthropic å®¢æˆ·ç«¯è¦ç‚¹ï¼ˆğŸ› ï¸ï¼‰](#anthropic-å®¢æˆ·ç«¯è¦ç‚¹ï¸)
      - [å…¶ä»–ä¾›åº”å•†ï¼ˆâ³ï¼‰](#å…¶ä»–ä¾›åº”å•†)
      - [ModelOutputDelta ç®¡çº¿ï¼ˆğŸ› ï¸ï¼‰](#modeloutputdelta-ç®¡çº¿ï¸)
    - [ç»„ä»¶è´£ä»»è¾¹ç•Œ](#ç»„ä»¶è´£ä»»è¾¹ç•Œ)
    - [è®¾è®¡æ¨¡å¼æ˜ å°„](#è®¾è®¡æ¨¡å¼æ˜ å°„)
      - [MVVM æ˜ å°„ï¼ˆâœ…ï¼‰](#mvvm-æ˜ å°„)
      - [Event Sourcing æ€ç»´ï¼ˆğŸ› ï¸ï¼‰](#event-sourcing-æ€ç»´ï¸)
      - [CQRS ä¸ Repositoryï¼ˆğŸ› ï¸ï¼‰](#cqrs-ä¸-repositoryï¸)
      - [Strategy + Adapterï¼ˆğŸ› ï¸ï¼‰](#strategy--adapterï¸)
      - [Decoratorï¼ˆâœ…ï¼‰](#decorator)
    - [AgentState ä¸ Widget èŒè´£ï¼ˆğŸ› ï¸ï¼‰](#agentstate-ä¸-widget-èŒè´£ï¸)
      - [Widget çº¦å®šï¼ˆğŸ› ï¸ï¼‰](#widget-çº¦å®šï¸)
      - [é¡ºåºä¸ç¨³å®šæ ‡è¯†ç­–ç•¥ï¼ˆâ³ï¼‰](#é¡ºåºä¸ç¨³å®šæ ‡è¯†ç­–ç•¥)
      - [AgentState ç›®æ ‡ API è½®å»“ï¼ˆğŸ› ï¸ï¼‰](#agentstate-ç›®æ ‡-api-è½®å»“ï¸)
        - [ç¤ºä¾‹ï¼šAgentState éª¨æ¶è‰å›¾ï¼ˆğŸ› ï¸ï¼‰](#ç¤ºä¾‹agentstate-éª¨æ¶è‰å›¾ï¸)
  - [å·²å®Œæˆè®¾è®¡ï¼ˆDelivered Scopeï¼‰](#å·²å®Œæˆè®¾è®¡delivered-scope)
    - [è½åœ°ç»„ä»¶ä¸€è§ˆ](#è½åœ°ç»„ä»¶ä¸€è§ˆ)
    - [æ¥å£å¥‘çº¦](#æ¥å£å¥‘çº¦)
      - [AgentState ä¸å†å²å†™å…¥](#agentstate-ä¸å†å²å†™å…¥)
      - [ContextMessage ä¸ Provider æ¶ˆè´¹](#contextmessage-ä¸-provider-æ¶ˆè´¹)
    - [å…³é”®ç±»å‹å®šä¹‰](#å…³é”®ç±»å‹å®šä¹‰)
    - [è®¾è®¡éªŒæ”¶å‡†åˆ™](#è®¾è®¡éªŒæ”¶å‡†åˆ™)
    - [å®ç°çº¦æŸä¸æ³¨æ„äº‹é¡¹](#å®ç°çº¦æŸä¸æ³¨æ„äº‹é¡¹)
  - [å¾…å®šè®¾è®¡ï¼ˆDeferred \& TBDï¼‰](#å¾…å®šè®¾è®¡deferred--tbd)
    - [å»¶åå¼•å…¥é¡¹](#å»¶åå¼•å…¥é¡¹)
    - [å¾…è¿›ä¸€æ­¥è°ƒç ”çš„é—®é¢˜](#å¾…è¿›ä¸€æ­¥è°ƒç ”çš„é—®é¢˜)
  - [ä¸å®æ–½è·¯çº¿å›¾çš„å…³ç³»](#ä¸å®æ–½è·¯çº¿å›¾çš„å…³ç³»)
  - [æœ¯è¯­ä¸å‚è€ƒèµ„æ–™](#æœ¯è¯­ä¸å‚è€ƒèµ„æ–™)
  - [é‡æ„è¿›åº¦è¿½è¸ª](#é‡æ„è¿›åº¦è¿½è¸ª)
    - [æœ¬è½®æ›´æ–°](#æœ¬è½®æ›´æ–°)
    - [æ—¢å¾€é‡Œç¨‹ç¢‘](#æ—¢å¾€é‡Œç¨‹ç¢‘)
    - [ä¸‹ä¸€æ­¥è®¡åˆ’](#ä¸‹ä¸€æ­¥è®¡åˆ’)

---

## æ–‡æ¡£ç›®çš„ä¸é˜…è¯»æŒ‡å—
- **å®šä½**ï¼šå®šä¹‰ Conversation History æ¨¡å—çš„é•¿æœŸæ¶æ„ä¸è®¾è®¡è¾¹ç•Œï¼Œä½œä¸ºå®ç°å›¢é˜Ÿçš„â€œè®¾è®¡çœŸç›¸æºâ€ï¼Œä¸è¦†ç›–å…·ä½“å®æ–½èŠ‚å¥ã€‚
- **è¯»è€…è§’è‰²**ï¼šAgent Orchestrator æ¶æ„å¸ˆã€Provider å®¢æˆ·ç«¯ä½œè€…ã€å·¥å…·/è®°å¿†å­ç³»ç»Ÿç»´æŠ¤è€…ä»¥åŠéœ€è¦ç†è§£å†å²æ¨¡å‹çš„åä½œè€…ã€‚
- **æ›´æ–°ç­–ç•¥**ï¼šè“å›¾ç‰ˆæœ¬å·ä¸æ—¥æœŸåœ¨æ¯è½®è®¾è®¡å†³è®®ç¡®è®¤åæ›´æ–°ï¼›è·¯çº¿å›¾å‘ç”Ÿé˜¶æ®µè°ƒæ•´æ—¶ï¼Œåº”åœ¨ 24 å°æ—¶å†…å›é“¾è‡³è“å›¾å¹¶åŒæ­¥çŠ¶æ€è¡¨ã€‚
- **ç¼–è¾‘çº¦å®š**ï¼š
  - è®¾è®¡çŠ¶æ€ç»Ÿä¸€ä½¿ç”¨ âœ…ï¼ˆå·²å®šç¨¿ï¼‰ã€ğŸ› ï¸ï¼ˆè¿‘æœŸäº¤ä»˜ï¼‰ã€â³ï¼ˆå»¶æœŸè¯„ä¼°ï¼‰ã€‚
  - æ–°å¢ç« èŠ‚éœ€æ›´æ–°ç›®å½•ä¸â€œè®¾è®¡çŠ¶æ€æ€»è§ˆâ€è¡¨ã€‚
  - ä¿æŒæœ¯è¯­ä¸ `Atelia_Naming_Convention.md` ä¸€è‡´ï¼›å¼•ç”¨å¤–éƒ¨æ–‡æ¡£æ—¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„ã€‚
- **å…³è”æ–‡æ¡£**ï¼š
  - ã€ŠConversation History æŠ½è±¡é‡æ„å®æ–½è·¯çº¿å›¾ã€‹V2ï¼ˆè¿›è¡Œä¸­ï¼‰
  - ã€ŠAgentState API è‰æ¡ˆã€‹ï¼ˆç­¹å¤‡ä¸­ï¼Œé¢„è®¡å¹¶å…¥è“å›¾é™„å½•ï¼‰
  - ã€ŠAtelia.Diagnostics.DebugUtil ç”¨æ³•è¯´æ˜ã€‹ï¼ˆ`AGENTS.md`ï¼‰

## è®¾è®¡çŠ¶æ€æ€»è§ˆ
> ä½¿ç”¨ âœ…ï¼ˆå·²å®Œæˆï¼‰ã€ğŸ› ï¸ï¼ˆå¼€å‘ä¸­/è¿‘æœŸè®¡åˆ’ï¼‰ã€â³ï¼ˆå»¶åè¯„ä¼°ï¼‰æ ‡è®°è®¾è®¡çŠ¶æ€ã€‚

| è®¾è®¡ä¸»é¢˜ | çŠ¶æ€ | ç®€è¿° | è¯¦ç»†ç« èŠ‚ |
| --- | --- | --- | --- |
| AgentState å†å²å±‚æŠ½è±¡ | âœ… | HistoryEntry åˆ†å±‚ã€è¿½åŠ å¼ AgentState åŠå…¶å•å‘æ•°æ®æµå·²å®šç¨¿ï¼Œè¯­ä¹‰åŒ–è¿½åŠ  API å·²å…¨é¢å®ç°å¹¶é€šè¿‡æµ‹è¯•ã€‚ | [ç›®æ ‡æ¶æ„ï¼ˆTarget Designï¼‰](#ç›®æ ‡æ¶æ„target-design) |
| ContextMessage æ¥å£æŸ | âœ… | åŸºç¡€æ¥å£ã€è§’è‰²åŒ–æ´¾ç”Ÿä¸ mix-in èƒ½åŠ›å·²å®šç¨¿ï¼Œå¹¶ä¸ HistoryEntry æŠ½è±¡ä¿æŒä¸€è‡´ã€‚ | [ContextMessage å±‚æ¥å£è®¾è®¡ï¼ˆâœ…ï¼‰](#contextmessage-å±‚æ¥å£è®¾è®¡) |
| Context æ¸²æŸ“/æŠ•å½± | âœ… | RenderLiveContext æµç¨‹ä¸ LiveScreen è£…é¥°ç­–ç•¥å·²å®ç°å¹¶éªŒè¯ï¼Œæ”¯æŒ Memory Notebook åŠ¨æ€æ³¨å…¥ã€‚ | [æ•°æ®ä¸äº¤äº’æµ](#æ•°æ®ä¸äº¤äº’æµ) |
| Provider æŠ½è±¡ä¸è·¯ç”± | âœ… | IProviderClientã€ModelOutputDelta ç®¡çº¿ä¸ ProviderRouter å·²è½åœ°ï¼ŒStub Provider å®Œæ•´éªŒè¯æµå¼è°ƒç”¨é—­ç¯ã€‚ | [ç›®æ ‡æ¶æ„ï¼ˆTarget Designï¼‰](#ç›®æ ‡æ¶æ„target-design) |
| AgentState è¯­ä¹‰åŒ–è¿½åŠ  API | âœ… | `AppendModelInput/Output/ToolResults` ç­‰é¢†åŸŸæ–¹æ³•å·²å®ç°ï¼Œæ›¿ä»£ä¸´æ—¶ `AppendHistory`ï¼Œå¹¶é›†æˆæ—¶é—´æˆ³æ³¨å…¥ä¸ DebugUtil æ‰“ç‚¹ã€‚ | [AgentState ä¸ Widget èŒè´£](#agentstate-ä¸-widget-èŒè´£ï¸) |
| Widget ä½“ç³»ä¸é™„åŠ èƒ½åŠ› | ğŸ› ï¸ | MemoryNotebookWidget ä¸ Widget å·¥å…·æ¸…å•å·²æŠ•å…¥ä½¿ç”¨ï¼ŒLiveScreen è£…é¥°æ•´åˆå®Œæ¯•ï¼›é™„ä»¶ä½“ç³»ã€Notebook äº‹ä»¶åŒ–ã€åŠ¨æ€å·¥å…· manifest ç­‰å»¶åè‡³é˜¶æ®µ 4+ã€‚ | [å¾…å®šè®¾è®¡ï¼ˆDeferred & TBDï¼‰](#å¾…å®šè®¾è®¡deferred--tbd) |
| è¯Šæ–­ä¸å…ƒæ•°æ®ç­–ç•¥ | ğŸ› ï¸ | DebugUtil é›†æˆä¸ TokenUsage åˆæ­¥æ”¯æŒå·²å®Œæˆï¼Œæ·±åº¦é¥æµ‹æ–¹æ¡ˆï¼ˆè®¡è´¹ã€ç¼“å­˜å‘½ä¸­ï¼‰å°šæœªå®šç¨¿ã€‚ | [å¾…å®šè®¾è®¡ï¼ˆDeferred & TBDï¼‰](#å¾…å®šè®¾è®¡deferred--tbd) |

çŠ¶æ€æ ‡ç­¾é‡Šä¹‰ï¼š
- âœ… è¡¨ç¤ºè®¾è®¡ä¸çº¦æŸå·²å†»ç»“ï¼Œå¯ç›´æ¥ä½œä¸ºå®ç°åŸºå‡†ã€‚
- ğŸ› ï¸ è¡¨ç¤ºçŸ­æœŸå†…è¦äº¤ä»˜çš„ä¸»é¢˜ï¼Œä»å…è®¸åœ¨å®ç°è¿‡ç¨‹ä¸­å¾®è°ƒç»†èŠ‚ã€‚
- â³ è¡¨ç¤ºæš‚ç¼“æˆ–ä¾èµ–å¤–éƒ¨å†³ç­–ï¼Œä¿ç•™åœ¨è“å›¾ä¸­ä»¥å…ä¸¢å¤±ä¸Šä¸‹æ–‡ã€‚

## é—®é¢˜èƒŒæ™¯ä¸åŠ¨æœº
### èƒŒæ™¯æ¦‚è¿°
MemoFileProto åœ¨æ—©æœŸç›´æ¥æ²¿ç”¨ OpenAI Chat Completion çš„æ¶ˆæ¯ç»“æ„ä½œä¸ºå†…éƒ¨å¯¹è¯å†å²ã€‚åœ¨åªæ¥å…¥å•ä¸€æ¨¡å‹æ—¶å®ç°ç®€å•ï¼Œä½†ä¸€æ—¦ä¼šè¯éœ€è¦æ··åˆ Claudeã€OpenAI æˆ–æœ¬åœ°æ¨¡å‹ï¼Œå†å²è®°å½•ä¸ä¾›åº”å•†åè®®çš„å¼ºè€¦åˆç«‹å³æš´éœ²å‡ºæ‰©å±•æ€§ç“¶é¢ˆã€‚

### æ ¸å¿ƒç—›ç‚¹
| ç—›ç‚¹ | ç°è±¡ | åæœ |
| --- | --- | --- |
| æ‰¹é‡å·¥å…·è°ƒç”¨ç ´åæ¶ˆæ¯äº¤é”™ | Claude æœŸæœ›ä¸€æ¬¡ Tool è°ƒç”¨â†’ä¸€æ¬¡ Tool å“åº”ï¼Œè€Œæˆ‘ä»¬è¿”å›å¤šæ¡ `tool` æ¶ˆæ¯ | Claude ç«¯è§£æå¤±è´¥æˆ–å¯¼è‡´ä¸Šä¸‹æ–‡é”™ä¹± |
| å†å²æ¶ˆæ¯ç¼ºä¹ç»“æ„ | æ‰€æœ‰æ¶ˆæ¯éƒ½ä»…æœ‰ `role + content` | éš¾ä»¥é™„åŠ  `ToolCallId`ã€æ‰§è¡ŒçŠ¶æ€ã€ç¯å¢ƒä¿¡æ¯ç­‰å…ƒæ•°æ® |
| å†å²ä¸è¯·æ±‚è€¦åˆ | `_conversationHistory` å·²ç­‰åŒäº OpenAI æ¶ˆæ¯æ ¼å¼ | æ–°å¢ä¾›åº”å•†æ—¶éœ€æ”¹éå…¨é“¾è·¯ |
| ç¼ºå°‘ç»Ÿä¸€ä»“å‚¨ | è°ƒç”¨æ ˆã€è°ƒè¯•ã€è®°å¿†æ³¨å…¥æ•£è½åœ¨å¤šä¸ªæ–¹æ³• | éš¾ä»¥è¿½è¸ªå¹¶å¤ç”¨ |

### é‡æ„ç›®æ ‡
1. å¼•å…¥å¼ºç±»å‹ `HistoryEntry` åˆ†å±‚ï¼Œè®©ä¸åŒäº‹ä»¶æ‹¥æœ‰æ¸…æ™°æ•°æ®æ¨¡å‹ï¼Œå¹¶ç”±è¿½åŠ å¼ AgentState ç»Ÿä¸€æŒæœ‰ã€‚
2. è§£è€¦å†å²å­˜å‚¨ä¸ä¾›åº”å•†è°ƒç”¨ï¼ŒProvider å®¢æˆ·ç«¯åªæ¶ˆè´¹ AgentState æ¸²æŸ“å‡ºçš„ä¸Šä¸‹æ–‡è§†å›¾ã€‚
3. æ”¯æ’‘å•ä¼šè¯æ··åˆå¤šç§æ¨¡å‹/æ¥å£ï¼ˆå¦‚ Claude è§„åˆ’ + OpenAI æ‰§è¡Œï¼‰ï¼ŒåŒæ—¶ä¿æŒä¸€è‡´çš„å†å²è§†å›¾ã€‚
4. ä¸º Live Contextã€å·¥å…·é¥æµ‹ã€è®°å¿†ç³»ç»Ÿç­‰èƒ½åŠ›æ‰“å¥½åŸºç¡€ï¼Œå¹¶ç»´æŒåŸå‹é˜¶æ®µçš„å®ç°ç®€æ´åº¦ã€‚

### éç›®æ ‡ä¸çº¦æŸ
- **éç›®æ ‡**ï¼š
  - ä¸åœ¨å½“å‰é‡æ„ä¸­å®ç°æŒä¹…åŒ–ä»“å‚¨ã€å†å²å›æ”¾æˆ– StableId â€”â€” æŒ‰ç…§å»¶åè®¡åˆ’ï¼Œç›¸å…³åŠŸèƒ½å°†åœ¨äº‹ä»¶å­˜å‚¨æ–¹æ¡ˆæ•²å®šåå¦è¡Œè®¾è®¡ã€‚
  - ä¸æä¾›é¢å‘ç»ˆç«¯ç”¨æˆ·çš„æ—¶é—´çº¿ UI æˆ–å¯è§†åŒ–å·¥å…·ï¼Œæœ¬è“å›¾åªæè¿°é¢†åŸŸæ¨¡å‹å’Œç¼–ç¨‹æ¥å£ã€‚
  - ä¸å°è¯•ç»Ÿä¸€å¤–éƒ¨å·¥å…·/Planner çš„è¯­ä¹‰æ¨¡å‹ï¼Œå·¥å…·å£°æ˜ä¸æ‰§è¡Œç­–ç•¥ä»ç”±ä¸Šå±‚ orchestrator å†³ç­–ã€‚
  - ä¸ä¸ºæ¯å®¶ Provider å®šåˆ¶ prompt engineering çš„æœ€ä½³å®è·µï¼Œè“å›¾ä»…å®šä¹‰æœ€å°å…¬çº¦æ•°æ¥å£ã€‚
- **çº¦æŸ**ï¼š
  - å‡å®š AgentState ä»è¿è¡Œåœ¨å•çº¿ç¨‹ orchestrator å†…éƒ¨ï¼Œå†å²è¿½åŠ æ— éœ€å†…éƒ¨é”ï¼›å¤šçº¿ç¨‹è®¿é—®éœ€ç”±è°ƒç”¨æ–¹è´Ÿè´£åŒæ­¥ã€‚
  -  Diagnostic è¾“å‡ºç»Ÿä¸€ä¾èµ– `DebugUtil`ï¼Œä»¥ä¾¿åœ¨ä¸åŒé˜¶æ®µé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶æ‰“å°ç±»åˆ«ã€‚
  -  æ‰€æœ‰ Metadata é”®å€¼éœ€éµå¾ªè½»é‡åŒ–çº¦æŸï¼ˆ<2 KBï¼‰ï¼Œå¤§å‹æ•°æ®å¿…é¡»è½¬ä¸ºé™„ä»¶æˆ–ä¸“é—¨æ¡ç›®ï¼Œé¿å…ç ´åæŒä¹…åŒ–å…¼å®¹æ€§ã€‚
  -  ç»§ç»­æ²¿ç”¨åŸå‹ç¯å¢ƒçš„ä¾èµ–æ¡ä»¶ï¼šä¸å¼•å…¥å¤–éƒ¨æ•°æ®åº“ï¼Œä¸è¦æ±‚è·¨ä¼šè¯è¿ç§»ï¼Œä¿æŒæœ€å°éƒ¨ç½²åŠå¾„ã€‚
## ç›®æ ‡æ¶æ„ï¼ˆTarget Designï¼‰
### æ ¸å¿ƒåŸåˆ™
- **ä¾›åº”å•†æ— å…³æ€§**ï¼šæ‰€æœ‰é¢†åŸŸæ¨¡å‹å›´ç»• `HistoryEntry` ä¸ `IContextMessage` å®šä¹‰ï¼Œä¸æš´éœ²ä»»ä½•å‚å•†ç‰¹å®šå­—æ®µï¼Œä¾¿äºåœ¨åŒä¸€ä¼šè¯å†…åˆ‡æ¢æˆ–å¹¶è¡Œå¤šä¸ª Providerã€‚
- **å•ä¸€äº‹å®æº**ï¼šAgentState ä»¥è¿½åŠ å¼ HistoryEntry ä¿å­˜å…¨éƒ¨å†å²ï¼ŒWidget ä½œä¸ºå—æ§çš„è¿è¡Œæ—¶ç»„ä»¶å°è£…çŠ¶æ€ã€å·¥å…·ä¸å‘ˆç°ï¼ŒçŠ¶æ€å¯ç”± AgentState é‡å»ºã€‚
- **åˆ†å±‚è§£è€¦**ï¼šHistory â†” Context â†” Provider ä¹‹é—´åªé€šè¿‡æ¥å£äº¤äº’ï¼Œç¦æ­¢è·¨å±‚ä¾èµ–å…·ä½“å®ç°ï¼Œç¡®ä¿å¤šä¾›åº”å•†å¹¶å­˜ã€‚
- **æ¸è¿›æ‰©å±•**ï¼šé»˜è®¤æä¾›æœ€å°å¯è¡Œæ¨¡å‹ï¼ˆæ–‡æœ¬ + å·¥å…·è°ƒç”¨ï¼‰ï¼Œé™„åŠ èƒ½åŠ›ï¼ˆLiveScreenã€é™„ä»¶ã€TokenUsageï¼‰é€šè¿‡å¯é€‰æ¥å£æ‰©å±•ã€‚
- **å›æ”¾å‹å¥½**ï¼šæ‰€æœ‰æ—¶é—´æˆ³ç”± AgentState æ³¨å…¥ï¼Œåç»­è‹¥æ¥å…¥æŒä¹…åŒ–æˆ–äº‹ä»¶å›æ”¾ï¼Œæ— éœ€ä¿®æ”¹ Provider å±‚åè®®ã€‚

#### è®¾è®¡ä¸å˜é‡
- **History ä¸å¯é€†**ï¼šå†™å…¥è·¯å¾„ç»Ÿä¸€é€šè¿‡ AgentState çš„è¯­ä¹‰åŒ– APIï¼Œç¦æ­¢ç›´æ¥ä¿®æ”¹ `_history` é›†åˆï¼›ä»»ä½•çƒ­ä¿®æˆ–è°ƒè¯•è„šæœ¬éƒ½å¿…é¡»é€šè¿‡è¿½åŠ æ–°æ¡ç›®å®Œæˆã€‚
- **ä¸Šä¸‹æ–‡çº¯è¯»**ï¼š`RenderLiveContext()` å¿…é¡»ä¿æŒçº¯å‡½æ•°ç‰¹æ€§ï¼Œä¸å¾—ç¼“å­˜è·¨è°ƒç”¨çŠ¶æ€æˆ–ä¿®æ”¹å†å²æ¡ç›®ï¼Œä¾¿äºåœ¨è¯Šæ–­å’Œå›æ”¾ä¸­å¤ç°ç›¸åŒç»“æœã€‚
- **Provider åªè¯»æ¶ˆè´¹**ï¼š`IProviderClient` è§†å›¾ä»¥ä¸å¯å˜ `IContextMessage` é›†åˆä¼ å…¥ï¼Œå®¢æˆ·ç«¯ä¸å¾—æ›´æ”¹æ¶ˆæ¯å†…å®¹æˆ– Metadataï¼Œæ–°å¢ä¿¡æ¯éœ€é€šè¿‡å›å†™æ–°æ¡ç›®è¡¨è¾¾ã€‚
- **è£…é¥°å™¨é€æ˜æ€§**ï¼šLiveScreen ç­‰è£…é¥°å¿…é¡»ç»´æŒ `InnerMessage` çš„æ¥å£èƒ½åŠ›ï¼Œä»»ä½•æ¶ˆè´¹æ–¹éƒ½éœ€ä»¥â€œå…ˆè§£åŒ…ã€å†åˆ¤æ–­è§’è‰²â€çš„æ¨¡å¼å¤„ç†ï¼Œç¡®ä¿ä¸Šä¸‹æ¸¸åä½œç¨³å®šã€‚
### ç³»ç»Ÿæ„æˆæ‘˜è¦
Conversation History çš„ç›®æ ‡æ¶æ„å»¶ç»­ v1 æ–‡æ¡£çš„â€œä¸‰æ®µå¼æµæ°´çº¿â€ï¼Œä½†å°†æ¯ä¸€å±‚çš„å¥‘çº¦é‡æ–°æ¢³ç†ä¸ºç¨³å®šçš„æ¥å£é›†åˆï¼š
- **AgentState**ï¼šè´Ÿè´£å†å²æŒä¹…ä¸ Widget å®¿ä¸»ç®¡ç†ï¼Œæš´éœ²è¿½åŠ å¼ APIï¼ˆ`AppendModelInput`ã€`AppendModelOutput` ç­‰ï¼‰ä»¥åŠä¸Šä¸‹æ–‡æ¸²æŸ“å…¥å£ã€‚æ‰€æœ‰å¯è¿½æº¯äº‹ä»¶éƒ½ä»¥ `HistoryEntry` å½¢å¼è½ç›˜ï¼›ç³»ç»ŸæŒ‡ä»¤ç”±å®¿ä¸»å­—æ®µç»´æŠ¤ï¼Œè€Œ Notebook ç­‰è¿è¡Œæ€è§†å›¾åˆ™é€šè¿‡ Widgetï¼ˆå¦‚ `MemoryNotebookWidget`ï¼‰å°è£…å¹¶å¯åœ¨å¿…è¦æ—¶é‡æ”¾é‡å»ºã€‚
- **Context Projection**ï¼š`RenderLiveContext()` è¯»å– AgentStateï¼Œå¹¶æŒ‰è°ƒç”¨éœ€æ±‚ç”Ÿæˆ `IContextMessage` åºåˆ—ï¼Œå¯é€šè¿‡è£…é¥°å™¨ä¸´æ—¶æ³¨å…¥ LiveScreenã€‚è¯¥å±‚å¯¹å¤–è¡¨ç°ä¸ºçº¯å‡½æ•°ï¼Œä¸äº§ç”Ÿå‰¯ä½œç”¨ã€‚
- **Provider Router**ï¼šæ ¹æ®ç­–ç•¥é€‰æ‹©å…·ä½“ `IProviderClient` å®ç°ï¼Œå¹¶åœ¨ delta æ±‡æ€»åå›å†™æ ‡å‡†åŒ–çš„ `ModelOutputEntry` / `ToolResultsEntry`ã€‚è·¯ç”±é€»è¾‘å¯ä»¥ä¾æ®æ¨¡å‹å®¶æ—ã€ä»»åŠ¡é˜¶æ®µæˆ–ç­–ç•¥æ ‡ç­¾æ‰©å±•ã€‚
- **Provider Clients**ï¼šå¯¹æ¥ OpenAIã€Anthropic ç­‰åº•å±‚ SDKï¼Œå°†é€šç”¨ä¸Šä¸‹æ–‡è½¬æ¢ä¸ºå‚å•†åè®®ï¼Œå¹¶è§£æå¢é‡æµã€‚æ‰€æœ‰è§£æå‡ºçš„å·¥å…·è°ƒç”¨ä»¥ç»Ÿä¸€çš„ `ToolCallRequest` è¡¨è¾¾ã€‚
- **Orchestrator Feedback Loop**ï¼šLlmAgent æˆ–æ›´é«˜å±‚ orchestrator èšåˆ Provider å›ä¼ ç»“æœï¼Œè°ƒç”¨ AgentState è¿½åŠ æ–°çš„å†å²æ¡ç›®ï¼Œå½¢æˆç¨³å®šçš„â€œè¯»å– â†’ æ¨ç† â†’ å›å†™â€å¾ªç¯ã€‚

### ç³»ç»Ÿè¾¹ç•Œä¸å¤–éƒ¨ä¾èµ–
- **ä¸Šæ¸¸åä½œè€…**ï¼šConversation History ç”± Orchestratorï¼ˆå½“å‰ä¸º `MemoFileProto.Agent.LlmAgent`ï¼‰é©±åŠ¨ï¼›Plannerã€ä»»åŠ¡åˆ†è§£å™¨ä¸å·¥å…·æ‰§è¡Œå™¨åªé€šè¿‡ AgentState çš„è¯­ä¹‰åŒ–æ–¹æ³•äº¤äº’ï¼Œä¸å¾—ç›´æ¥è®¿é—® `_history` é›†åˆã€‚
- **ä¸‹æ¸¸ä¾èµ–**ï¼šæ‰€æœ‰æ¨¡å‹è°ƒç”¨éƒ½ç»ç”± `ProviderRouter` è½¬å‘è‡³å„ `IProviderClient` å®ç°ï¼›Provider è´Ÿè´£åè®®é€‚é…ä¸å·¥å…·è°ƒç”¨è§£æï¼Œä½†æ— æƒå›å†™ AgentStateã€‚è‹¥æœªæ¥å¼•å…¥ç¼“å­˜/è®¡è´¹ç³»ç»Ÿï¼Œåº”é€šè¿‡ ProviderRouter çš„å¢é‡äº‹ä»¶æ•è·æ¥å£è·å–ä¿¡æ¯ã€‚
- **æ¨ªå‘ç»„ä»¶**ï¼šè®°å¿†ç³»ç»Ÿã€Live Context ä»¥åŠæœªæ¥çš„å¯¹è¯å¯è§†åŒ–å·¥å…·éœ€æ¶ˆè´¹ `IContextMessage` åˆ—è¡¨æˆ– `HistoryEntry` åªè¯»è§†å›¾ï¼Œä¸å†ä¾èµ–æ—§ç‰ˆ `_conversationHistory`ã€‚ä»»ä½•å®æ—¶ç›‘æ§åº”é€šè¿‡ DebugUtil æˆ– Metadata è®¢é˜…ã€‚
- **å¤–éƒ¨çº¦æŸ**ï¼šå½“å‰é˜¶æ®µä¾èµ– .NET è¿è¡Œæ—¶ã€OpenAI/Anthropic SDK ä¸ Atelia çš„å†…éƒ¨å·¥å…·åº“ï¼ˆDebugUtilã€å‘½åè§„èŒƒçº¦æŸï¼‰ï¼›æœªå¼•å…¥æ•°æ®åº“æˆ– KV å­˜å‚¨ã€‚è‹¥éƒ¨ç½²ç¯å¢ƒç¼ºä¹ç¨³å®šç£ç›˜ï¼ŒLiveScreen ä¸æ—¥å¿—é»˜è®¤è½åœ¨ `.codecortex/ldebug-logs`ã€‚
- **å…¼å®¹æ€§ç­–ç•¥**ï¼šè“å›¾é»˜è®¤ä¸ Phase 1 åŒå†™æ—¶æœŸçš„ä»£ç å…±å­˜ï¼Œè¦æ±‚è°ƒç”¨æ–¹åœ¨è¿ç§»æœŸé—´åŒæ—¶ç»´æŠ¤æ—§ç»“æ„ï¼›å½“è·¯çº¿å›¾å®£å‘Š Phase 4 ä¹‹åï¼Œå¯åˆ é™¤ `_conversationHistory` å¹¶å°†å†å²è¯»å–æ”¹ä¸ºä»…ä¾èµ– AgentStateã€‚

### èƒ½åŠ›è¦†ç›–èŒƒå›´ä¸å½“å‰è¿›åº¦
| èƒ½åŠ› | æœ€ç»ˆç›®æ ‡ | å·²äº¤ä»˜å†…å®¹ | å°šéœ€å·¥ä½œ |
| --- | --- | --- | --- |
| å†å²äº‹ä»¶æ¨¡å‹ | ä½¿ç”¨åˆ†å±‚ `HistoryEntry` è¡¨è¾¾æ‰€æœ‰å¯è¿½æº¯äº‹ä»¶ï¼Œå¹¶æ”¯æŒå›æ”¾å’Œæ‰©å±• | è®°å½•ç±»å‹ã€Metadata çº¦å®šåŠè¿½åŠ å¼ AgentState å·²å®Œæˆï¼Œæ­£åœ¨åŒå†™é˜¶æ®µéªŒè¯ | å¼•å…¥åºåˆ—å·/StableId åŠå›æ”¾ç­–ç•¥ï¼Œç»‘å®šæŒä¹…åŒ–æ–¹æ¡ˆ |
| ä¸Šä¸‹æ–‡æ¸²æŸ“ç®¡çº¿ | ä»¥ `RenderLiveContext()` å°†å†å²ä¸ Widget æ¸²æŸ“çš„ LiveScreen è½¬æ¢ä¸ºä¾›åº”å•†æ— å…³ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒ Token è£å‰ª | åŸºç¡€æ¸²æŸ“æµç¨‹ä¸ LiveScreen è£…é¥°ç­–ç•¥å·²å°±ç»ª | Token é¢„ç®—é©±åŠ¨çš„è£å‰ªã€è·¨ Provider å…¼å®¹æ€§éªŒæ”¶ã€Widget çŠ¶æ€è‡ªåŠ¨è®°è´¦ |
| Provider æŠ½è±¡å±‚ | é€šè¿‡ `IProviderClient` + `ProviderRouter` ç»Ÿä¸€è°ƒåº¦å¤šå®¶æ¨¡å‹ï¼Œå¹¶å½’å¹¶ `ModelOutputDelta` | å¥‘çº¦ã€delta æ›´åä¸ OpenAI/Anthropic é€‚é…ç­–ç•¥å·²å®šç¨¿ | å®ç° Routerã€èšåˆå·¥å…·è°ƒç”¨è¯Šæ–­ã€å®Œå–„æ··åˆä¼šè¯æµ‹è¯• |
| Widget ç”Ÿæ€ä¸è¾…åŠ©èƒ½åŠ› | å°† Memory Notebookã€å·¥å…·æ¸…å•ã€é™„ä»¶ç­‰çº³å…¥ç»Ÿä¸€ Widget/Attachment ä½“ç³» | LiveScreen è£…é¥°å™¨ã€åŸºç¡€ Notebook Widget åŒ–æ–¹æ¡ˆå·²ç»çº³å…¥æ¸²æŸ“æµç¨‹ | å®šä¹‰é™„ä»¶åè®®ã€Notebook äº‹ä»¶æ¡ç›®åŒ–ã€åŠ¨æ€å·¥å…· manifest æ³¨å…¥ |

### ä¸ V1 è“å›¾çš„å·®å¼‚å¯¹ç…§
| ä¸»é¢˜ | V1 è“å›¾ä¾§é‡ | V2 è°ƒæ•´ | çŠ¶æ€å½±å“ |
| --- | --- | --- | --- |
| æ–‡æ¡£èŒè´£ | è®¾è®¡è¦ç‚¹ä¸é˜¶æ®µè®¡åˆ’æ··æ‚ï¼ŒåŒä¸€ç« èŠ‚å…¼é¡¾ç›®æ ‡ä¸èŠ‚å¥ | æ˜ç¡®æŠŠè·¯çº¿è§„åˆ’è¿å‡ºï¼Œè“å›¾ä»…ä¿ç•™ç›®æ ‡ã€å·²äº¤ä»˜ä¸å¾…å®šè®¾è®¡ | âœ… è“å›¾æˆä¸ºé•¿æœŸçš„â€œå•ä¸€çœŸç›¸æºâ€ï¼Œè·¯çº¿èŠ‚å¥åœ¨ Roadmap ä¸­ç»´æŠ¤ |
| çŠ¶æ€æ ‡è¯† | é€šè¿‡æ–‡å­—æ®µè½éšå«è¿›åº¦ | æ–°å¢çŠ¶æ€è¡¨ä¸ç« èŠ‚æ ‡ç­¾ï¼ˆâœ…/ğŸ› ï¸/â³ï¼‰ | âœ… æ–¹ä¾¿å¿«é€ŸæŒæ¡è¾¹ç•Œï¼Œä¹Ÿä¾¿äºä¾‹ä¼šåŒæ­¥ä¸æ’æœŸè®¨è®º |
| Provider æŠ½è±¡ | ç€é‡æè¿° OpenAI/Anthropic å·®å¼‚ï¼Œç¼ºä¹ç»Ÿä¸€éªŒæ”¶å£å¾„ | å¼•å…¥ `IProviderClient` å¥‘çº¦ã€ModelOutputDelta èšåˆåŠè¯Šæ–­å­—æ®µ | ğŸ› ï¸ ç›´æ¥é©±åŠ¨ Phase 2-3 çš„ä»£ç æ”¹é€ ä¸æµ‹è¯•è¦æ±‚ |
| Widget ä½“ç³» | Notebook/ç³»ç»ŸæŒ‡ä»¤æ•£è½åœ¨æ®µè½æè¿°ä¸­ | å°† Widget çº¦å®šã€è£…é¥°ç­–ç•¥åŠå»¶åäº‹é¡¹æ‹†åˆ†æˆç‹¬ç«‹å°èŠ‚ | ğŸ› ï¸ æ˜ç¡® Phase 4 çš„å‰ç½®æ¡ä»¶ï¼Œé™ä½å®ç°æ­§ä¹‰ |
| éªŒæ”¶è§†è§’ | ç¼ºå°‘é¢å‘è½åœ°çš„å®Œæˆå®šä¹‰ | æ–°å¢â€œè®¾è®¡éªŒæ”¶å‡†åˆ™â€ç« èŠ‚ï¼Œåˆ—å‡ºåˆ¤å®šæ ‡å‡† | ğŸ› ï¸ æµ‹è¯•ä¸ä»£ç è¯„å®¡å¯æ®æ­¤å»ºç«‹æ ¸å¯¹æ¸…å• |
| å†å² vs. ä¸Šä¸‹æ–‡ | å¼ºè°ƒå•å‘æ•°æ®æµä½†æœªç»†åŒ–æ“ä½œçº¦æŸ | å›ºåŒ–â€œå†å²åªè¿½åŠ ã€ä¸Šä¸‹æ–‡çº¯è¯»ã€Provider åªè¯»æ¶ˆè´¹â€ç­‰ä¸å˜é‡ | âœ… å½“å‰åŒå†™é˜¶æ®µçš„å”¯ä¸€æ“ä½œå‡†åˆ™ |
### æ•°æ®ä¸äº¤äº’æµ
- å‚è€ƒæ€»è§ˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agent Orchestrator  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ append events
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1] AgentState         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ RenderLiveContext()
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2] Context Projection â”‚
â”‚ (IContextMessage list) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ CallModelAsync()
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [3] Provider Router    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚
 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
 â”‚OpenAI   â”‚ â”‚Anthropicâ”‚ â€¦
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â–²         â–²
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€ model deltas & tool results
        â”‚
        â–¼ aggregate & append
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Orchestrator feedback â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ AgentState (new history entries)
```

- **1. å†å²è¯»å–**ï¼šOrchestrator è§¦å‘æ¨¡å‹è°ƒç”¨æ—¶ï¼Œè¯·æ±‚ AgentState ç”Ÿæˆä¸Šä¸‹æ–‡ï¼›AgentState åå‘éå† HistoryEntryï¼Œç­›é€‰å®ç° `IContextMessage` çš„æ¡ç›®å¹¶æ‰§è¡Œå¿…è¦çš„ LiveScreen è£…é¥°ã€‚è¯¥æ­¥éª¤ä¿ç•™æ—¶é—´æˆ³ä¸ Metadataï¼Œé¿å…é‡å¤æ„é€ ã€‚
- **2. ä¸Šä¸‹æ–‡æ¸²æŸ“**ï¼šæ¸²æŸ“ç»“æœå§‹ç»ˆåŒ…å«å½“å‰ç³»ç»ŸæŒ‡ä»¤ (`ISystemMessage`)ï¼Œä»¥åŠæœ€è¿‘ç›¸å…³çš„è¾“å…¥ã€è¾“å‡ºã€å·¥å…·ç»“æœï¼›RenderLiveContext ä¸ä¿®æ”¹å†å²ï¼Œä»…è¿”å›å¿«ç…§ã€‚å¦‚æœ‰è®°å¿† Notebookï¼Œå¯é€šè¿‡ LiveScreen è£…é¥°é™„ç€åœ¨æœ€æ–°çš„è¾“å…¥/å·¥å…·æ¡ç›®ä¸Šã€‚
- **3. Provider è°ƒç”¨**ï¼šProviderRouter å°† `IReadOnlyList<IContextMessage>` è½¬æ¢ä¸ºå‚å•†æ¶ˆæ¯ç»“æ„ï¼Œè°ƒç”¨ `IProviderClient.CallModelAsync()` å¹¶è·å¾— `ModelOutputDelta` æµï¼›æ‰€æœ‰ä¾›åº”å•†å¿…é¡»éµå¾ªåŒä¸€ `CancellationToken`ã€æµå¼å¢é‡åè®®ã€‚
- **4. å¢é‡è§£æ**ï¼šProviderClient èšåˆæ–‡æœ¬ã€å·¥å…·è°ƒç”¨ç‰‡æ®µï¼Œç”Ÿæˆæ ‡å‡†åŒ–çš„ `ModelOutputEntry` ä¸ `ToolResultsEntry` å€™é€‰ï¼ŒåŒæ—¶è®°å½• `ModelInvocationDescriptor`ã€‚å·¥å…·å‚æ•°è§£æå¤±è´¥æ—¶éœ€ä¿ç•™åŸå§‹å­—ç¬¦ä¸²å¹¶å›å¡« `ParseError`ã€‚
- **5. å†å²å›å†™**ï¼šOrchestrator åœ¨æ¨ç†ç»“æŸåè°ƒç”¨ AgentState è¿½åŠ æ¨¡å‹è¾“å‡ºå’Œå·¥å…·ç»“æœï¼Œå®ç°â€œè¯»å– â†’ æ¨ç† â†’ å›å†™â€çš„é—­ç¯ã€‚è¿½åŠ æ–¹æ³•è´Ÿè´£æ³¨å…¥æœ€ç»ˆæ—¶é—´æˆ³å¹¶è§¦å‘ DebugUtil è®°å½•ã€‚
- **6. åé¦ˆä¸è°ƒè¯•**ï¼šè‹¥ Provider æä¾› TokenUsage æˆ–è°ƒè¯•å…ƒæ•°æ®ï¼Œå¯åœ¨å›å†™å‰é€šè¿‡ `Metadata` æˆ– mix-in æ¥å£è¡¥å……ï¼Œç¡®ä¿è¯Šæ–­ä¿¡æ¯ä¼´éšå†å²æ¡ç›®å­˜æ¡£ã€‚
- æœªæ¥ä¼šåœ¨æœ¬èŠ‚è¡¥å……æ¶æ„å›¾ï¼š`![Conversation History æµç¨‹å›¾è‰æ¡ˆ](./media/conversation-history-v2.png)`ï¼ˆå¾…ç»˜åˆ¶ï¼‰ã€‚

### History â†” Context â†” Provider åä½œ
- **æ¥å£åˆ†å±‚**ï¼šä»…å®ç° `IContextMessage` çš„å†å²æ¡ç›®æ‰ä¼šè¿›å…¥ä¸Šä¸‹æ–‡åˆ—è¡¨ï¼›éä¸Šä¸‹æ–‡å‹äº‹ä»¶ï¼ˆå¦‚æœªæ¥çš„é…ç½®æ›´æ–°ï¼‰é»˜è®¤è¢«è¿‡æ»¤ï¼Œå½¢æˆå¤©ç„¶çš„èŒè´£åˆ†ç•Œã€‚Provider åœ¨æ¶ˆè´¹è£…é¥°è¿‡çš„æ¶ˆæ¯æ—¶éœ€å›é€€åˆ° `ILiveScreenCarrier.InnerMessage`ï¼Œä¿è¯è§’è‰²åŒ–æ¥å£ (`IModelInputMessage`ã€`IModelOutputMessage` ç­‰) å¯è¢«æ­£ç¡®è¯†åˆ«ã€‚
- **ä¸Šä¸‹æ–‡å¤ç”¨**ï¼š`RenderLiveContext()` ä¼˜å…ˆè¿”å›å†å²æ¡ç›®çš„åŸå§‹å®ä¾‹ï¼Œåªæœ‰åœ¨æ³¨å…¥ LiveScreen æˆ–ä¸´æ—¶ Metadata æ—¶æ‰ä¼šç”Ÿæˆè½»é‡åŒ…è£…ï¼Œé¿å…é¢‘ç¹å¤åˆ¶ã€‚æœªæ¥åœ¨å¼•å…¥ Token é™é¢æ—¶ï¼Œå¯åœ¨æ­¤å±‚å®ç°ç»Ÿä¸€çš„è£å‰ªç­–ç•¥è€Œä¸è§¦ç¢° Providerã€‚
- **å›å†™ä¸€è‡´æ€§**ï¼šæ¨¡å‹æ¨ç†å®Œæˆåï¼ŒOrchestrator å¿…é¡»å…ˆèšåˆå…¨éƒ¨å¢é‡å†è°ƒç”¨ AgentState è¿½åŠ æ¡ç›®ï¼Œç¦æ­¢ Provider è‡ªè¡Œå†™å…¥ `_history`ï¼Œä»¥ç¡®ä¿æ¯è½®æ¨ç†å¯¹åº”ä¸€æ¡ `ModelOutputEntry` ä¸å¯é€‰çš„ `ToolResultsEntry`ã€‚
- **Widget å¯¹é½**ï¼šç³»ç»ŸæŒ‡ä»¤ç»´æŒå®¿ä¸»å­—æ®µï¼Œè€Œ Notebook ç­‰è¿è¡Œæ€æ•°æ®ç”± Widget æ¸²æŸ“ä¸º LiveScreen æ®µè½ï¼Œä¸ç›´æ¥è½ç›˜ï¼›å½“ Widget éœ€è¦äº‹ä»¶åŒ–ï¼ˆä¾‹å¦‚ Notebook åˆ‡æ¢ä¸ºäº‹ä»¶æµï¼‰æ—¶ï¼Œå¯æ–°å¢ä¸“é—¨çš„ `HistoryEntryKind` è€Œä¸ä¼šå½±å“æ—¢æœ‰ Provider åè®®ã€‚
- **Widget â†” å·¥å…·æ‰§è¡Œ**ï¼šWidget æš´éœ²çš„ `ITool` é€šè¿‡ `AgentState.EnumerateWidgetTools()` æ±‡æ€»ï¼Œä¾› Planner ä¸ ToolExecutor ç»Ÿä¸€è°ƒåº¦ï¼›Widget æ‰§è¡Œç»“æœä»ä»¥ `ToolResultsEntry` å›å†™ï¼Œä¿è¯å†å²è§†å›¾çš„ä¸€è‡´æ€§ã€‚

#### LiveScreen å¤„ç†çº¦å®š
- æ¸²æŸ“é˜¶æ®µä»…åœ¨æœ€æ–°ä¸€æ¬¡æ¨¡å‹è¾“å…¥æˆ–å·¥å…·ç»“æœæ¡ç›®ä¸Šé™„åŠ  LiveScreenï¼Œé¿å…é‡å¤å±•ç¤ºï¼›è‹¥ä¼šè¯æš‚æœªç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œåˆ™ä¿ç•™ä¸Šä¸€æ¬¡è£…é¥°ç»“æœã€‚
- æ¶ˆè´¹æ–¹åœ¨æ£€æµ‹åˆ° `ILiveScreenCarrier` æ—¶ï¼Œå¿…é¡»å…ˆè¯»å– `InnerMessage` å†æ‰§è¡Œè§’è‰²åŒ–æ¥å£åˆ¤å®šï¼Œä»¥ä¿è¯è£…é¥°ä¸ä¼šå¹²æ‰° `IModelInputMessage`ã€`IModelOutputMessage` ç­‰æ¥å£çš„è®¿é—®ï¼›éœ€è¦å±•ç¤º LiveScreen çš„ Provider å¯æŒ‰è‡ªèº«åè®®å†³å®šå‘ˆç°æ–¹å¼ï¼ˆMarkdownã€ä¸å¯è§ token æˆ–å¤šæ¨¡æ€ partï¼‰ã€‚

### ContextMessage å±‚æ¥å£è®¾è®¡ï¼ˆâœ…ï¼‰
- **è®¾è®¡ç›®æ ‡**ï¼šä¿æŒ Context å±‚ä¾›åº”å•†æ— å…³æ€§ï¼Œé¿å…é‡å¤æ„é€ å†å²æ¡ç›®ï¼Œå¹¶è®© Provider é€šè¿‡æ¥å£æ£€æµ‹å¿«é€Ÿå®šä½æ‰€éœ€å­—æ®µã€‚
  - åŸºç¡€æ¥å£ä»…ä¿ç•™è§’è‰²ã€æ—¶é—´æˆ³ä¸ Metadataï¼Œè¯­ä¹‰å­—æ®µäº¤ç”±æ´¾ç”Ÿæ¥å£æ‰¿è½½ã€‚
  - è§’è‰²åŒ–æ¥å£è¦†ç›–ç³»ç»ŸæŒ‡ä»¤ã€æ¨¡å‹è¾“å…¥ã€æ¨¡å‹è¾“å‡ºä¸å·¥å…·ç»“æœå››ç§æ ¸å¿ƒæ¶ˆæ¯ç±»å‹ã€‚
  - å¯é€‰èƒ½åŠ›é€šè¿‡ mix-in æ¥å£è¡¨è¾¾ï¼ˆLiveScreenã€ToolCallsã€TokenUsage ç­‰ï¼‰ï¼ŒæŒ‰éœ€ç»„åˆè€Œéå¼ºåˆ¶æ‰€æœ‰æ¡ç›®å®ç°ã€‚

```csharp
interface IContextMessage {
  ContextMessageRole Role { get; }
  DateTimeOffset Timestamp { get; }
  ImmutableDictionary<string, object?> Metadata { get; }
}

enum ContextMessageRole {
  System,
  ModelInput,
  ModelOutput,
  ToolResult
}
```

- **è§’è‰²åŒ–æ¥å£**ï¼š

| æ¥å£ | é¢å¤–å­—æ®µ | è¯´æ˜ |
| --- | --- | --- |
| `ISystemMessage` | `string Instruction` | å½“å‰ç³»ç»ŸæŒ‡ä»¤åŸæ–‡ï¼Œé¢å‘æ‰€æœ‰ Provider çš„æœ€å°å…¬çº¦æ•°ã€‚ |
| `IModelInputMessage` | `IReadOnlyList<KeyValuePair<string,string>> ContentSections`ã€`IReadOnlyList<IContextAttachment> Attachments` | è¡¨è¾¾è¾“å…¥åˆ†æ®µä¸é™„ä»¶ï¼Œé™„ä»¶ç›®å‰é»˜è®¤è¿”å›ç©ºé›†åˆã€‚ |
| `IModelOutputMessage` | `ModelInvocationDescriptor Invocation`ã€`IReadOnlyList<string> Contents`ã€`IReadOnlyList<ToolCallRequest> ToolCalls` | æ±‡æ€»å•è½®æ¨¡å‹è¾“å‡ºçš„æ–‡æœ¬ä¸å·¥å…·è°ƒç”¨å£°æ˜ã€‚ |
| `IToolResultsMessage` | `IReadOnlyList<ToolCallResult> Results`ã€`string? ExecuteError` | æ±‡æ€»å·¥å…·æ‰§è¡Œç»“æœï¼Œ`ExecuteError` è¡¨ç¤ºæ•´ä½“å¤±è´¥åŸå› ï¼ˆè‹¥æœ‰ï¼‰ã€‚ |

```csharp
interface ISystemMessage : IContextMessage {
  string Instruction { get; }
}

interface IModelInputMessage : IContextMessage {
  IReadOnlyList<KeyValuePair<string, string>> ContentSections { get; }
  IReadOnlyList<IContextAttachment> Attachments { get; }
}

interface IModelOutputMessage : IContextMessage, IToolCallCarrier {
  ModelInvocationDescriptor Invocation { get; }
  IReadOnlyList<string> Contents { get; }
}

interface IToolResultsMessage : IContextMessage {
  IReadOnlyList<ToolCallResult> Results { get; }
  string? ExecuteError { get; }
}
```

- **å¯é€‰èƒ½åŠ›æ¥å£**ï¼š
  - `ILiveScreenCarrier` æš‚å­˜ Planner/å·¥å…·ä¾§çš„ä¸´æ—¶å±å¹•ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ `InnerMessage` æš´éœ²è¢«è£…é¥°çš„åŸå§‹æ¶ˆæ¯ã€‚
  - `ITokenUsageCarrier` ç”¨äº Provider åœ¨å“åº”ç»“æŸåå›å¡« token ç»Ÿè®¡ï¼›å½“å‰å®ç°é»˜è®¤è¿”å› `null`ã€‚
  - `IToolCallCarrier` ç”± `IModelOutputMessage` å®ç°ï¼Œç»Ÿä¸€æš´éœ²æ¨¡å‹å£°æ˜çš„å·¥å…·è°ƒç”¨é›†åˆã€‚

```csharp
interface ILiveScreenCarrier {
  string? LiveScreen { get; }
  IContextMessage InnerMessage { get; }
}

interface IToolCallCarrier {
  IReadOnlyList<ToolCallRequest> ToolCalls { get; }
}

interface ITokenUsageCarrier {
  TokenUsage? Usage { get; }
}
```

- **ååŒçº¦å®š**ï¼š
  - `RenderLiveContext()` ä¼˜å…ˆå¤ç”¨å†å²æ¡ç›®æœ¬èº«ï¼Œæ³¨å…¥ LiveScreen æ—¶æ‰åˆ›å»ºè£…é¥°å¯¹è±¡ã€‚
  - Provider åœ¨æ¶ˆè´¹è£…é¥°å¯¹è±¡æ—¶å¿…é¡»å›é€€è‡³ `ILiveScreenCarrier.InnerMessage` å†æ‰§è¡Œæ¥å£åŒ¹é…ï¼Œé¿å…è£…é¥°å™¨é®æŒ¡è§’è‰²åŒ–æ¥å£ã€‚
  - Metadata é”®åé‡‡ç”¨è›‡å½¢å‘½åï¼Œä½“é‡é™åˆ¶ 2 KBï¼Œè¶…å‡ºéƒ¨åˆ†éœ€è½¬äº¤é™„ä»¶æˆ–ä¸“ç”¨æ¡ç›®ã€‚
  - `ToolCallRequest.RawArguments` æ°¸è¿œä¿ç•™åŸå§‹å‚æ•°æ–‡æœ¬ï¼Œè§£ææˆåŠŸåå†è¡¥å†™ `Arguments` å­—å…¸ï¼›å¤±è´¥æ—¶å°†åŸå› å†™å…¥ `ParseError`ã€‚
- **æš‚ç¼“è®¾è®¡**ï¼šç»“æ„åŒ–é™„ä»¶ã€åŠ¨æ€å·¥å…·æ¸…å•ç­‰å»¶åèƒ½åŠ›åœ¨â€œå¾…å®šè®¾è®¡â€ç« èŠ‚æœ‰å•ç‹¬è¯´æ˜ï¼Œæœ¬èŠ‚ä»…å®šä¹‰å ä½æ¥å£ä¿æŒå…¼å®¹ã€‚

### Provider å®¢æˆ·ç«¯è®¾è®¡è¦ç‚¹ï¼ˆğŸ› ï¸ï¼‰
#### é€šç”¨å¥‘çº¦ï¼ˆâœ…ï¼‰
- æ‰€æœ‰ Provider å®ç°ç»Ÿä¸€æš´éœ² `IProviderClient.CallModelAsync(IReadOnlyList<IContextMessage>, CancellationToken)`ï¼Œè¿”å› `ModelOutputDelta` æµã€‚å®ç°å±‚è´Ÿè´£è§£æå·¥å…·è°ƒç”¨ã€å¡«å…… `ToolCallRequest.Arguments`ï¼Œå¹¶åœ¨å¤±è´¥æ—¶å›å¡« `ParseError`ã€‚
- Provider å¿…é¡»è®°å½• `ModelInvocationDescriptor`ï¼ˆProviderId/Specification/Modelï¼‰ï¼Œå¹¶åœ¨å›å†™ `ModelOutputEntry` æ—¶é™„ä¸Šï¼Œä¾¿äºå†å²å®¡è®¡ä¸æ··åˆæ¨¡å‹ä¼šè¯ã€‚
- ä»»ä½•æµå¼é˜¶æ®µæ”¶é›†çš„è¯Šæ–­ä¿¡æ¯ï¼ˆTokenUsageã€åŸå§‹ SDK é”™è¯¯ç­‰ï¼‰éœ€è¦åœ¨èšåˆå®Œæˆåï¼Œé€šè¿‡ `Metadata` æˆ–å¯é€‰æ¥å£è¿”å›ç»™ Orchestratorã€‚
- ä¸ºå‡å°‘é‡å¤è§£æä»£ç ï¼Œæ¨èæä¾›å…±äº«çš„ `ToolArgumentParser` è¾…åŠ©å™¨ï¼ˆä¾‹å¦‚ `GetRequired(...)`ã€`ParseList(...)`ã€`ParseJsonSafely(...)`ï¼‰ï¼Œä¾›å„ Provider ä¸å·¥å…·å®ç°é‡å¤åˆ©ç”¨ã€‚
- Provider å±‚éœ€ç»´æŠ¤â€œSpecification â†’ å‚æ•°è§£æç­–ç•¥â€çš„é™æ€æ˜ å°„ï¼š`ModelOutputEntry.Invocation` æä¾›è§„èŒƒæ ‡è¯†ï¼Œå…·ä½“æ ¼å¼è§£æç”±å„å®ç°å†…éƒ¨å†³å®šï¼Œä¿æŒ History æŠ½è±¡çš„ä¾›åº”å•†æ— å…³æ€§ã€‚
- Provider åœ¨æ±‡æ€»é˜¶æ®µè´Ÿè´£å†™å…¥ `ToolCallResult.Elapsed`ã€`ToolResultsEntry.ExecuteError` ç­‰è¯Šæ–­ä¿¡æ¯ï¼Œä¿è¯ä¸Šå±‚å¯è¿½è¸ªå·¥å…·é“¾è·¯çš„è€—æ—¶ä¸å¤±è´¥åŸå› ã€‚

#### OpenAI å®¢æˆ·ç«¯è¦ç‚¹ï¼ˆğŸ› ï¸ï¼‰
- å°† `IContextMessage` åºåˆ—ç¿»è¯‘ä¸º Chat Completion æ‰€éœ€çš„æ¶ˆæ¯æ•°ç»„ï¼›`ModelInputEntry.ContentSections` ä»¥â€œæ ‡é¢˜ + å†…å®¹â€çš„ Markdown ç»„åˆæ‹¼æ¥æˆå•æ¡æ–‡æœ¬ï¼Œç¡®ä¿æ®µè½è¯­ä¹‰è¢«ä¿ç•™ã€‚
- OpenAI åœ¨æµå¼é˜¶æ®µå¯èƒ½è¾“å‡ºå¤šæ¡å·¥å…·è°ƒç”¨ deltaï¼Œå®¢æˆ·ç«¯éœ€å°†åŒä¸€è½®æ¨ç†äº§ç”Ÿçš„è°ƒç”¨åˆå¹¶ï¼Œå¹¶ä¿è¯é¡ºåºä¸ `ToolResultsEntry.Results` ä¸€ä¸€å¯¹åº”ã€‚
- å¯¹å·¥å…·å‚æ•°è§£ææˆåŠŸæ—¶å†™å…¥ `Arguments` å­—å…¸ï¼Œè§£æå¤±è´¥æ—¶è®°å½•é”™è¯¯å¹¶ä¿ç•™ `RawArguments` åŸæ–‡æœ¬ï¼›æœ€ç»ˆå°†å¤šä¸ªå·¥å…·è°ƒç”¨å½’å¹¶ä¸ºä¸€æ¡ `ToolResultsEntry`ã€‚

#### Anthropic å®¢æˆ·ç«¯è¦ç‚¹ï¼ˆğŸ› ï¸ï¼‰
- Claude è¦æ±‚ Assistant â†” Tool æ¶ˆæ¯ä¸¥æ ¼äº¤æ›¿ï¼Œå®¢æˆ·ç«¯éœ€è¦å°†æ¨¡å‹å‘å‡ºçš„å¤šä¸ªå·¥å…·è°ƒç”¨åˆå¹¶ä¸ºå•æ¡å·¥å…·æ¶ˆæ¯ï¼Œè¡¥é½å¿…è¦çš„å ä½æ–‡æœ¬ï¼Œé¿å…å¥‡å¶åºåˆ—ç ´åã€‚
- ç”¨ä¸ OpenAI å®¢æˆ·ç«¯ç›¸åŒçš„ `ToolCallRequest`/`ToolCallResult` åè®®å›å†™å†å²ï¼Œä¿æŒè·¨ä¾›åº”å•†ä¸€è‡´æ€§ã€‚
- è‹¥åº•å±‚è¿”å›çš„å·¥å…·æ¶ˆæ¯æ— æ³•è§£æï¼Œéœ€è¦åœ¨ `ToolCallResult.Status` ä¸Šæ ‡è®°å¤±è´¥å¹¶å°†é”™è¯¯åŸå› å†™å…¥ `ExecuteError`ï¼Œç”±ä¸Šå±‚ç­–ç•¥å†³å®šæ˜¯å¦é‡è¯•ã€‚

#### å…¶ä»–ä¾›åº”å•†ï¼ˆâ³ï¼‰
- Azure OpenAI ä¸ OpenAI v1 å®¢æˆ·ç«¯å…±äº«æ¶ˆæ¯æ„é€ é€»è¾‘ï¼Œå¯é€šè¿‡é…ç½®åŒºåˆ†ç»ˆç«¯ç‚¹ä¸å‡­æ®ã€‚
- é’ˆå¯¹æœ¬åœ°æ¨ç†ï¼ˆvLLM/Transformersï¼‰ï¼Œå®¢æˆ·ç«¯å¯é€‰æ‹©ç›´æ¥åœ¨è¿›ç¨‹å†…è°ƒç”¨æ¨ç†å¼•æ“ï¼Œä½†ä»é¡»éµå®ˆ `IProviderClient` å¥‘çº¦å¹¶è¿”å›æ ‡å‡†åŒ– deltaã€‚

#### ModelOutputDelta ç®¡çº¿ï¼ˆğŸ› ï¸ï¼‰
- å½“å‰é˜¶æ®µä»…å¯¹æ—¢æœ‰ `ChatResponseDelta` æ›´åä¸º `ModelOutputDelta`ï¼Œä¿ç•™æ–‡æœ¬ç‰‡æ®µã€å·¥å…·è°ƒç”¨å¢é‡ç­‰å­—æ®µï¼Œç¡®ä¿æ”¹é€ æˆæœ¬æœ€å°åŒ–ã€‚
- Orchestrator åœ¨æµå¼æ¶ˆè´¹æ—¶ç´¯ç§¯ deltaï¼Œç»“æŸåè½¬åŒ–ä¸ºä¸€æ¡ `ModelOutputEntry` ä¸å¯é€‰çš„ `ToolResultsEntry`ï¼›ä»»ä½•å®æ—¶è°ƒè¯•æ•°æ®åº”åœ¨èšåˆå®Œæˆæ—¶å†™å…¥ AgentStateï¼Œé¿å…å†å²å±‚å‡ºç°åŠæˆå“æ•°æ®ã€‚
- éšåè‹¥å¼•å…¥æ›´ç»†ç²’åº¦çš„ delta ç±»å‹ï¼ˆå¦‚å¤šæ¨¡æ€ Partï¼‰ï¼Œå°†åœ¨ä¿æŒå‘åå…¼å®¹çš„å‰æä¸‹æ‰©å±•ç»“æ„ï¼Œè€Œä¸ä¼šå½±å“æ—¢æœ‰ Provider å®ç°ã€‚

### ç»„ä»¶è´£ä»»è¾¹ç•Œ
- **AgentStateï¼ˆâœ…å†å²äº‹å®æºï¼‰**ï¼šç®¡ç† `_history` ä¸ Widget å®¿ä¸»çš„ä¸€è‡´æ€§ï¼Œè´Ÿè´£æ—¶é—´æˆ³æ³¨å…¥ã€DebugUtil æ‰“ç‚¹ä»¥åŠåªè¯»è§†å›¾æš´éœ²ï¼›ç¦æ­¢å¤–éƒ¨ç›´æ¥ç¯¡æ”¹é›†åˆï¼Œä»»ä½•è¿½åŠ å¿…é¡»ç»è¿‡è¯­ä¹‰åŒ–å…¥å£ã€‚
- **Context Projectionï¼ˆğŸ› ï¸æ¸²æŸ“å±‚ï¼‰**ï¼šé€šè¿‡ `RenderLiveContext()` å®ç°ä»å†å²â†’ä¸Šä¸‹æ–‡çš„å•å‘è½¬æ¢ï¼Œå¯æ’å…¥ LiveScreen æˆ–å…¶ä»–ä¸´æ—¶è§†å›¾ï¼Œä½†ä¸äº§ç”Ÿå‰¯ä½œç”¨ï¼›åç»­ Token è£å‰ªã€å»é‡é€»è¾‘ä¹Ÿå°†é›†ä¸­åœ¨æ­¤å¤„ã€‚
- **Provider Routerï¼ˆğŸ› ï¸è°ƒåº¦å±‚ï¼‰**ï¼šæ ¹æ®æ¨¡å‹ç­–ç•¥é€‰æ‹© `IProviderClient`ï¼Œå¯¹è¾“å…¥æ‰§è¡Œåè®®é€‚é…ï¼Œå¯¹è¾“å‡ºèšåˆ `ModelOutputDelta` å¹¶åé¦ˆç»Ÿä¸€ç»“æ„ï¼›ä»éœ€è¡¥é½æ··åˆä¾›åº”å•†çš„æ•…éšœè½¬ç§»ä¸æŒ‡æ ‡ä¸ŠæŠ¥ã€‚
- **Orchestratorï¼ˆğŸ› ï¸ä¸šåŠ¡åè°ƒï¼‰**ï¼šå°è£…æ¨¡å‹è°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œè§¦å‘ä¸Šä¸‹æ–‡æ¸²æŸ“ã€é©±åŠ¨ Provider è°ƒç”¨ï¼Œå¹¶åœ¨æ¨ç†ç»“æŸåç»Ÿä¸€å›å†™å†å²ï¼›éœ€è¦åœ¨å®ç°é˜¶æ®µè¡¥å……å¤±è´¥é‡è¯•ã€å·¥å…·é“¾è¶…æ—¶ç­‰è·¨å±‚ç­–ç•¥ã€‚

### è®¾è®¡æ¨¡å¼æ˜ å°„
#### MVVM æ˜ å°„ï¼ˆâœ…ï¼‰
ä¸‰æ®µå¼æµæ°´çº¿å¤©ç„¶æ˜ å°„åˆ° MVVMï¼š

| MVVM å±‚æ¬¡ | Conversation History è§’è‰² | ä¸»è¦èŒè´£ |
| --- | --- | --- |
| Model | AgentState | æŒæœ‰ä¸å¯å˜å†å²ä¸ Widget å®¿ä¸»ï¼Œæ˜¯å•ä¸€äº‹å®æº |
| ViewModel | `RenderLiveContext()` è¾“å‡º | å°†å†å²æŠ•å½±æˆä¸Šä¸‹æ–‡è§†å›¾ï¼Œå¯æŒ‰éœ€æ³¨å…¥ LiveScreen / è®°å¿†ç‰‡æ®µ |
| View | Provider å®¢æˆ·ç«¯ | æ¶ˆè´¹ `IContextMessage` åˆ—è¡¨ï¼Œè½¬æ¢ä¸ºä¾›åº”å•†åè®®å¹¶é©±åŠ¨æ¨ç† |

è¯¥æ˜ å°„ä¿è¯å•å‘æ•°æ®æµï¼ˆHistory â†’ Context â†’ Providerï¼‰ï¼Œå¹¶å…è®¸åœ¨ä¸ä¿®æ”¹å†å²çš„å‰æä¸‹ä¸ºä¸åŒä¾›åº”å•†æä¾›å¤šç§ä¸Šä¸‹æ–‡è§†å›¾ã€‚

#### Event Sourcing æ€ç»´ï¼ˆğŸ› ï¸ï¼‰
HistoryEntry ä»¥ä»…è¿½åŠ æ–¹å¼è®°å½•äº‹ä»¶ï¼Œè¿è¡Œæ—¶å¿«ç…§ï¼ˆç³»ç»ŸæŒ‡ä»¤ã€è®°å¿† Notebook ç­‰ï¼‰å¯é€šè¿‡é‡æ”¾æ¢å¤ã€‚å½“å‰é˜¶æ®µä»…æ³¨å…¥æ—¶é—´æˆ³ï¼›é¡ºåºå·ä¸ StableId å»¶ååˆ°æŒä¹…åŒ–æ–¹æ¡ˆè½åœ°æ—¶ç»Ÿä¸€å¼•å…¥ï¼Œé¿å…æ—©æœŸç»´æŠ¤å†—ä½™å­—æ®µã€‚

- `ModelInputEntry` / `ModelOutputEntry` / `ToolResultsEntry` è¢«æ˜ç¡®è§†ä½œé¢†åŸŸäº‹ä»¶ï¼Œå‘½åä¸­ä¿ç•™ä¸šåŠ¡è¯­ä¹‰ï¼Œé¿å…å›åˆ° CRUD å¼çš„æ¨¡ç³Šè¡¨ç¤ºã€‚
- ç³»ç»ŸæŒ‡ä»¤ä¸è®°å¿† Notebook åˆ†åˆ«ç”±å®¿ä¸»å­—æ®µä¸ Widget ç»´æŠ¤ï¼Œæ¸²æŸ“é˜¶æ®µç”Ÿæˆ `SystemInstructionMessage`ï¼›ä¸€æ—¦ Widget äº‹ä»¶æ¨¡å‹æ•²å®šï¼Œå°†æŠŠè¿™äº›å˜æ›´è¡¥è®°åˆ°å†å²ä¸­ä»¥ç¡®ä¿å¯å›æ”¾æ€§ã€‚
- åœ¨ç¼ºçœç¯å¢ƒä¸‹ä¾èµ– `_clock.Now` æ³¨å…¥æ—¶é—´æˆ³ï¼Œå•å…ƒæµ‹è¯•å¯æ›¿æ¢ `IClock` æ¨¡æ‹Ÿï¼Œä¿è¯äº‹ä»¶æ—¶é—´çº¿ç¨³å®šï¼›åç»­è‹¥å¼•å…¥åºåˆ—å·ï¼Œå°†å¤ç”¨åŒä¸€æ³¨å…¥ç‚¹ã€‚
- DebugUtil æ‰“ç‚¹ç»‘å®šåœ¨äº‹ä»¶è¿½åŠ æµç¨‹ä¸­ï¼Œç»“åˆäº‹ä»¶æ—¥å¿—å¯è¿½æº¯è°ƒç”¨é“¾ä¸å·¥å…·æ‰§è¡Œï¼Œå¥‘åˆ Event Sourcingâ€œäº‹ä»¶å³å®¡è®¡è®°å½•â€çš„ç›®æ ‡ã€‚

#### CQRS ä¸ Repositoryï¼ˆğŸ› ï¸ï¼‰
AgentState å†…éƒ¨å°†å†™å…¥æ¥å£ï¼ˆ`AppendModelInput/Output/ToolResults` ç­‰ï¼‰ä¸æŸ¥è¯¢æ¥å£ï¼ˆ`RenderLiveContext`ã€è®¡åˆ’ä¸­çš„ `GetRecentEntries`ï¼‰åˆ†ç¦»ï¼Œå¹¶å¯¹å¤–ä»¥é¢†åŸŸåŒ– API æš´éœ²ã€‚æœªæ¥è‹¥å¼•å…¥æŒä¹…åŒ–å±‚ï¼Œå¯ç”¨ä»“å‚¨å®ç°æ›¿æ¢å†…å­˜é›†åˆè€Œä¸å½±å“è°ƒç”¨æ–¹ã€‚

- å†™å…¥ä¾§è´Ÿè´£æ—¶é—´æˆ³æ³¨å…¥ã€ToolCall å¯¹é½ã€Debug æ‰“ç‚¹ç­‰å‰¯ä½œç”¨ï¼Œè°ƒç”¨è€…åªéœ€çŸ¥é“â€œè¿½åŠ å“ªä¸ªé¢†åŸŸäº‹ä»¶â€ï¼Œæ— éœ€äº†è§£å†…éƒ¨é›†åˆç»“æ„ã€‚
- æŸ¥è¯¢ä¾§ç»´æŒçº¯è¯»ç‰¹æ€§ï¼Œåç»­è‹¥éœ€è¦ç¼“å­˜æˆ–è£å‰ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åœ¨ä¸è§¦ç¢°å†™å…¥è·¯å¾„çš„æƒ…å†µä¸‹è¿­ä»£ç­–ç•¥ï¼Œé™ä½å›å½’é£é™©ã€‚
- Repository æ€è·¯ä½“ç°åœ¨ AgentState å¯¹å¤–æš´éœ²çš„å—æ§ APIï¼šè°ƒç”¨æ–¹æ— æ³•ç›´æ¥è®¿é—® `_history`ï¼Œæœªæ¥å°†å¯æ›¿æ¢ä¸ºæŒä¹…åŒ–å­˜å‚¨ï¼ˆJSONã€SQLiteã€äº‹ä»¶åº“ï¼‰è€Œæ— éœ€æ”¹åŠ¨ orchestrator ä»£ç ã€‚
- åœ¨å•å…ƒæµ‹è¯•ä¸­å¯é€šè¿‡ stub/fixture AgentState éªŒè¯å†™å…¥äº‹ä»¶ä¸æŸ¥è¯¢è§†å›¾çš„åˆ†ç¦»æ•ˆæœï¼Œä¸ºæœªæ¥çš„æŒä¹…åŒ–å±‚é€‚é…ç•™å‡ºä½™åœ°ã€‚

#### Strategy + Adapterï¼ˆğŸ› ï¸ï¼‰
`IProviderClient` ä¸º ProviderRouter æä¾›ç»Ÿä¸€ç­–ç•¥å…¥å£ï¼Œä¸åŒå®ç°ä»¥ Adapter æ–¹å¼å¯¹æ¥ OpenAIã€Anthropicã€vLLM ç­‰ SDKã€‚æ¯ä¸ªå®ç°è´Ÿè´£ç¿»è¯‘ `IContextMessage`ã€è§£æå¢é‡ä¸å·¥å…·è°ƒç”¨ï¼Œå¹¶å›å†™æ ‡å‡†åŒ–ç»“æ„ã€‚

- Strategy å±‚ç”± ProviderRouter æ‰¿æ‹…ï¼Œæ ¹æ®æ¨¡å‹ç­–ç•¥ï¼ˆè§„åˆ’/æ‰§è¡Œ/è¯„å®¡ï¼‰æˆ–è¿è¡Œæ—¶æŒ‡æ ‡ï¼ˆå»¶è¿Ÿã€æˆæœ¬ï¼‰æŒ‘é€‰ä¸åŒ Providerï¼Œå®ç°â€œæŒ‰éœ€æ¢è„‘â€ã€‚
- Adapter å±‚å±è”½ä¾›åº”å•† SDK å·®å¼‚ï¼šæ¯ä¸ª `IProviderClient` å®ç°åªå¤„ç†è‡ªèº«åè®®ç»†èŠ‚ï¼Œä¾‹å¦‚ OpenAI çš„ Function Calling vs Responses APIï¼ŒAnthropic çš„ Messages API ç­‰ã€‚
- ç»„åˆ Strategy + Adapter è®©æ–°ä¾›åº”å•†çš„æ¥å…¥æµç¨‹æ¸…æ™°ï¼šå…ˆå®ç°ä¸€ä¸ª Adapterï¼Œæš´éœ²ç»Ÿä¸€æ¥å£ï¼Œå†åœ¨ Router ä¸­æ³¨å†Œç­–ç•¥å³å¯æŠ•å…¥ä½¿ç”¨ã€‚
- è¯¥è®¾è®¡ä¹Ÿä¾¿äºæ„å»ºæ¨¡æ‹Ÿ Providerï¼Œç”¨é€‚é…å™¨åŒ…è£…æµ‹è¯•æ¡©å³å¯å¤ç”¨ Router é€»è¾‘ï¼Œæ”¯æ’‘ç«¯åˆ°ç«¯éªŒè¯ã€‚

#### Decoratorï¼ˆâœ…ï¼‰
`ContextMessageLiveScreenHelper` ä½¿ç”¨è£…é¥°å™¨åŒ…è£…ä¸Šä¸‹æ–‡æ¡ç›®ï¼Œå°† LiveScreen ç­‰ä¸´æ—¶èƒ½åŠ›é™„åŠ å…¶ä¸Šè€Œä¸æ”¹å˜åŸå§‹è®°å½•ç±»å‹ã€‚æ¶ˆè´¹æ–¹é€šè¿‡ `ILiveScreenCarrier.InnerMessage` è®¿é—®åŸå§‹æ¥å£ï¼Œç¡®ä¿è§’è‰²åˆ¤å®šå’Œå¤ç”¨ä¸å—å½±å“ã€‚

### AgentState ä¸ Widget èŒè´£ï¼ˆğŸ› ï¸ï¼‰
- **çŠ¶æ€èšåˆå™¨**ï¼šAgentState ç»´æŠ¤ `_history` å¹¶ä½œä¸º Widget å®¿ä¸»ï¼Œç»Ÿä¸€åˆ›å»ºã€æŒæœ‰å¹¶æš´éœ²å—æ§è®¿é—®å™¨ï¼ˆå½“å‰åŒ…å« `MemoryNotebookWidget`ï¼‰ï¼Œç¡®ä¿â€œå”¯ä¸€äº‹å®æºâ€ã€‚
- **è¿½åŠ å¼å†å²**ï¼šæ‰€æœ‰å†å²äº‹ä»¶éƒ½éœ€é€šè¿‡ AgentState è¿½åŠ ï¼Œç¦æ­¢å¤–éƒ¨ç›´æ¥ç¼–è¾‘æˆ–åˆ é™¤ï¼›Widget åœ¨æ›´æ–°è‡ªèº«çŠ¶æ€æ—¶å¿…é¡»å§”æ‰˜ AgentState çš„å†™å…¥å…¥å£ï¼Œä»¥ä¿æŒå†å²ä¸è¿è¡Œæ€ä¸€è‡´ã€‚
- **ä¸Šä¸‹æ–‡æ¸²æŸ“çº¦æŸ**ï¼š`RenderLiveContext()` é»˜è®¤è¿è¡Œåœ¨å•çº¿ç¨‹ orchestrator ä¸Šï¼Œåå‘éå†å†å²å¹¶æŒ‘é€‰æœ€æ–°è¾“å…¥æˆ–å·¥å…·æ¡ç›®é™„åŠ  LiveScreenï¼›Widget é€šè¿‡ `RenderLiveScreen` è¾“å‡º Markdown ç‰‡æ®µï¼Œç”± AgentState ç»Ÿä¸€æ³¨å…¥ã€‚
- **Widget å·¥å…·æ¡¥æ¥**ï¼šAgentState æä¾› `EnumerateWidgetTools()` å°†æ‰€æœ‰ Widget æš´éœ²çš„ `ITool` ç»„åˆæˆåªè¯»æ¸…å•ï¼Œä¾› Planner/LLM åœ¨è°ƒç”¨é˜¶æ®µå‘ç°ä¸æ‰§è¡Œã€‚
- **å®¿ä¸»é…ç½®å˜æ›´**ï¼šç³»ç»ŸæŒ‡ä»¤ç­‰å®¿ä¸»å­—æ®µä»ç”± AgentState ç›´æ¥ç»´æŠ¤ï¼›Widget è´Ÿè´£è‡ªèº«çš„è¿è¡Œæ€å¿«ç…§ï¼ˆä¾‹å¦‚ Notebook å†…å®¹ï¼‰ï¼Œå¿…è¦æ—¶å¯å°†å˜æ›´é€å‡ºä¸ºå†å²å…ƒæ•°æ®æˆ– Debug æ—¥å¿—ã€‚
- **å•çº¿ç¨‹å‡è®¾**ï¼šä¾èµ– orchestrator çš„ä¸²è¡Œæ‰§è¡Œæ¨¡å‹ï¼Œå†…éƒ¨ä¸åŠ é”ï¼›æœªæ¥è‹¥å¼•å…¥å¤šçº¿ç¨‹ï¼Œéœ€è¦åœ¨è°ƒç”¨æ–¹å¢åŠ åŒæ­¥å±‚æˆ–å¼•å…¥äº‹åŠ¡åŒ…è£…ã€‚
- **å›æ”¾é¢„ç•™**ï¼šæš‚ä¸æ”¯æŒå†å²å›æ”¾/å¿«ç…§ï¼Œä½†æ‰€æœ‰è¿½åŠ æ¥å£ä¸ Widget çŠ¶æ€å…¥å£éƒ½é›†ä¸­åœ¨ AgentStateï¼Œåç»­å¯åœ¨åŒä¸€ç‚¹æ‰©å±•åºåˆ—å·ã€å¿«ç…§ä¸ rollback èƒ½åŠ›ã€‚

#### Widget çº¦å®šï¼ˆğŸ› ï¸ï¼‰
- Widget å¿…é¡»å®ç° `IWidget` æ¥å£å¹¶æä¾›ç¨³å®šçš„ `Name`ã€`Description` ä¸åªè¯» `Tools` é›†åˆï¼Œä¾›å‘ç°ä¸èƒ½åŠ›æ›å…‰ã€‚
- `RenderLiveScreen(WidgetRenderContext)` è´Ÿè´£å°† Widget å†…éƒ¨çŠ¶æ€åºåˆ—åŒ–ä¸º Markdown ç‰‡æ®µï¼›è¿”å› `null` æˆ–ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸æ³¨å…¥ LiveScreenã€‚
- `ExecuteTool(toolName, ToolExecutionContext)` ç”¨äºæ´¾å‘å·¥å…·æ‰§è¡Œï¼›Widget å†…éƒ¨éœ€è¦éªŒè¯å·¥å…·åç§°ï¼Œå¹¶åœ¨æˆåŠŸæˆ–å¤±è´¥è·¯å¾„ä¸Šé€šè¿‡ `ToolHandlerResult` æ˜ç¡®ç»“æœã€‚
- Widget å¯ä»¥è®¿é—® `WidgetRenderContext.AgentState` çš„åªè¯»è§†å›¾è¯»å–å†å²æˆ–å…¶ä»– Widget å¿«ç…§ï¼Œä½†ä¸å¾—ç›´æ¥ä¿®æ”¹ `_history`ï¼›ä»»ä½•çŠ¶æ€å˜æ›´éœ€é€šè¿‡å®¿ä¸»æä¾›çš„å—æ§æ–¹æ³•ï¼ˆå¦‚ `ReplaceNotebookFromHost`ï¼‰å®Œæˆã€‚
- Widget åº”åœ¨å…³é”®æ“ä½œä¸­è°ƒç”¨ `DebugUtil`ï¼Œä¸ºè¿è¡Œæ—¶è¿½è¸ªæä¾›ç»Ÿä¸€æ—¥å¿—å…¥å£ï¼ˆæ¨èä½¿ç”¨ `MemoryNotebookWidget` ç­‰ä¸“ç”¨ç±»åˆ«ï¼‰ã€‚
- å½“å‰é˜¶æ®µé»˜è®¤ `AgentState` ä»¥å›ºå®šé¡ºåºéå† `_widgets` å¹¶æ‹¼æ¥ LiveScreenï¼›æœªæ¥è‹¥éœ€è¦ä¼˜å…ˆçº§æˆ–åˆ†ç»„ï¼Œå¯æ‰©å±• `WidgetMetadata`ã€‚
- Widget æ¥å£è‰æ¡ˆä¸æ›´è¯¦ç»†çš„èŒè´£è¯´æ˜å¯å‚è€ƒã€Š[LiveContextProto Widget è®¾è®¡æ¦‚å¿µè‰æ¡ˆ](../LiveContextProto/WidgetConcept.md)ã€‹ã€‚

#### é¡ºåºä¸ç¨³å®šæ ‡è¯†ç­–ç•¥ï¼ˆâ³ï¼‰
- å½“å‰é˜¶æ®µä¸ç»´æŠ¤å•è°ƒåºåˆ—å·æˆ–ç¨³å®š Guidï¼Œä»¥é¿å…åœ¨å°šæœªå¯ç”¨æŒä¹…åŒ–åŠŸèƒ½å‰å¼•å…¥é¢å¤–è´Ÿæ‹…ã€‚
- å¾…äº‹ä»¶å­˜å‚¨æˆ–å¿«ç…§æ–¹æ¡ˆæ˜ç¡®åï¼Œå°†åœ¨è¿½åŠ å…¥å£é›†ä¸­æ³¨å…¥ `SequenceNumber`ã€`StableId` ç­‰å­—æ®µï¼Œå¹¶é…å¥—æµ‹è¯•ä¸å›æ”¾æœºåˆ¶ã€‚
- é¢†åŸŸæ–¹æ³•å·²ä¿ç•™ç»Ÿä¸€çš„æ—¶é—´æˆ³æ³¨å…¥è·¯å¾„ï¼Œåç»­æ‰©å±•é¡ºåºå·æˆ–å…¶ä»–å…ƒæ•°æ®æ—¶å¯å¤ç”¨ç›¸åŒçš„æ³¨å…¥ç‚¹ã€‚

- **æš‚ç¼“èƒ½åŠ›**ï¼šå†å²å›æ”¾ã€å¿«ç…§æ¢å¤ã€Widget çŠ¶æ€è‡ªåŠ¨è®°è´¦ç­‰èƒ½åŠ›è¢«ç»Ÿä¸€çº³å…¥ Deferred èŒƒç•´ï¼Œå¾…äº‹ä»¶å­˜å‚¨æ–¹æ¡ˆæ˜ç¡®åå†è®¾è®¡ï¼Œä»¥å…åˆ†æ•£å½“å‰é˜¶æ®µçš„å®ç°ç²¾åŠ›ã€‚

#### AgentState ç›®æ ‡ API è½®å»“ï¼ˆğŸ› ï¸ï¼‰
> ç›®æ ‡ï¼šåœ¨ Phase 1 å°¾å£°æ›¿æ¢ä¸´æ—¶çš„ `AppendHistory`ï¼Œè®© orchestrator ä»…ä¾èµ–è¯­ä¹‰åŒ–è¿½åŠ å…¥å£ï¼Œå¹¶æ˜¾å¼æš´éœ² Widget å®¿ä¸»èƒ½åŠ›ã€‚

- `AppendModelInput(ModelInputEntry entry)`
  - **è¾“å…¥**ï¼šå·²å¡«å……ä¸šåŠ¡å­—æ®µçš„ `ModelInputEntry`ï¼Œè‡³å°‘åŒ…å«ä¸€æ®µ `ContentSections`ã€‚
  - **è¡Œä¸º**ï¼šåœ¨æ³¨å…¥æ—¶é—´æˆ³ä¸é»˜è®¤ Metadata åå†™å…¥ `_history`ï¼Œå¹¶è®°å½• DebugUtil æ‰“ç‚¹ã€‚
  - **é”™è¯¯æ¨¡å¼**ï¼šå½“ `ContentSections` ä¸ºç©ºæ—¶æŠ›å‡º `ArgumentException`ï¼Œé˜»æ­¢ç©ºè¾“å…¥æ±¡æŸ“å†å²ã€‚
- `AppendModelOutput(ModelOutputEntry entry)`
  - **è¾“å…¥**ï¼šèšåˆåçš„æ¨¡å‹è¾“å‡ºæ¡ç›®ï¼Œè‡³å°‘åŒ…å«æ­£æ–‡æˆ–å·¥å…·è°ƒç”¨å…¶ä¸€ã€‚
  - **è¡Œä¸º**ï¼šå†™å…¥ `_history` å‰æ‰§è¡Œæœ€å°æ ¡éªŒï¼Œåç»­å¯åœ¨è°ƒç”¨æ–¹æ³¨å…¥ delta ç»Ÿè®¡ç­‰ Metadataã€‚
  - **é”™è¯¯æ¨¡å¼**ï¼šå½“æ­£æ–‡ä¸å·¥å…·è°ƒç”¨åŒæ—¶ä¸ºç©ºæ—¶æŠ›å‡º `ArgumentException`ã€‚
- `AppendToolResults(ToolResultsEntry entry)`
  - **èŒè´£**ï¼šä¿è¯å·¥å…·æ‰§è¡Œç»“æœä¸ä¸Šä¸€æ¡ `ModelOutputEntry.ToolCalls` å¯¹é½ï¼›æ”¯æŒä»…å†™å…¥ `ExecuteError` çš„å¤±è´¥åœºæ™¯ã€‚
  - **è¡Œä¸º**ï¼šç»Ÿä¸€æ³¨å…¥æ—¶é—´æˆ³å¹¶è¿½åŠ åˆ° `_history`ã€‚
- `SetSystemInstruction(string instruction)`
  - **è¡Œä¸º**ï¼šæ›´æ–°ç³»ç»ŸæŒ‡ä»¤å®¿ä¸»å­—æ®µå¹¶å†™å…¥ Debug æ—¥å¿—ï¼›åç»­è®¡åˆ’é€šè¿‡ä¸“é—¨çš„ HistoryEntry è®°è´¦ã€‚
- `UpdateMemoryNotebook(string? content)`
  - **èŒè´£**ï¼šç”±å®¿ä¸»è°ƒç”¨ä»¥åŒæ­¥ Notebook æœ€æ–°å†…å®¹ï¼Œå†…éƒ¨å§”æ‰˜ `MemoryNotebookWidget.ReplaceNotebookFromHost`ã€‚
- `EnumerateWidgetTools()`
  - **è¡Œä¸º**ï¼šéå† `_widgets` èšåˆæ‰€æœ‰ `ITool`ï¼Œä¾› Planner æˆ– ToolExecutor è·å– Widget èƒ½åŠ›æ¸…å•ã€‚
- `RenderLiveContext()`
  - **è¡Œä¸º**ï¼šåå‘éå†å†å²ç”Ÿæˆä¸Šä¸‹æ–‡åˆ—è¡¨ï¼Œå¹¶é€šè¿‡ `_widgets` æ„å»ºç»Ÿä¸€çš„ LiveScreen ç‰‡æ®µåé™„ç€åœ¨æœ€æ–°è¾“å…¥æˆ–å·¥å…·ç»“æœä¸Šã€‚

ä¸Šè¿°æ–¹æ³•å…±ç”¨ç§æœ‰ `AppendContextualEntry<T>`ï¼Œè´Ÿè´£ç»Ÿä¸€æ³¨å…¥æ—¶é—´æˆ³å¹¶å†™å…¥ Debug æ—¥å¿—ï¼›Widget çŠ¶æ€å†™å…¥ç»Ÿä¸€é€šè¿‡å®¿ä¸»è¾…åŠ©æ–¹æ³•å®Œæˆã€‚

**è¾¹ç•Œåœºæ™¯**ï¼š

- **ç©ºå†å²åˆå§‹åŒ–**ï¼šé¦–æ¬¡è¿½åŠ åº”è‡ªåŠ¨æ³¨å…¥ç³»ç»ŸæŒ‡ä»¤æŠ•å½±ï¼Œé¿å… `RenderLiveContext()` è¿”å›ç©ºåºåˆ—ã€‚
- **å¹¶å‘å†™å…¥**ï¼šç»§ç»­ä¾èµ–å¤–éƒ¨åŠ é”ï¼Œä½†é€šè¿‡æ³¨å…¥å¼ `IClock` ä¸ `IDebugSink` è®©å•å…ƒæµ‹è¯•å¯æ§ã€‚
- **å›æ»šéœ€æ±‚**ï¼šæš‚ä¸æš´éœ²æ’¤é”€æ¥å£ï¼›è‹¥æœªæ¥å¼•å…¥ï¼Œå°†é€šè¿‡äº‹åŠ¡åŒ–åŒ…è£…å™¨ä¸ `AgentStateSnapshot` åè°ƒã€‚

##### ç¤ºä¾‹ï¼šAgentState éª¨æ¶è‰å›¾ï¼ˆğŸ› ï¸ï¼‰
> æ­¤ç¤ºä¾‹ä»¥ä¼ªä»£ç å½¢å¼å±•ç¤ºè¯­ä¹‰åŒ–è¿½åŠ æ¥å£ã€ç»Ÿä¸€æ—¶é—´æˆ³æ³¨å…¥ä¸ä¸Šä¸‹æ–‡æ¸²æŸ“çš„åä½œæ–¹å¼ï¼Œå…·ä½“ä¾èµ–ï¼ˆ`IClock`ã€`LiveContextProjectionOptions`ã€`EnsureToolCallAlignment` ç­‰ï¼‰å°†åœ¨å®ç°é˜¶æ®µè½åœ°ã€‚

```csharp
sealed class AgentState
{
  private readonly List<HistoryEntry> _history = new();
  private readonly Func<DateTimeOffset> _timestampProvider;
  private readonly ImmutableArray<IWidget> _widgets;

  public AgentState(Func<DateTimeOffset> timestampProvider, string systemInstruction)
  {
    _timestampProvider = timestampProvider;
    SystemInstruction = systemInstruction;

    var notebook = new MemoryNotebookWidget();
    _widgets = ImmutableArray.Create<IWidget>(notebook);
    MemoryNotebookWidget = notebook;
  }

  public string SystemInstruction { get; private set; }
  public MemoryNotebookWidget MemoryNotebookWidget { get; }
  public IReadOnlyList<HistoryEntry> History => _history;

  public ModelInputEntry AppendModelInput(ModelInputEntry entry)
  {
    if (entry.ContentSections is not { Count: > 0 })
    {
      throw new ArgumentException("ContentSections must contain at least one section.", nameof(entry));
    }

    return AppendContextualEntry(entry);
  }

  public ModelOutputEntry AppendModelOutput(ModelOutputEntry entry)
  {
    if ((entry.Contents is null || entry.Contents.Count == 0) &&
        (entry.ToolCalls is null || entry.ToolCalls.Count == 0))
    {
      throw new ArgumentException("ModelOutputEntry must include content or tool calls.", nameof(entry));
    }

    return AppendContextualEntry(entry);
  }

  public IReadOnlyList<IContextMessage> RenderLiveContext()
  {
    var messages = new List<IContextMessage>(_history.Count + 1);
    var liveScreen = BuildLiveScreenSnapshot();
    var injected = false;

    for (var index = _history.Count - 1; index >= 0; index--)
    {
      if (_history[index] is not ContextualHistoryEntry contextual)
      {
        continue;
      }

      var message = contextual;
      if (!injected && !string.IsNullOrWhiteSpace(liveScreen) && ShouldDecorateWithLiveScreen(contextual))
      {
        message = ContextMessageLiveScreenHelper.AttachLiveScreen(contextual, liveScreen);
        injected = true;
      }

      messages.Add(message);
    }

    messages.Add(new SystemInstructionMessage(SystemInstruction)
    {
      Timestamp = _timestampProvider()
    });

    messages.Reverse();
    return messages;
  }

  private T AppendContextualEntry<T>(T entry) where T : ContextualHistoryEntry
  {
    var finalized = entry with { Timestamp = _timestampProvider() };
    _history.Add(finalized);
    DebugUtil.Print("History", $"Appended {finalized.Role} entry (count={_history.Count})");
    return finalized;
  }

  private static bool ShouldDecorateWithLiveScreen(ContextualHistoryEntry entry)
    => entry.Role is ContextMessageRole.ModelInput or ContextMessageRole.ToolResult;

  private string? BuildLiveScreenSnapshot()
  {
    var context = new WidgetRenderContext(this, ImmutableDictionary<string, object?>.Empty);
    var fragments = _widgets
      .Select(widget => widget.RenderLiveScreen(context))
      .Where(fragment => !string.IsNullOrWhiteSpace(fragment))
      .ToArray();

    if (fragments.Length == 0)
    {
      return null;
    }

    var builder = new StringBuilder();
    builder.AppendLine("# [Live Screen]");
    builder.AppendLine();
    builder.AppendLine(string.Join(Environment.NewLine + Environment.NewLine, fragments));
    return builder.ToString().TrimEnd();
  }

  internal IEnumerable<ITool> EnumerateWidgetTools()
    => _widgets.SelectMany(widget => widget.Tools);
}
```

- **æš‚ç¼“åŠŸèƒ½**ï¼šå†å²å›æ”¾ã€å¿«ç…§æ¢å¤ã€Widget çŠ¶æ€äº‹ä»¶åŒ–ç­‰èƒ½åŠ›è¢«åˆ—å…¥ Deferred èŒƒç•´ï¼Œé¿å…å¹²æ‰°å½“å‰é˜¶æ®µçš„æ ¸å¿ƒå®ç°ã€‚

## å·²å®Œæˆè®¾è®¡ï¼ˆDelivered Scopeï¼‰
### è½åœ°ç»„ä»¶ä¸€è§ˆ
| ç»„ä»¶ | è®¾è®¡ç»“è®º | å®æ–½æŒ‡å¼• |
| --- | --- | --- |
| HistoryEntry ç±»å‹æ— | é‡‡ç”¨ `ContextualHistoryEntry` + `HistoryEntryKind` + `Metadata` çš„ record å±‚çº§ï¼Œæ‰€æœ‰å¯æŠ•å½±åˆ°ä¸Šä¸‹æ–‡çš„äº‹ä»¶ç›´æ¥å®ç° `IContextMessage` | Phase 1 æœŸé—´ç»´æŒ `_conversationHistory` ä¸ `_history` åŒå†™ï¼Œè¯­ä¹‰åŒ–è¿½åŠ å…¥å£è´Ÿè´£æ³¨å…¥æ—¶é—´æˆ³ä¸ DebugUtil æ—¥å¿— |
| ContextMessage æ¥å£æŸ | åŸºç¡€æ¥å£ + è§’è‰²åŒ–æ¥å£ï¼ˆSystem/Input/Output/ToolResultï¼‰+ mix-in èƒ½åŠ›ï¼ˆLiveScreenã€ToolCallã€TokenUsageï¼‰ï¼Œä¿è¯ä¾›åº”å•†æ— å…³æŠ½è±¡ | Provider é€šè¿‡æ¥å£æ£€æµ‹åˆ†æ”¯å¤„ç†ï¼Œæ–°å¢èƒ½åŠ›ä»¥ mix-in æ‰©å±•ä¿æŒå‘åå…¼å®¹ï¼Œç¦æ­¢ç›´æ¥ä¾èµ–å…·ä½“è®°å½•ç±»å‹ |
| ModelInvocationDescriptor ä¸ Tool* ç»“æ„ | `ModelInvocationDescriptor` æè¿° Provider/Specification/Modelï¼Œ`ToolCallRequest` + `ToolCallResult` ç»Ÿä¸€è¡¨è¾¾å·¥å…·è°ƒç”¨åŠæ‰§è¡Œç»“æœ | Provider å®¢æˆ·ç«¯è´Ÿè´£å¡«å…… Invocation ä¸å‚æ•°è§£æï¼ŒOrchestrator åœ¨èšåˆ delta åä¸€æ¬¡æ€§è½ç›˜ï¼Œä¸å·¥å…·æ‰§è¡Œç»“æœé¡ºåºå¯¹é½ |
| ContextMessageLiveScreenHelper | é€šè¿‡è£…é¥°å™¨é™„åŠ  LiveScreen æ–‡æœ¬ï¼Œä¸æ”¹å˜åŸå§‹æ¡ç›®å®ä¾‹ | RenderLiveContext ä»…åœ¨éœ€è¦æ—¶è°ƒç”¨è£…é¥°å™¨ï¼›æ¶ˆè´¹æ–¹éœ€å›é€€è‡³ `ILiveScreenCarrier.InnerMessage` å†è¿›è¡Œè§’è‰²åŒ¹é… |

ä¸Šè¿°ç»„ä»¶æ˜¯å½“å‰è“å›¾å·²ç»å†»ç»“çš„è®¾è®¡æ¨¡å—ï¼Œå¯ç›´æ¥ä½œä¸ºä»£ç å®ç°çš„åŸºçº¿ï¼›å¾… Phase 1 æ”¶å°¾åï¼Œæ—§çš„ `_conversationHistory` å°†è¢«é€æ­¥æ·˜æ±°ã€‚

### æ¥å£å¥‘çº¦
#### AgentState ä¸å†å²å†™å…¥
- AgentState è´Ÿè´£æ³¨å…¥æ—¶é—´æˆ³å¹¶ç»´æŠ¤åªè¯» `History` è§†å›¾ï¼Œå¤–éƒ¨ä¸å¾—ç›´æ¥ä¿®æ”¹ `_history`ï¼›æ‰€æœ‰è¿½åŠ å…¥å£éƒ½ä¼šè§¦å‘ DebugUtil æ—¥å¿—ã€‚
- `ToolCallRequest.RawArguments` æ°¸è¿œä¿ç•™åŸå§‹æ–‡æœ¬ï¼ŒProvider åœ¨å†™å…¥å‰è§£æå¹¶å¡«å…¥ `Arguments`ï¼Œè§£æå¤±è´¥éœ€æŠŠåŸå› å†™å…¥ `ParseError`ã€‚
- `IContextAttachment` åœ¨ Phase 1 å†…å¿…é¡»è¿”å›ç©ºé›†åˆä»¥ç»´æŒæ¥å£ç¨³å®šï¼Œé™„ä»¶ä½“ç³»æ‰©å±•åå°†ç”± AgentState ç»Ÿä¸€ç®¡ç†å†™å…¥ã€‚
- æ¯æ¡ `ModelOutputEntry` å¿…é¡»æºå¸¦éç©ºçš„ `ModelInvocationDescriptor`ï¼Œä¾¿äºåœ¨å†å²å®¡è®¡å’Œæ··åˆæ¨¡å‹ä¼šè¯ä¸­å‡†ç¡®å¤åŸè°ƒç”¨ç¯å¢ƒï¼›ç¼ºå¤±è§†ä¸ºå®ç°ç¼ºé™·ï¼Œåº”é€šè¿‡å•å…ƒæµ‹è¯•é˜»æ–­ã€‚
- åŒå†™é˜¶æ®µè¿½åŠ  `_conversationHistory` ä¸ `_history` æ—¶ï¼Œè‹¥å‘ç”Ÿå†™å…¥å¤±è´¥éœ€ä¿æŒæ—§ç»“æ„ä¸æ–°ç»“æ„çš„ä¸€è‡´æ€§ï¼Œå¿…è¦æ—¶é€šè¿‡äº‹åŠ¡åŒ…è£…æˆ–è¡¥å¿è¿½åŠ é¿å…â€œæ–°æ—§å†å²â€åˆ†å‰ã€‚

#### ContextMessage ä¸ Provider æ¶ˆè´¹
- `IModelOutputMessage.ToolCalls` ä¸æœ€è¿‘çš„ `IToolResultsMessage.Results` éœ€è¦æŒ‰é¡ºåºä¸€ä¸€å¯¹åº”ï¼ŒProvider è´Ÿè´£ä¿è¯é…å¯¹ï¼›è‹¥æ— æ³•è§£æï¼Œå¿…é¡»ä»¥å¤±è´¥çŠ¶æ€çš„ `ToolCallResult` å›å†™ã€‚
- Metadata é”®åéµå¾ªè›‡å½¢å‘½åä¸”å•æ¡é™åˆ¶ 2 KBï¼Œè¶…é™ä¿¡æ¯éœ€è½¬åŒ–ä¸ºé™„ä»¶æˆ–ç‹¬ç«‹æ¡ç›®ï¼›Provider åœ¨è¿½åŠ è¯Šæ–­ä¿¡æ¯æ—¶åŒæ ·éµå®ˆè¯¥çº¦æŸã€‚
- LiveScreen è£…é¥°å™¨å¿…é¡»ä¿æŒ `InnerMessage` ä¸åŸæ¡ç›®ä¸€è‡´ï¼Œæ¶ˆè´¹æ–¹åº”å…ˆè®¿é—® `ILiveScreenCarrier.InnerMessage` å†åšè§’è‰²åŒ–æ¥å£åˆ¤å®šã€‚
- `IContextMessage` ä»…æš´éœ²è§’è‰²ã€æ—¶é—´æˆ³ä¸ Metadataï¼Œæ­£æ–‡è¯­ä¹‰ç”±è§’è‰²åŒ–æ¥å£æä¾›ï¼›Provider é€šè¿‡ `is` æ£€æŸ¥é€‰æ‹©å¤„ç†è·¯å¾„ã€‚
- `ILiveScreenCarrier`ã€`IToolCallCarrier`ã€`ITokenUsageCarrier` ç­‰ mix-in ä¸ºå¯é€‰èƒ½åŠ›ï¼Œæœªå®ç°å³è§†ä¸ºä¸æ”¯æŒç›¸åº”ç‰¹æ€§ã€‚
- Provider å¿…é¡»æŠŠ `Timestamp` è§†ä¸ºåªè¯»æ•°æ®æºï¼šä¸å¾—é‡å†™ã€è¦†ç›–æˆ–é‡æ–°æ’åºï¼›å½“åº•å±‚ SDK æä¾›æ›´ç²¾ç¡®çš„æ—¶é—´æ•°æ®æ—¶ï¼Œåº”é€šè¿‡ Metadata æ–°å¢å­—æ®µï¼Œè€Œéä¿®æ”¹æ—¢æœ‰æ—¶é—´æˆ³ã€‚
- ä»»æ„ Provider æ‰©å±•éƒ½éœ€éªŒè¯ `IContextMessage` åˆ—è¡¨ä¸­çš„æœªçŸ¥è§’è‰²/èƒ½åŠ›èƒ½è¢«å®‰å…¨å¿½ç•¥ï¼Œé˜²æ­¢æœªæ¥æ–°å¢ mix-in æ—¶å‡ºç°è¿è¡Œæ—¶å¼‚å¸¸ã€‚

### å…³é”®ç±»å‹å®šä¹‰
ä»¥ä¸‹å®šä¹‰å±•ç¤ºäº†å½“å‰é˜¶æ®µçš„æ ¸å¿ƒè®°å½•ç±»å‹ä¸æ¥å£ç»„åˆï¼Œä½œä¸ºå®ç°å›¢é˜Ÿçš„ç»“æ„å‚è€ƒï¼š

```csharp
abstract record HistoryEntry {
  public DateTimeOffset Timestamp { get; init; }
  public abstract HistoryEntryKind Kind { get; }
  public ImmutableDictionary<string, object?> Metadata { get; init; }
    = ImmutableDictionary<string, object?>.Empty;
}

abstract record ContextualHistoryEntry : HistoryEntry, IContextMessage {
  public abstract ContextMessageRole Role { get; }
}

record ModelInputEntry(
  IReadOnlyList<KeyValuePair<string, string>> ContentSections
) : ContextualHistoryEntry, IModelInputMessage {
  public override ContextMessageRole Role => ContextMessageRole.ModelInput;
  public override HistoryEntryKind Kind => HistoryEntryKind.ModelInput;
  IReadOnlyList<KeyValuePair<string, string>> IModelInputMessage.ContentSections => ContentSections;
  public IReadOnlyList<IContextAttachment> Attachments { get; init; } = Array.Empty<IContextAttachment>();
}

record ModelOutputEntry(
  string? Thinking,
  IReadOnlyList<string> Contents,
  IReadOnlyList<ToolCallRequest> ToolCalls,
  ModelInvocationDescriptor Invocation
) : ContextualHistoryEntry, IModelOutputMessage, IToolCallCarrier {
  public override ContextMessageRole Role => ContextMessageRole.ModelOutput;
  public override HistoryEntryKind Kind => HistoryEntryKind.ModelOutput;
  IReadOnlyList<string> IModelOutputMessage.Contents => Contents;
  ModelInvocationDescriptor IModelOutputMessage.Invocation => Invocation;
  IReadOnlyList<ToolCallRequest> IToolCallCarrier.ToolCalls => ToolCalls;
}

record ToolResultsEntry(
  IReadOnlyList<ToolCallResult> Results,
  string? ExecuteError
) : ContextualHistoryEntry, IToolResultsMessage {
  public override ContextMessageRole Role => ContextMessageRole.ToolResult;
  public override HistoryEntryKind Kind => HistoryEntryKind.ToolResult;
  string? IToolResultsMessage.ExecuteError => ExecuteError;
}

record ToolCallRequest(
  string ToolName,
  string ToolCallId,
  string RawArguments,
  IReadOnlyDictionary<string, string>? Arguments,
  string? ParseError
);

record ToolCallResult(
  string ToolName,
  string ToolCallId,
  ToolExecutionStatus Status,
  string Result,
  TimeSpan? Elapsed
);

record ModelInvocationDescriptor(
  string ProviderId,
  string Specification,
  string Model
);

record SystemInstructionMessage(
  string Instruction
) : ISystemMessage {
  public ContextMessageRole Role => ContextMessageRole.System;
  public DateTimeOffset Timestamp { get; init; }
  public ImmutableDictionary<string, object?> Metadata { get; init; }
    = ImmutableDictionary<string, object?>.Empty;
}

static class ContextMessageLiveScreenHelper {
  public static IContextMessage AttachLiveScreen(IContextMessage message, string? liveScreen) =>
    string.IsNullOrEmpty(liveScreen)
      ? message
      : new LiveScreenDecoratedMessage(message, liveScreen);

  private sealed record LiveScreenDecoratedMessage(
    IContextMessage Inner,
    string? LiveScreen
  ) : IContextMessage, ILiveScreenCarrier {
    public ContextMessageRole Role => Inner.Role;
    public DateTimeOffset Timestamp => Inner.Timestamp;
    public ImmutableDictionary<string, object?> Metadata => Inner.Metadata;
    string? ILiveScreenCarrier.LiveScreen => LiveScreen;
    IContextMessage ILiveScreenCarrier.InnerMessage => Inner;
  }
}

enum HistoryEntryKind {
  ModelInput,
  ModelOutput,
  ToolResult
  // åç»­å¯æ‰©å±•ï¼šLiveContextSnapshotã€PlannerDirective ç­‰
}

enum ToolExecutionStatus { Success, Failed, Skipped }

record TokenUsage(
  int PromptTokens,
  int CompletionTokens,
  int? CachedPromptTokens
);

interface IContextAttachment { }
```

> å¤‡æ³¨ï¼š`IContextAttachment` ä»ä¸ºç©ºå ä½ï¼Œå¾…é™„ä»¶åè®®æ•²å®šåè¡¥å……å…·ä½“å®ç°ï¼›`HistoryEntryKind` å¯åœ¨æœªæ¥æ‰©å±• LiveContextSnapshotã€PlannerDirective ç­‰æ´¾ç”Ÿç±»å‹ã€‚

### è®¾è®¡éªŒæ”¶å‡†åˆ™
- **HistoryEntry åˆ†å±‚**ï¼šæ‰€æœ‰å¯å†™å…¥æ¡ç›®å‡éœ€é€šè¿‡ AgentState çš„è¯­ä¹‰åŒ–æ–¹æ³•ç”Ÿæˆï¼Œå•å…ƒæµ‹è¯•åº”éªŒè¯è¿½åŠ å `Kind`ã€`Role` ä¸æ—¶é—´æˆ³è¢«æ­£ç¡®æ³¨å…¥ï¼›è‹¥ç›´æ¥å‘ `_history` å†™å…¥è§†ä¸ºè¿èƒŒè®¾è®¡ã€‚
- **ä¸Šä¸‹æ–‡æ¸²æŸ“**ï¼š`RenderLiveContext()` åœ¨ç»™å®šå›ºå®šè¾“å…¥æ—¶å¿…é¡»å…·å¤‡å¹‚ç­‰æ€§ï¼ŒåŒä¸€å†å²é›†åº”ç”Ÿæˆå®Œå…¨ä¸€è‡´çš„ `IContextMessage` åˆ—è¡¨ï¼›éªŒæ”¶ä»¥å¿«ç…§æµ‹è¯•æˆ–è¯­ä¹‰æ¯”è¾ƒæ–­è¨€ä¸ºå‡†ã€‚
- **Provider å¥‘çº¦**ï¼šå®ç° `IProviderClient` çš„ç±»éœ€é€šè¿‡ç»Ÿä¸€å¥‘çº¦æµ‹è¯•ï¼Œè¦†ç›–æ–‡æœ¬å¢é‡ã€å·¥å…·è°ƒç”¨è§£æå¤±è´¥ã€LiveScreen è£…é¥°å›é€€ç­‰åœºæ™¯ï¼›è‹¥ä»»ä¸€åœºæ™¯å¤±è´¥åˆ™è§†ä½œæœªè¾¾æˆè®¾è®¡è¦æ±‚ã€‚
- **ToolCalls é…å¯¹**ï¼š`ModelOutputEntry.ToolCalls` ä¸ `ToolResultsEntry.Results` å¿…é¡»åœ¨å›å†™é˜¶æ®µå®Œæˆä¸€ä¸€å¯¹åº”æ ¡éªŒï¼Œå¹¶åœ¨ Metadata ä¸­è®°å½•å¼‚å¸¸ï¼›éªŒæ”¶æµ‹è¯•éœ€æ¨¡æ‹Ÿå¯¹é½ä¸é”™ä½ä¸¤ç§æƒ…å†µã€‚
- **Widget è®°è´¦**ï¼šWidget å¼•èµ·çš„çŠ¶æ€å˜æ›´ï¼ˆå¦‚ Notebook æ›´æ–°ï¼‰å¿…é¡»èƒ½åœ¨å†å²ä¸­è¿½è¸ªï¼ˆå½“å‰é˜¶æ®µå…è®¸äººå·¥è§¦å‘ï¼‰ï¼ŒéªŒæ”¶æ—¶éœ€æ£€æŸ¥å†å²æ¡ç›®èƒ½å¤Ÿé‡å»ºæœ€æ–° Widget è§†å›¾ã€‚
- **è°ƒè¯•è¾“å‡º**ï¼šå…³é”®å†™å…¥è·¯å¾„éœ€è°ƒç”¨ `DebugUtil` æ‰“ç‚¹ï¼Œå¹¶å…è®¸é€šè¿‡ `ATELIA_DEBUG_CATEGORIES=History` ç²¾ç¡®å¼€å¯ï¼›è‹¥æ–°å¢è·¯å¾„æœªæ‰“ç‚¹é¡»è¡¥é½ã€‚

### å®ç°çº¦æŸä¸æ³¨æ„äº‹é¡¹
- å½“å‰å®ç°ä»ä¸æ—§ `_conversationHistory` å¹¶è¡Œï¼Œéœ€è¦åŒå†™åŒæ­¥ï¼›å®Œæˆ Provider ç®¡çº¿æ”¹é€ åæ–¹å¯ç§»é™¤æ—§ç»“æ„ã€‚
- AgentState å‡å®šè¿è¡Œåœ¨å•çº¿ç¨‹ orchestrator ä¸Šï¼Œæœªåœ¨å†…éƒ¨åŠ é”ï¼›å¦‚éœ€è·¨çº¿ç¨‹å†™å…¥ï¼Œå¿…é¡»ç”±è°ƒç”¨æ–¹æä¾›åŒæ­¥æœºåˆ¶ã€‚
- RenderLiveContext æš‚æœªå®ç°åŸºäº Token çš„æˆªæ–­ç­–ç•¥ï¼Œé•¿å¯¹è¯éœ€ä¾èµ–ä¸Šå±‚ç­–ç•¥æ§åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼›åç»­ç”± Provider æˆ– Router æ ¹æ®é¢„ç®—è£å‰ªã€‚
- ç³»ç»ŸæŒ‡ä»¤ä»ç”±å®¿ä¸»å­—æ®µç»´æŠ¤ï¼Œè®°å¿† Notebook å·²ç”± Widget å°è£…ï¼Œå°šæœªè¿½åŠ å¯¹åº”çš„ HistoryEntryï¼›åœ¨å¼•å…¥ç»Ÿä¸€ Widget äº‹ä»¶æ¨¡å‹å‰éœ€ç”±è°ƒç”¨æ–¹ä¿è¯ä¸€è‡´æ€§ã€‚
- HistoryEntry çš„åºåˆ—å·ã€StableId æš‚ç¼ºçœï¼Œç›¸å…³å­—æ®µéœ€ç­‰å¾…æŒä¹…åŒ–è®¾è®¡è½å®šåç»Ÿä¸€å¼•å…¥ã€‚
- å•å…ƒæµ‹è¯•åœ¨ Phase 1 å†…åº”å›´ç»•è¯­ä¹‰åŒ–è¿½åŠ æ¥å£æ„é€ ç”¨ä¾‹ï¼ˆæ—¶é—´æˆ³æ³¨å…¥ã€ToolCall å¯¹é½ã€LiveScreen è£…é¥°åˆ¤å®šï¼‰ï¼Œå¹¶åˆ©ç”¨ DebugUtil æ—¥å¿—è¾…åŠ©æ’æŸ¥ï¼›å…³äºé¡ºåºå·/å›æ”¾çš„æ–­è¨€å»¶åè‡³æŒä¹…åŒ–é˜¶æ®µå†è¡¥é½ã€‚
- é›†æˆæµ‹è¯•éœ€è¦†ç›–â€œè§„åˆ’æ¨¡å‹ + æ‰§è¡Œæ¨¡å‹â€æ··åˆæµç¨‹ï¼ŒéªŒè¯åŒ Provider åœºæ™¯ä¸‹ HistoryEntry é¡ºåºã€LiveScreen è£…é¥°åŠ ToolResult é…å¯¹å‡ä¿æŒç¨³å®šã€‚
- æ–°å¢ Provider å®ç°å¿…é¡»é€šè¿‡ç»Ÿä¸€çš„å¥‘çº¦æµ‹è¯•å¥—ä»¶ï¼ˆPendingï¼‰ï¼Œè¯¥å¥—ä»¶ä¼šæ¨¡æ‹ŸæœªçŸ¥ mix-inã€ç©ºé™„ä»¶ç­‰è¾¹ç•Œä»¥ç¡®ä¿å‘åå…¼å®¹ã€‚

## å¾…å®šè®¾è®¡ï¼ˆDeferred & TBDï¼‰
### å»¶åå¼•å…¥é¡¹
- **ç¨³å®šæ ‡è¯†ä¸é¡ºåºå·ï¼ˆâ³ï¼‰**
  - ç›®æ ‡ï¼šä¸ºå†å²æ¡ç›®æä¾›è·¨æŒä¹…åŒ–çš„ç¨³å®šå¼•ç”¨ï¼Œå¹¶æ”¯æ’‘å›æ”¾æ’åºä¸å¹‚ç­‰å†™å…¥ã€‚
  - ä¾èµ–ï¼šäº‹ä»¶å­˜å‚¨æˆ–å¿«ç…§æœºåˆ¶è½å®šåï¼Œå†åœ¨ç»Ÿä¸€å…¥å£ç”Ÿæˆ `SequenceNumber`ã€`StableId`ï¼Œå¹¶è¡¥å……è¿ç§»ä¸å›æ”¾æµ‹è¯•ã€‚
  - ç°çŠ¶ï¼šPhase 1-3 å†…ç»§ç»­ä¾èµ–æ—¶é—´æˆ³æ’åºï¼Œè¯­ä¹‰åŒ–è¿½åŠ æ–¹æ³•å·²é¢„ç•™æ³¨å…¥ç‚¹ã€‚
- **ç»“æ„åŒ–é™„ä»¶ä½“ç³»ï¼ˆâ³ï¼‰**
  - ç›®æ ‡ï¼šè®©ä¸Šä¸‹æ–‡æ”¯æŒå¯Œåª’ä½“ã€JSON ç‰‡æ®µç­‰ç»“æ„åŒ–æ•°æ®ï¼Œé¿å…ä½¿ç”¨çº¯æ–‡æœ¬çº¦å®šã€‚
  - çº¦æŸï¼šå½“å‰ `IContextAttachment` è¦æ±‚è¿”å›ç©ºé›†åˆï¼›é™„ä»¶çš„åºåˆ—åŒ–ã€ç¼“å­˜ä¸å­˜å‚¨ç­–ç•¥å°†åœ¨ Phase 4 é›†ä¸­è¯„å®¡ï¼Œå¹¶ä¸å·¥å…·ã€Live Context å…±äº«åè®®ã€‚
- **åŠ¨æ€å·¥å…·æ¸…å•ä¸æç¤ºç”Ÿæˆï¼ˆâ³ï¼‰**
  - æ„¿æ™¯ï¼šæ ¹æ®å®æ—¶å¯ç”¨çš„å·¥å…·ã€å‡½æ•°ç­¾åç”Ÿæˆç²¾å‡†æç¤ºï¼Œæ›¿ä»£é™æ€å†™æ­»çš„å·¥å…·è¯´æ˜ã€‚
  - ä¾èµ–ï¼šéœ€è¦ Planner/Executor åœ¨è¿è¡ŒæœŸå…¬å¼€å·¥å…·æ³¨å†Œä¿¡æ¯ï¼Œå¹¶ç”± Provider Router å†³å®šæ³¨å…¥æ—¶æœºï¼›å¾… Router ç¨³å®šåå†è®¾è®¡ä¸Šä¸‹æ–‡å…¥å£ã€‚
- **Memory Notebook äº‹ä»¶åŒ–ï¼ˆâ³ï¼‰**
  - ç›®æ ‡ï¼šå°† Notebook ç¼–è¾‘æ“ä½œè®°å½•ä¸º `HistoryEntry`ï¼Œæ”¯æŒå®¡è®¡ã€æ’¤é”€ä¸è·¨çº¿ç¨‹åŒæ­¥ã€‚
  - ç°çŠ¶ï¼šPhase 1 ä½¿ç”¨ `MemoryNotebookWidget` ä¿æŒå†…å­˜æ€ï¼Œè°ƒç”¨æ–¹éœ€æ‰‹åŠ¨ä¿è¯ Notebook å†…å®¹ä¸å†å²æè¿°ä¸€è‡´ã€‚
- **Live Context ä¸ History åè°ƒï¼ˆâ³ï¼‰**
  - ç›®æ ‡ï¼šè®°å½•æ¯æ¬¡è°ƒç”¨æ³¨å…¥çš„ Live Context ç‰‡æ®µï¼Œä¾¿äºè°ƒè¯•ä¸å›æ”¾æ—¶æ¯”å¯¹ä¸Šä¸‹æ–‡å·®å¼‚ã€‚
  - çº¦æŸï¼šéœ€è¦ç¡®å®š Live Context çš„æŒä¹…åŒ–ç­–ç•¥ä¸è£å‰ªé€»è¾‘ï¼Œé¿å…å¼•å…¥è¿‡å¤šå†—ä½™æ¡ç›®ï¼›å¾… Provider Router ä¸ Widget ç»Ÿä¸€æ¥å£ç¨³å®šåè¯„ä¼°å®ç°çª—å£ã€‚
- **TokenUsage / è°ƒè¯•é¥æµ‹æ•´åˆï¼ˆâ³ï¼‰**
  - è®®é¢˜ï¼šç»Ÿä¸€ token ç»Ÿè®¡ã€ç¼“å­˜å‘½ä¸­ä¸ DebugUtil è¾“å‡ºï¼Œé¿å…åœ¨ Provider å±‚é‡å¤é‡‡é›†ã€‚
  - ä¾èµ–ï¼šå…¨å±€é¥æµ‹ä¸è®¡è´¹ç­–ç•¥ç¡®å®šè´£ä»»è¾¹ç•Œåï¼Œå†å†³å®šç”± Provider è¿˜æ˜¯ AgentState èšåˆç»Ÿè®¡ã€‚
- **AgentStateSnapshot / Rollback èƒ½åŠ›ï¼ˆâ³ï¼‰**
  - ç›®æ ‡ï¼šæä¾›å†å²å›æº¯ä¸ç¾éš¾æ¢å¤æ‰‹æ®µï¼Œå¹¶æ”¯æŒå¤±è´¥äº‹åŠ¡çš„å›æ»šã€‚
  - è®¡åˆ’ï¼šä¸æŒä¹…åŒ–æ–¹æ¡ˆåŒæ‰¹è¯„å®¡ï¼Œé¢„è®¡ä¸äº‹ä»¶å­˜å‚¨ã€å¿«ç…§å›æ”¾ä¸€å¹¶è®¾è®¡ï¼Œå½“å‰é˜¶æ®µåªä¿ç•™è¿½åŠ å¼æ¥å£ã€‚

### å¾…è¿›ä¸€æ­¥è°ƒç ”çš„é—®é¢˜
- **å¤š Provider æ··åˆä¼šè¯çš„ä¸Šä¸‹æ–‡æˆªæ–­ç­–ç•¥**
  - éœ€è¦æ˜ç¡® Planner/Executor äº¤æ›¿è°ƒç”¨æ—¶çš„ä¸Šä¸‹æ–‡è£å‰ªä¼˜å…ˆçº§ã€ç¼“å­˜å¤ç”¨ä¸å»é‡è§„åˆ™ï¼Œé¿å…é‡å¤ä¼ è¾“å¤§é‡æç¤ºæ–‡æœ¬ã€‚
- **Anthropic å·¥å…·æ¶ˆæ¯å¥‡å¶å¤±é…çš„è‡ªåŠ¨ä¿®å¤**
  - å¾…ç¡®è®¤æ˜¯å¦åœ¨ Provider å±‚è‡ªåŠ¨è¡¥é½å ä½æ¶ˆæ¯ï¼Œæˆ–åœ¨ Orchestrator å¼•å…¥é‡è¯•/å›é€€ç­–ç•¥ï¼Œä»è€Œå‡å°‘äººå·¥ä»‹å…¥ã€‚
- **äº‹ä»¶å›æ”¾è½åœ°åå¯¹ AgentState API çš„å½±å“**
  - éœ€è¯„ä¼°è¯­ä¹‰åŒ–è¿½åŠ æ¥å£æ˜¯å¦è¦æ”¯æŒäº‹åŠ¡åŒ…è£…ã€ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œä»¥åŠå¦‚ä½•ä¸ DebugUtilã€å¿«ç…§æœºåˆ¶ååŒã€‚
- **Memory Notebook v2 çš„è€¦åˆæ¨¡å¼**
  - éœ€è¦å®šä¹‰ Notebook æ‘˜è¦å¦‚ä½•è¿›å…¥ä¸Šä¸‹æ–‡ã€å†²çªå¦‚ä½•è§£å†³ï¼Œä»¥åŠ Notebook æ¡ç›®ä¸å†å²äº‹ä»¶ä¹‹é—´çš„é“¾æ¥å½¢å¼ã€‚
- **Tool å‚æ•°è§£æä¸€è‡´æ€§ç­–ç•¥**
  - éœ€è¦è¯„ä¼°æ˜¯å¦åœ¨ Provider å±‚å»ºç«‹ç»Ÿä¸€çš„ `ToolArgumentParser` è§„åˆ™åº“ï¼Œæˆ–å…è®¸å·¥å…·ä½œè€…æä¾›è‡ªæè¿° schemaï¼›è¯¥å†³å®šå°†å½±å“ `ToolCallRequest.Arguments` çš„ç¨³å®šæ€§ä¸å‘åå…¼å®¹æ€§ã€‚

## ä¸å®æ–½è·¯çº¿å›¾çš„å…³ç³»
- è·¯çº¿å›¾çš„ Phase è§„åˆ’ä»¥æœ¬è“å›¾çš„è®¾è®¡ä¸»é¢˜ä¸ºè¾¹ç•Œï¼šPhase 1 è¦†ç›– HistoryEntry ä¸æ ¸å¿ƒæ¥å£ï¼ŒPhase 2/3 å¤„ç† Provider ç®¡çº¿ï¼ŒPhase 4 èšç„¦å»¶åå¼•å…¥é¡¹ã€‚
- å½“ Roadmap è°ƒæ•´é˜¶æ®µç›®æ ‡æˆ–é‡Œç¨‹ç¢‘æ—¶ï¼Œéœ€åœ¨æœ¬è“å›¾çš„â€œè®¾è®¡çŠ¶æ€æ€»è§ˆâ€åŒæ­¥çŠ¶æ€ï¼Œå¹¶åœ¨å¯¹åº”ç« èŠ‚æ›´æ–°å‡è®¾/çº¦æŸã€‚
- è“å›¾ä¸å†åˆ—å‡ºå…·ä½“ä»»åŠ¡é¡ºåºï¼Œç›¸å…³å†…å®¹ç»Ÿä¸€è¿ç§»è‡³è·¯çº¿å›¾ä¸å·¥ç¨‹ä»»åŠ¡åˆ—è¡¨ã€‚

## æœ¯è¯­ä¸å‚è€ƒèµ„æ–™
- **AgentState**ï¼šç®¡ç†å¯¹è¯å†å²ä¸è¿è¡Œæ—¶çŠ¶æ€çš„èšåˆå¯¹è±¡ï¼Œæ˜¯ Conversation History çš„å”¯ä¸€äº‹å®æ¥æºã€‚
- **Widget**ï¼šå°è£…è¿è¡Œæ€çŠ¶æ€ã€å·¥å…·é›†åˆä¸ LiveScreen å‘ˆç°çš„ç»„ä»¶ï¼Œç›®å‰åŒ…å« `MemoryNotebookWidget`ï¼Œæœªæ¥å°†æ‰©å±•æ›´å¤šèƒ½åŠ›ã€‚
- **LiveInfoï¼ˆLegacyï¼‰**ï¼šæ—§ç‰ˆæœ¬å¯¹è¿è¡Œæ€å¿«ç…§çš„ç§°è°“ï¼Œç°å·²ç”± Widget ä½“ç³»æ¥æ‰‹å…¶èŒè´£ã€‚
- **LiveScreen**ï¼šåœ¨ä¸Šä¸‹æ–‡ä¸­æš‚æ—¶å±•ç¤ºçš„é«˜ä¼˜å…ˆçº§ä¿¡æ¯ï¼Œé€šè¿‡è£…é¥°å™¨é™„åŠ åœ¨æœ€è¿‘çš„ä¸Šä¸‹æ–‡æ¡ç›®ä¸Šã€‚
- **Provider Router**ï¼šæ ¹æ®ç­–ç•¥é€‰æ‹©åº•å±‚æ¨¡å‹ä¾›åº”å•†çš„è°ƒåº¦å±‚ï¼Œæ ‡å‡†æ¥å£ä¸º `IProviderClient`ã€‚
- **ModelOutputDelta**ï¼šä¾›åº”å•†è¿”å›çš„æµå¼å¢é‡ç»Ÿä¸€è¡¨ç¤ºï¼Œæœ€ç»ˆæ±‡æ€»ä¸º `ModelOutputEntry`ã€‚
- **ModelInvocationDescriptor**ï¼šè®°å½• Provider/Specification/Model ä¸‰å…ƒç»„ï¼Œç”¨äºå›æº¯æ¨¡å‹é€‰æ‹©ä¸Šä¸‹æ–‡ã€‚
- **ToolCallRequest / ToolCallResult**ï¼šæ¨¡å‹è¾“å‡ºçš„å·¥å…·è°ƒç”¨å£°æ˜ä¸æ‰§è¡Œç»“æœï¼Œå‰è€…ä¿ç•™åŸå§‹å‚æ•°æ–‡æœ¬ï¼Œåè€…è®°å½•æ‰§è¡ŒçŠ¶æ€ä¸è€—æ—¶ã€‚
- å‚è€ƒæ–‡æ¡£ï¼š
  - ã€ŠMemo: Conversation History æŠ½è±¡é‡æ„å®æ–½è·¯çº¿å›¾ã€‹V2ï¼ˆç­¹å¤‡ä¸­ï¼‰
  - ã€ŠAtelia_Naming_Convention.mdã€‹
  - ã€ŠAGENTS.mdã€‹ä¸­ DebugUtil ç« èŠ‚

---

## é‡æ„è¿›åº¦è¿½è¸ª
### æœ¬è½®æ›´æ–°
- 2025-10-13ï¼š**è®¾è®¡çŠ¶æ€æ€»è§ˆæ›´æ–°**ï¼Œæ ¹æ® LiveContextProto å®é™…ä»£ç è¿›åº¦åŒæ­¥çŠ¶æ€æ ‡è®°ï¼šAgentState å†å²å±‚æŠ½è±¡ã€ContextMessage æ¥å£æŸã€Context æ¸²æŸ“/æŠ•å½±ã€Provider æŠ½è±¡ä¸è·¯ç”±ã€AgentState è¯­ä¹‰åŒ–è¿½åŠ  API å·²å…¨éƒ¨æ ‡è®°ä¸º âœ…ï¼ˆå·²å®Œæˆå¹¶éªŒè¯ï¼‰ï¼›Widget ä½“ç³»ä¸é™„åŠ èƒ½åŠ›ã€è¯Šæ–­ä¸å…ƒæ•°æ®ç­–ç•¥å‡çº§ä¸º ğŸ› ï¸ï¼ˆåŸºç¡€åŠŸèƒ½å·²å®ç°ï¼Œæ‰©å±•åŠŸèƒ½å¾…è¡¥å……ï¼‰ã€‚ä¸è·¯çº¿å›¾ Phase 2 å®Œæˆã€Phase 3 è¿›è¡Œä¸­çš„å®é™…è¿›åº¦ä¿æŒä¸€è‡´ã€‚
- 2025-10-12ï¼šä¿®æ­£"è®¾è®¡çŠ¶æ€æ€»è§ˆ"ä¸­ ContextMessage ç« èŠ‚é”šç‚¹ï¼Œæ¢å¤çŠ¶æ€è¡¨ä¸æ­£æ–‡ä¹‹é—´çš„è·³è½¬ä¸€è‡´æ€§ã€‚
- 2025-10-12ï¼šä¸º Provider å®¢æˆ·ç«¯ä¸ AgentState ç« èŠ‚è¡¥å……çŠ¶æ€æ ‡è¯†ä¸ç›®å½•æ ‡æ³¨ï¼Œä½¿è“å›¾ä¸»ä½“ä¸"è®¾è®¡çŠ¶æ€æ€»è§ˆ"ä¿æŒä¸€è‡´çš„æˆç†Ÿåº¦æç¤ºã€‚
- å¯¹ç…§ V1 è“å›¾è¡¥å†™"Event Sourcing""CQRS ä¸ Repository""Strategy + Adapter"ç« èŠ‚ï¼Œæ˜ç¡®äº‹ä»¶è¯­ä¹‰ã€è¯»å†™åˆ†ç¦»ä¸ä¾›åº”å•†é€‚é…æµç¨‹ã€‚
- å°† DebugUtil æ‰“ç‚¹ã€`IClock` æ³¨å…¥ã€ç­–ç•¥è·¯ç”±ç­‰ç»†èŠ‚æ˜¾å¼å†™å…¥è®¾è®¡æ¨¡å¼ç« èŠ‚ï¼Œä¾¿äºå®ç°å›¢é˜Ÿç›´æ¥å¼•ç”¨ã€‚

### æ—¢å¾€é‡Œç¨‹ç¢‘
- 2025-10-12ï¼ˆç¬¬ 1 è½®ï¼‰ï¼šæ–°å¢"ä¸ V1 è“å›¾çš„å·®å¼‚å¯¹ç…§"è¡¨ã€è¡¥å……è®¾è®¡éªŒæ”¶å‡†åˆ™ï¼Œå¹¶å®Œæˆç›®å½•ä¸çŠ¶æ€æ ‡è¯†çš„ç»Ÿä¸€æ•´ç†ã€‚

### ä¸‹ä¸€æ­¥è®¡åˆ’
- åœ¨ Phase 3 å®Œæ•´éªŒæ”¶åï¼Œè¯„ä¼°çœŸå® Providerï¼ˆOpenAI/Anthropicï¼‰æ¥å…¥çš„å‡†å¤‡å·¥ä½œï¼Œè¡¥å……è·¨ä¾›åº”å•†å…¼å®¹æ€§æµ‹è¯•ç”¨ä¾‹ã€‚
- æ¢³ç† Deferred é¡¹ï¼ˆå°¤å…¶æ˜¯ Widget äº‹ä»¶åŒ–ã€é™„ä»¶ä½“ç³»ã€åŠ¨æ€å·¥å…· manifestï¼‰çš„è®¾è®¡å‰ç½®æ¡ä»¶ï¼Œå‡†å¤‡ Phase 4 æ‰€éœ€çš„å¾…åŠåˆ—è¡¨ã€‚
- å®šæœŸæ ¡éªŒè“å›¾ä¸è·¯çº¿å›¾çš„çŠ¶æ€æ€»è§ˆä¸€è‡´æ€§ï¼Œç¡®ä¿è®¾è®¡çœŸç›¸æºä¸å®æ–½è¿›åº¦åŒæ­¥æ›´æ–°ã€‚
