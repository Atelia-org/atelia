# Agent Memory Editing Architecture
## è®¾è®¡æ–‡æ¡£ v0.1
**ä½œè€…**: Atelia Team
**æ—¥æœŸ**: 2025-10-08
**çŠ¶æ€**: Draft / Discussion

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£å®šä¹‰äº†ä¸€å¥—é¢å‘ LLM Agent çš„**è®¤çŸ¥å‹å¥½å‹ç¼–è¾‘æ¶æ„**ï¼Œæ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬ï¼š
- **ç¼–è¾‘çŠ¶æ€ç®¡ç†**ï¼šæ˜¾å¼çš„ idle/editing/committed çŠ¶æ€æœº
- **é¢„è§ˆé©±åŠ¨äº¤äº’**ï¼šæ¯æ¬¡ç¼–è¾‘ç«‹å³æ¸²æŸ“ diffï¼Œå»¶è¿Ÿæäº¤
- **é€’å½’ä»»åŠ¡æ ˆ**ï¼šæ”¯æŒåµŒå¥—å­ä»»åŠ¡ï¼Œè‡ªåŠ¨å‹ç¼©å†å²ï¼Œæ„å»ºæ€ç»´æ ‘
- **å­—æ¯ç´¢å¼•**ï¼šç”¨ A/B/C ä»£æ›¿æ•°å­—ï¼Œé¿å… 0/1-based æ··æ·†
- **è®°å¿†å‹ç¼©**ï¼šcommit/revert æ—¶æŠ˜å ä¸­é—´æ­¥éª¤ï¼Œåªä¿ç•™æ‘˜è¦

---

## 1. æ ¸å¿ƒåŠ¨æœº

### 1.1 å½“å‰ç—›ç‚¹
- **æ— çŠ¶æ€ç¼–è¾‘**ï¼šæ¯æ¬¡ tool call ç«‹å³ç”Ÿæ•ˆï¼Œæ— æ³•é¢„è§ˆ/æ’¤é”€
- **ä¸Šä¸‹æ–‡è†¨èƒ€**ï¼šæ‰€æœ‰ç¼–è¾‘ç»†èŠ‚éƒ½ç•™åœ¨ chat historyï¼Œå¹²æ‰°åç»­æ¨ç†
- **è®¤çŸ¥è´Ÿè·é«˜**ï¼šLLM éœ€è¦æ‰‹åŠ¨è¿½è¸ª"æˆ‘åœ¨ç¬¬å‡ æ­¥"ã€"å°è¯•è¿‡ä»€ä¹ˆ"
- **é”™è¯¯æˆæœ¬å¤§**ï¼šä¸€æ—¦æ›¿æ¢é”™è¯¯ï¼Œåªèƒ½é‡æ–° memo_read å†æ“ä½œ

### 1.2 è®¾è®¡ç›®æ ‡
- **å¯é€†æ€§**ï¼šä»»ä½•ç¼–è¾‘åœ¨ commit å‰éƒ½å¯æ’¤é”€
- **é€æ˜æ€§**ï¼šLLM å§‹ç»ˆèƒ½çœ‹åˆ°"å½“å‰çŠ¶æ€ + å¾…å®šå˜æ›´"
- **è½»é‡çº§**ï¼šå‹ç¼©å†å²åçš„ token æˆæœ¬æ¥è¿‘"ç›´æ¥ç¼–è¾‘"
- **é€’å½’æ€§**ï¼šæ”¯æŒ"ç¼–è¾‘è¿‡ç¨‹ä¸­å‘ç°éœ€è¦å…ˆå®Œæˆå­ä»»åŠ¡"çš„è‡ªç„¶æµç¨‹

---

## 2. çŠ¶æ€æœºè®¾è®¡

### 2.1 ç¼–è¾‘ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Idle
    Idle --> Editing: é¦–æ¬¡ç¼–è¾‘ tool call
  Editing --> Editing: ç»§ç»­ç¼–è¾‘/é¢„è§ˆ
  Editing --> Idle: memo_commit(summary)
  Editing --> Idle: memo_revert(reason)
  Editing --> Editing: è¿›å…¥å­ä»»åŠ¡
  Editing --> Editing: å­ä»»åŠ¡ç»“æŸ
```

### 2.2 çŠ¶æ€å®šä¹‰

#### Idleï¼ˆç©ºé—²ï¼‰
- **è®°å¿†å†…å®¹**ï¼šæœ€åä¸€æ¬¡ committed çš„ç‰ˆæœ¬
- **å¯è§è§†å›¾**ï¼šå®Œæ•´è®°å¿†æ–‡æœ¬ï¼ˆå¯é€‰å¸¦è¡Œå·ï¼‰
- **å¯ç”¨æ“ä½œ**ï¼šmemo_read, memo_replace_*, memo_append

#### Editingï¼ˆç¼–è¾‘ä¸­ï¼‰
- **è®°å¿†å†…å®¹**ï¼šbase ç‰ˆæœ¬ + pending changes é˜Ÿåˆ—
- **å¯è§è§†å›¾**ï¼š
  ```
  ğŸ“ ç¼–è¾‘ä¼šè¯ #3 (è¿›è¡Œä¸­)
  åŸºå‡†ç‰ˆæœ¬: 1234 å­—ç¬¦

  å¾…å®šå˜æ›´ï¼š
  [A] æ›¿æ¢ "æ—§æ–‡æœ¬" â†’ "æ–°æ–‡æœ¬" (ä½ç½® 234, +12 å­—ç¬¦)
  [B] åˆ é™¤ "è¿‡æ—¶ç« èŠ‚" (ä½ç½® 567, -89 å­—ç¬¦)

  é¢„è§ˆ (ä»…æ˜¾ç¤ºå˜æ›´é™„è¿‘):
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   220â”‚ ## æ ¸å¿ƒåŠŸèƒ½
   221â”‚ - æ—§æ–‡æœ¬æ–°æ–‡æœ¬
   222â”‚ - å…¶ä»–å†…å®¹
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   560â”‚
   561â”‚ [å·²åˆ é™¤ 89 å­—ç¬¦]
   562â”‚
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ğŸ’¡ ä½¿ç”¨ memo_commit("å®ŒæˆåŠŸèƒ½æè¿°æ›´æ–°") æäº¤
     æˆ– memo_revert("å‘ç°é€»è¾‘é”™è¯¯") æ’¤é”€
  ```
- **å¯ç”¨æ“ä½œ**ï¼šç»§ç»­ç¼–è¾‘ã€memo_commitã€memo_revertã€memo_preview

#### ç¦»å¼€ Editing æ—¶çš„åŠ¨ä½œ
- `memo_commit(summary: string)`
  1. åº”ç”¨æ‰€æœ‰ pending changes åˆ°è®°å¿†ï¼ˆæŒä¹…åŒ–ä¸ºæ–°çš„åŸºçº¿ï¼‰
  2. å‹ç¼© chat historyï¼šåˆ é™¤ç¼–è¾‘æœŸé—´çš„ tool call/result
  3. æ’å…¥ä¸€æ¡æ‘˜è¦æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š
     ```
     [ç¼–è¾‘ä¼šè¯ #3 å·²æäº¤]
     æ‘˜è¦: å®ŒæˆåŠŸèƒ½æè¿°æ›´æ–°
     å˜æ›´: 2 å¤„æ›¿æ¢, +45 å­—ç¬¦
     ```
- `memo_revert(reason: string)`
  1. ä¸¢å¼ƒæ‰€æœ‰ pending changesï¼Œå›å¤åˆ°è¿›å…¥ Editing å‰çš„åŸºçº¿
  2. å‹ç¼© chat history
  3. æ’å…¥ä¸€æ¡æ‘˜è¦ï¼Œä¾‹å¦‚ï¼š
     ```
     [ç¼–è¾‘ä¼šè¯ #3 å·²æ’¤é”€]
     åŸå› : å‘ç°é€»è¾‘é”™è¯¯ï¼Œéœ€è¦é‡æ–°è°ƒç ”
     ```

---

## 3. é¢„è§ˆä¸ç´¢å¼•ç³»ç»Ÿ

### 3.1 å­—æ¯ç´¢å¼•è®¾è®¡
- **åŒ¹é…å€™é€‰**ï¼šé»˜è®¤å±•ç¤ºå‰ 5 ä¸ªå€™é€‰å¹¶ç”¨ A-E æ ‡è®°ï¼›å¦‚éœ€æŸ¥çœ‹æ›´å¤šï¼Œå¯é€šè¿‡ `show_all_matches` ä¹‹ç±»çš„å‚æ•°å»¶ä¼¸åˆ°å‰©ä½™å­—æ¯ï¼ˆæœ€å¤š 26 ä¸ªï¼‰
- **å¾…å®šå˜æ›´**ï¼šA-Zï¼ˆæ¯ä¸ªç¼–è¾‘ä¼šè¯æœ€å¤š 26 ä¸ªæ“ä½œï¼Œå¯¹åº”å¾…å®šå˜æ›´åˆ—è¡¨ï¼‰
- **ä¼˜ç‚¹**ï¼š
  - æ—  0/1-based æ­§ä¹‰
  - è§†è§‰åŒºåˆ†åº¦é«˜
  - æ˜“äºè¯­éŸ³/æ‰‹å†™è¾“å…¥

**ç¤ºä¾‹äº¤äº’**ï¼š
```
Tool: memory_notebook_replace
Args: { "old_text": "result = 0", "new_text": "result = initial" }

è¿”å›ï¼š
æ‰¾åˆ° 3 ä¸ªåŒ¹é…ï¼š
[A] ç¬¬ 23 è¡Œï¼švoid Init() { int result = 0; }
[B] ç¬¬ 67 è¡Œï¼švoid Process() { int result = 0; } â† æ¨è
[C] ç¬¬ 102 è¡Œï¼švoid Test() { int result = 0; }

è¯·æ·»åŠ  match_id: "B" ç¡®è®¤é€‰æ‹©
æˆ–ä½¿ç”¨ memo_commit_auto è®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æ¨èé¡¹
```

> é»˜è®¤åªå±•ç¤ºå‰ 5 ä¸ªå€™é€‰ï¼ˆA-Eï¼‰ã€‚è‹¥æç¤ºâ€œè¿˜æœ‰ X ä¸ªæœªæ˜¾ç¤ºâ€ï¼Œå¯ä»¥è¿½åŠ  `show_all_matches=true` æˆ–æ›´å…·ä½“çš„é”šç‚¹å‚æ•°è·å–å‰©ä½™æ¡ç›®ã€‚

### 3.2 Diff æ¸²æŸ“è§„åˆ™
- **ç®€æ´æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**ï¼šåªæ˜¾ç¤ºå˜æ›´å‰åå„ 3 è¡Œ
- **å®Œæ•´æ¨¡å¼**ï¼šæ˜¾ç¤ºæ•´ä¸ªå˜æ›´åŒºåŸŸ
- **ç»Ÿè®¡æ¨¡å¼**ï¼šåªæ˜¾ç¤º `+N/-M å­—ç¬¦` å’Œä½ç½®

**å¯é…ç½®å‚æ•°**ï¼š
```json
{
  "preview_mode": "compact",  // compact | full | stats
  "context_lines": 3,
  "max_preview_length": 500
}
```

---

## 4. é€’å½’ä»»åŠ¡æ ˆ

### 4.1 æ ¸å¿ƒæ¦‚å¿µ
- **ä»»åŠ¡ (Task)**ï¼šä¸€ä¸ªå¸¦ç›®æ ‡çš„å·¥ä½œå•å…ƒï¼ˆå¦‚"ä¿®æ”¹é…ç½®æ–‡ä»¶"ï¼‰
- **ä»»åŠ¡æ ˆ**ï¼šå½“å‰æ´»è·ƒä»»åŠ¡çš„å±‚çº§ç»“æ„
- **æ€ç»´æ ‘**ï¼šå·²å®Œæˆä»»åŠ¡çš„æ‘˜è¦æ ‘ï¼Œç”¨äºå»ºç«‹"æˆ‘åšè¿‡ä»€ä¹ˆ"çš„æ•´ä½“å°è±¡

### 4.2 ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

```
å¼€å§‹ä»»åŠ¡ï¼šmemo_begin_task("ä¿®æ”¹é…ç½®ä»¥å¯ç”¨æ–°åŠŸèƒ½")
  â†“
æ‰§è¡Œç¼–è¾‘ï¼šmemory_notebook_replace(...)
  â†“
å‘ç°ä¾èµ–ï¼šmemo_begin_task("å…ˆæ£€æŸ¥ä¾èµ–ç‰ˆæœ¬")  â† åµŒå¥—
    â†“
  è§£å†³ä¾èµ–ï¼šmemory_notebook_replace(...)
    â†“
  ç»“æŸå­ä»»åŠ¡ï¼šmemo_commit("ä¾èµ–ç‰ˆæœ¬å·²æ›´æ–°")  â† pop å­ä»»åŠ¡
  â†“
ç»§ç»­ä¸»ä»»åŠ¡ï¼šmemory_notebook_replace(...)
  â†“
å®Œæˆä¸»ä»»åŠ¡ï¼šmemo_commit("æ–°åŠŸèƒ½é…ç½®å®Œæˆ")  â† pop ä¸»ä»»åŠ¡
```

### 4.3 æ€ç»´æ ‘å¯è§†åŒ–

**å®æ—¶è§†å›¾ï¼ˆæ¸²æŸ“åœ¨æ¯æ¬¡ user æ¶ˆæ¯ä¸­ï¼‰**ï¼š
```
ğŸ“Š å½“å‰ä»»åŠ¡æ ˆï¼š
â”Œâ”€ [ä¸»ä»»åŠ¡] ä¿®æ”¹é…ç½®ä»¥å¯ç”¨æ–°åŠŸèƒ½ (è¿›è¡Œä¸­)
â”‚   â”œâ”€ âœ… æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬ â†’ ä¾èµ–ç‰ˆæœ¬å·²æ›´æ–°
â”‚   â”œâ”€ ğŸ“ æ›´æ–°é…ç½®å‚æ•° (å½“å‰)
â”‚   â””â”€ â³ ç¼–å†™æ–‡æ¡£ (å¾…åŠ)
â””â”€ (æ ˆæ·±åº¦: 1)

ğŸŒ³ å·²å®Œæˆä»»åŠ¡æ ‘ï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰ï¼š
- âœ… è°ƒç ”ç°æœ‰æ–¹æ¡ˆ
  â”œâ”€ âœ… é˜…è¯»æ–‡æ¡£ A
  â””â”€ âœ… é˜…è¯»æ–‡æ¡£ B
- ğŸ“ ä¿®æ”¹é…ç½®ä»¥å¯ç”¨æ–°åŠŸèƒ½ (å½“å‰)
```

### 4.4 å†å²å‹ç¼©ç­–ç•¥

**å‹ç¼©å‰**ï¼ˆchat historyï¼Œ~5000 tokensï¼‰ï¼š
```
User: è¯·ä¿®æ”¹é…ç½®
Assistant: æˆ‘å…ˆæ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
Tool: memo_read
Result: [å®Œæ•´é…ç½®æ–‡ä»¶ 2000 å­—ç¬¦]
Tool: memory_notebook_replace(...)
Result: æ‰¾åˆ° 3 ä¸ªåŒ¹é…...
Tool: memory_notebook_replace(match_id="B")
Result: é¢„è§ˆ: ...
Tool: memo_commit("ä¾èµ–ç‰ˆæœ¬å·²æ›´æ–°")
Result: å·²æäº¤
Assistant: ç°åœ¨æ›´æ–°é…ç½®å‚æ•°
Tool: memory_notebook_replace(...)
...
```

**å‹ç¼©å**ï¼ˆ~200 tokensï¼‰ï¼š
```
User: è¯·ä¿®æ”¹é…ç½®
[ä»»åŠ¡: ä¿®æ”¹é…ç½®ä»¥å¯ç”¨æ–°åŠŸèƒ½]
  â”œâ”€ âœ… æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬ â†’ ä¾èµ–ç‰ˆæœ¬å·²æ›´æ–°
  â””â”€ ğŸ“ æ›´æ–°é…ç½®å‚æ•° (å½“å‰é¢„è§ˆ)
      å˜æ›´ [A]: æ›¿æ¢ "old" â†’ "new" (ä½ç½® 234)

ğŸ’¡ ä½¿ç”¨ memo_commit æˆ– memo_revert ç»§ç»­
```

---

## 5. å·¥å…·æ¥å£è®¾è®¡

### 5.1 æ–°å¢å·¥å…·

#### `memo_begin_task(goal: string, parent_task_id?: string)`
- **åŠŸèƒ½**ï¼šå¼€å§‹ä¸€ä¸ªæ–°ä»»åŠ¡ï¼Œå‹å…¥ä»»åŠ¡æ ˆ
- **è¿”å›**ï¼šä»»åŠ¡ ID + æ›´æ–°åçš„ä»»åŠ¡æ ˆè§†å›¾
- **å‰¯ä½œç”¨**ï¼šåœ¨ chat history æ’å…¥ä»»åŠ¡èŠ‚ç‚¹æ ‡è®°

#### `memo_commit(summary: string, auto_pop_task?: bool)`
- **åŠŸèƒ½**ï¼šæäº¤å½“å‰ç¼–è¾‘ä¼šè¯
- **å‚æ•°**ï¼š
  - `summary`ï¼šäººç±»å¯è¯»çš„å˜æ›´æ‘˜è¦
  - `auto_pop_task`ï¼šæ˜¯å¦åŒæ—¶ç»“æŸå½“å‰ä»»åŠ¡ï¼ˆé»˜è®¤ trueï¼‰
- **è¿”å›**ï¼šæäº¤ç¡®è®¤ + æ›´æ–°åçš„è®°å¿†é•¿åº¦
- **å‰¯ä½œç”¨**ï¼šå‹ç¼© historyï¼Œæ›´æ–°ä»»åŠ¡æ ‘

#### `memo_revert(reason: string)`
- **åŠŸèƒ½**ï¼šæ’¤é”€å½“å‰ç¼–è¾‘ä¼šè¯
- **è¿”å›**ï¼šæ’¤é”€ç¡®è®¤
- **å‰¯ä½œç”¨**ï¼šå‹ç¼© historyï¼Œä»»åŠ¡çŠ¶æ€æ ‡è®°ä¸ºå¤±è´¥

#### `memo_preview(format?: "compact" | "full" | "diff")`
- **åŠŸèƒ½**ï¼šæŸ¥çœ‹å½“å‰å¾…å®šå˜æ›´çš„é¢„è§ˆ
- **è¿”å›**ï¼šæ ¼å¼åŒ–çš„ diff è§†å›¾

#### `memo_commit_auto()`
- **åŠŸèƒ½**ï¼šè‡ªåŠ¨æäº¤ï¼Œä½¿ç”¨é»˜è®¤æ‘˜è¦ï¼ˆåŸºäºå˜æ›´å†…å®¹ç”Ÿæˆï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼šç®€å•çš„å•æ­¥ç¼–è¾‘

### 5.2 ä¿®æ”¹ç°æœ‰å·¥å…·

#### `memory_notebook_replace / memory_notebook_replace_span`
- **æ–°å¢å‚æ•°**ï¼š
  - `match_id?: string`ï¼šå­—æ¯ç´¢å¼•ï¼ˆA-Zï¼‰
  - `preview_only?: bool`ï¼šä»…é¢„è§ˆä¸è¿›å…¥ç¼–è¾‘çŠ¶æ€
- **è¿”å›è¡Œä¸º**ï¼š
  - å¤šåŒ¹é…æ—¶ï¼šè¿”å›å¸¦å­—æ¯ç´¢å¼•çš„å€™é€‰åˆ—è¡¨ + è¿›å…¥ç¼–è¾‘çŠ¶æ€
  - å•åŒ¹é…æ—¶ï¼šç›´æ¥è¿›å…¥ç¼–è¾‘çŠ¶æ€ + æ˜¾ç¤ºé¢„è§ˆ
  - `preview_only=true`ï¼šä»…è¿”å›é¢„è§ˆï¼Œä¸æ”¹å˜çŠ¶æ€

### 5.3 è¯·æ±‚ / å“åº”ç¤ºä¾‹

**æŸ¥æ‰¾å¹¶è¿›å…¥ç¼–è¾‘çŠ¶æ€**

è¯·æ±‚ï¼š
```json
{
  "old_text": "\"experimental\": []",
  "new_text": "\"experimental\": [\"X\"]",
  "search_after": "\"features\": {"
}
```

å“åº”ï¼ˆè£å‰ªåçš„å…³é”®å­—æ®µï¼‰ï¼š
```json
{
  "status": "editing",
  "session_id": "sess-1742",
  "pending_changes": [
    {
      "change_id": "A",
      "position": 567,
      "preview": "\n  567|-    \"experimental\": []\n  567|+    \"experimental\": [\"X\"]\n"
    }
  ],
  "next_actions": [
    "memo_commit(summary)",
    "memo_revert(reason)",
    "memory_notebook_replace(..., match_id)"
  ]
}
```

**å¤šåŒ¹é…æ—¶çš„å€™é€‰è¿”å›**

```json
{
  "status": "needs_match",
  "candidates": [
    { "match_id": "A", "line": 12, "context": "database.timeout: 30" },
    { "match_id": "B", "line": 45, "context": "api.timeout: 30", "recommended": true },
    { "match_id": "C", "line": 78, "context": "cache.timeout: 30" }
  ],
  "hint": "é»˜è®¤å±•ç¤ºå‰ 5 é¡¹ï¼Œå¦‚éœ€æ›´å¤šè¯·è®¾ç½® show_all_matches=true"
}
```

**æäº¤ç¼–è¾‘**

è¯·æ±‚ï¼š
```json
{
  "session_id": "sess-1742",
  "summary": "å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X"
}
```

å“åº”ï¼š
```json
{
  "status": "committed",
  "summary": "å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X",
  "applied_changes": 1,
  "new_length": 1239,
  "history_delta": { "messages_removed": 4, "tokens_saved": 2500 }
}
```

### 5.4 ä¸ç°æœ‰ TextReplacementEngine çš„è¡”æ¥
- `TextReplacementEngine.Execute` ç»§ç»­è´Ÿè´£è¡Œæ–‡æœ¬æŸ¥æ‰¾ä¸æ›¿æ¢ï¼Œåªéœ€æ‰©å±• `ReplacementRequest` ç»“æ„ä»¥æºå¸¦ `match_id`ï¼ˆæˆ– `anchor_occurrence`ï¼‰ã€‚
- æ–°çš„ç¼–è¾‘çŠ¶æ€ç”±å¤–å±‚çš„ `EditingSession` ç®¡ç†ï¼›`Execute` è¿”å›çš„æ–‡æœ¬ä¸å†ç›´æ¥å†™å›è®°å¿†ï¼Œè€Œæ˜¯ä½œä¸º pending change ç¼“å­˜ã€‚
- `memo_commit` æ—¶å†è°ƒç”¨ä¸€æ¬¡ `TextReplacementEngine`ï¼Œä»¥ `IsAppend=false`ã€å¸¦å®šä½ä¿¡æ¯çš„æ–¹å¼æ‰¹é‡åº”ç”¨æ‰€æœ‰ `PendingChange`ï¼Œä»è€Œå¤ç”¨ç°æœ‰çš„æŸ¥æ‰¾/æ›¿æ¢é€»è¾‘ã€‚
- `memo_preview` å¯ä»¥ç›´æ¥è°ƒç”¨ `Execute` çš„â€œé¢„è§ˆæ¨¡å¼â€ï¼ˆä¸å†™å…¥ Memoryï¼Œä»…è¿”å›æ›¿æ¢åçš„ç‰‡æ®µï¼‰ï¼Œé¿å…é‡å¤å®ç°å·®å¼‚è®¡ç®—ã€‚

---

## 6. å®ç°è·¯çº¿å›¾

### 6.1 MVPï¼šç¼–è¾‘çŠ¶æ€ä¸æäº¤æµç¨‹ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰
- [ ] `EditingSession` ç±»â€”â€”ç»´æŠ¤åŸºçº¿ä¸ pending changes
- [ ] åŸºç¡€ diff æ¸²æŸ“ï¼ˆç´§å‡‘æ¨¡å¼ï¼‰
- [ ] `memo_commit / memo_revert` çš„æœ€å°å®ç°ä¸å†å²å‹ç¼©é’©å­
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ï¼šIdle â†” Editing è½¬æ¢ã€é¢„è§ˆç”Ÿæˆ

> âœ… äº¤ä»˜ç‰©ï¼šå•æ–‡ä»¶çš„å»¶è¿Ÿæäº¤ç¼–è¾‘å·¥ä½œæµï¼Œæ”¯æŒæ‰‹åŠ¨ commit/revertã€‚

### 6.2 çŸ­æœŸå¢å¼ºï¼šå¤šåŒ¹é…ä¸ä»»åŠ¡æ ˆï¼ˆé¢„è®¡ 4-5 å¤©ï¼‰
- Phase 2ï¼ˆå¤šåŒ¹é…æ”¹è¿›ï¼‰
  - [ ] `match_id` å‚æ•° + å­—æ¯ç´¢å¼•æ¸²æŸ“ï¼ˆé»˜è®¤ A-Eï¼‰
  - [ ] æ™ºèƒ½é»˜è®¤é€‰æ‹© + `show_all_matches` æ”¯æŒ
  - [ ] é›†æˆæµ‹è¯•ï¼šå¤šåŒ¹é… â†’ æŒ‡å®š match_id â†’ commit
- Phase 3ï¼ˆä»»åŠ¡æ ˆä¸å‹ç¼©ï¼‰
  - [ ] `TaskStack` ç»“æ„ + `memo_begin_task`
  - [ ] Chat history å‹ç¼©å¼•æ“ã€æ€ç»´æ ‘æ¸²æŸ“
  - [ ] åµŒå¥—ä»»åŠ¡ã€æ’¤é”€æµç¨‹æµ‹è¯•

> ğŸŸ¡ ç›®æ ‡ï¼šé™ä½å¤šåŒ¹é…æ­§ä¹‰ï¼ŒåŒæ—¶è®© Agent èƒ½è¿½è¸ªâ€œæˆ‘æ­£åœ¨åšä»€ä¹ˆâ€ã€‚

### 6.3 åç»­æ¢ç´¢ï¼šè¡Œå·æ–¹æ¡ˆä¸ä½“éªŒä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
- Phase 4ï¼šè¡Œå·/è¡Œ hash æ¡¥æ¥ï¼ˆé¢„è®¡ 2 å¤©ï¼‰
  - å¸¦è¡Œå·çš„é¢„è§ˆæ¸²æŸ“ã€`line_key` æ”¯æŒ
  - è¡Œ hash æ ¡éªŒé¿å…é™ˆæ—§å¼•ç”¨
- Phase 5ï¼šæŒç»­ä½“éªŒä¼˜åŒ–
  - è‡ªåŠ¨æ‘˜è¦ç”Ÿæˆã€å†²çªæ£€æµ‹
  - å¤§æ–‡ä»¶æ€§èƒ½ã€ç”¨æˆ·åé¦ˆé—­ç¯

> ğŸ”­ è¿™äº›å·¥ä½œåœ¨ MVP æˆåŠŸåæŒ‰éœ€æ’æœŸï¼Œå½¼æ­¤ç‹¬ç«‹ï¼Œå¯é€é¡¹å–èˆã€‚

---

## 7. è®¾è®¡å†³ç­–è®°å½•

### Q1: ä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡† Git-style diffï¼Ÿ
**A**: LLM æ›´é€‚åˆè¯»"ç»“æ„åŒ–æ ‡è®°"è€Œé `+/-` è¡Œã€‚æˆ‘ä»¬çš„ diff æ ¼å¼ä¼˜å…ˆè€ƒè™‘è¯­ä¹‰æ¸…æ™°åº¦ã€‚

### Q2: å‹ç¼©å†å²ä¼šä¸ä¼šä¸¢å¤±é‡è¦ä¿¡æ¯ï¼Ÿ
**A**: æ‘˜è¦ä¿ç•™å…³é”®å†³ç­–ç‚¹ã€‚å¦‚éœ€è¯¦ç»†è¿½æº¯ï¼Œå¯åœ¨ commit å‰è°ƒç”¨ `memo_export_session()` å¯¼å‡ºå®Œæ•´æ—¥å¿—ã€‚

### Q3: ä»»åŠ¡æ ˆæ·±åº¦æœ‰é™åˆ¶å—ï¼Ÿ
**A**: å»ºè®®ä¸è¶…è¿‡ 3 å±‚ã€‚æ›´æ·±çš„åµŒå¥—åº”è¯¥æ‹†åˆ†ä¸ºç‹¬ç«‹çš„é¡¶å±‚ä»»åŠ¡ã€‚

### Q4: ä¸ä¼ ç»Ÿ IDE çš„ undo/redo æœ‰ä½•ä¸åŒï¼Ÿ
**A**: æˆ‘ä»¬ä¸æ”¯æŒç»†ç²’åº¦ undoï¼Œåªæ”¯æŒ"æ’¤é”€æ•´ä¸ªç¼–è¾‘ä¼šè¯"ã€‚è¿™æ›´ç¬¦åˆ LLM çš„"ä¸€æ¬¡æ€§å®Œæˆä»»åŠ¡"æ€ç»´æ¨¡å¼ã€‚

---

## 8. æœªæ¥æ‰©å±•

### 8.1 å¤šæ–‡ä»¶ç¼–è¾‘
å½“å‰è®¾è®¡èšç„¦å•æ–‡ä»¶ã€‚æœªæ¥å¯æ‰©å±•ä¸ºï¼š
```
memo_begin_task("é‡æ„æ¨¡å— A")
  â”œâ”€ file: config.json
  â”‚   â””â”€ å˜æ›´ [A]: ...
  â””â”€ file: main.py
      â””â”€ å˜æ›´ [B]: ...

memo_commit("é‡æ„å®Œæˆ")  â† åŸå­æ€§æäº¤æ‰€æœ‰æ–‡ä»¶
```

### 8.2 åä½œç¼–è¾‘
æ”¯æŒå¤šä¸ª Agent å¹¶å‘ç¼–è¾‘ä¸åŒä»»åŠ¡ï¼š
```
Agent A: [ä»»åŠ¡ 1] æ›´æ–°æ–‡æ¡£
Agent B: [ä»»åŠ¡ 2] ä¿®å¤ bug
â†’ åˆå¹¶æ—¶æ£€æµ‹å†²çª
```

### 8.3 è¯­ä¹‰æœç´¢å®šä½
ç»“åˆå‘é‡æ•°æ®åº“ï¼Œæ”¯æŒ"æ‰¾åˆ°è®¨è®ºæ€§èƒ½ä¼˜åŒ–çš„é‚£ä¸€æ®µ"ä¹‹ç±»çš„æ¨¡ç³ŠæŸ¥è¯¢ã€‚

---

## 9. å‚è€ƒèµ„æ–™

- [Claude Code Editing Patterns](internal)
- [ChatGPT replace_string_in_file](internal)
- [Git Interactive Rebase](https://git-scm.com/docs/git-rebase)
- [Obsidian Edit History](https://obsidian.md)

---

## é™„å½• A: å®Œæ•´ç¤ºä¾‹æµç¨‹

### åœºæ™¯ï¼šLLM ä¿®æ”¹é…ç½®æ–‡ä»¶å¯ç”¨æ–°åŠŸèƒ½

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[åˆå§‹çŠ¶æ€: Idle]
å½“å‰è®°å¿†: config.json (1234 å­—ç¬¦)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Assistant: æˆ‘éœ€è¦å…ˆæŸ¥çœ‹å½“å‰é…ç½®ä»¥ç¡®å®šæ­£ç¡®ä½ç½®

Tool: memo_begin_task
Args: { "goal": "å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X" }

Result:
âœ… ä»»åŠ¡ #1 å·²åˆ›å»º: "å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X"
ğŸ“Š ä»»åŠ¡æ ˆ: [#1 å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X] (æ·±åº¦: 1)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: memo_read

Result:
{
  "features": {
    "stable": ["A", "B", "C"],
    "experimental": []
  }
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Assistant: æˆ‘éœ€è¦åœ¨ experimental æ•°ç»„ä¸­æ·»åŠ  "X"

Tool: memory_notebook_replace
Args: {
  "old_text": "\"experimental\": []",
  "new_text": "\"experimental\": [\"X\"]"
}

Result:
[çŠ¶æ€è½¬æ¢: Idle â†’ Editing]

ğŸ“ ç¼–è¾‘ä¼šè¯ #1 (è¿›è¡Œä¸­)
åŸºå‡†ç‰ˆæœ¬: 1234 å­—ç¬¦

å¾…å®šå˜æ›´ï¼š
[A] æ›¿æ¢ "\"experimental\": []" â†’ "\"experimental\": [\"X\"]"
    ä½ç½®: 567
    å½±å“: +5 å­—ç¬¦

é¢„è§ˆï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 565â”‚   "features": {
 566â”‚     "stable": ["A", "B", "C"],
 567â”‚-    "experimental": []
 567â”‚+    "experimental": ["X"]
 568â”‚   }
 569â”‚ }
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’¡ ä½¿ç”¨ memo_commit("...") æäº¤æˆ– memo_revert("...") æ’¤é”€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Assistant: çœ‹èµ·æ¥æ­£ç¡®ï¼Œæäº¤å˜æ›´

Tool: memo_commit
Args: { "summary": "å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X" }

Result:
[çŠ¶æ€è½¬æ¢: Editing --memo_commit--> Idle]

âœ… ç¼–è¾‘ä¼šè¯ #1 å·²æäº¤
æ‘˜è¦: å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X
å˜æ›´: 1 å¤„æ›¿æ¢, +5 å­—ç¬¦
æ–°è®°å¿†é•¿åº¦: 1239 å­—ç¬¦

âœ… ä»»åŠ¡ #1 å®Œæˆ: "å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X"
ğŸ“Š ä»»åŠ¡æ ˆ: (ç©º)

ğŸŒ³ æœ¬æ¬¡ä¼šè¯å·²å®Œæˆä»»åŠ¡ï¼š
- âœ… å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X

[å†å²å‹ç¼©] å·²åˆ é™¤ 4 æ¡ä¸­é—´æ¶ˆæ¯ï¼ŒèŠ‚çœ ~2500 tokens

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Assistant (æœ€ç»ˆ): å·²å®Œæˆï¼é…ç½®æ–‡ä»¶å·²æ›´æ–°ï¼Œå®éªŒæ€§åŠŸèƒ½ X ç°å·²å¯ç”¨ã€‚
```

### åœºæ™¯ï¼šé‡åˆ°å¤šåŒ¹é… + å­—æ¯ç´¢å¼•

```
User: è¯·å°†æ‰€æœ‰ timeout ä» 30 æ”¹ä¸º 60

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: memory_notebook_replace
Args: {
  "old_text": "timeout: 30",
  "new_text": "timeout: 60"
}

Result:
[çŠ¶æ€è½¬æ¢: Idle â†’ Editing]

æ‰¾åˆ° 3 ä¸ªåŒ¹é…ï¼š

[A] ç¬¬ 12 è¡Œï¼šdatabase.timeout: 30
    ä¸Šä¸‹æ–‡ï¼š# æ•°æ®åº“è¿æ¥é…ç½®

[B] ç¬¬ 45 è¡Œï¼šapi.timeout: 30 â† æ¨èï¼ˆåŸºäºä¸Šä¸‹æ–‡ç›¸å…³æ€§ï¼‰
    ä¸Šä¸‹æ–‡ï¼š# API è°ƒç”¨é…ç½®

[C] ç¬¬ 78 è¡Œï¼šcache.timeout: 30
    ä¸Šä¸‹æ–‡ï¼š# ç¼“å­˜è¿‡æœŸæ—¶é—´

ğŸ’¡ è¯·æŒ‡å®š match_id æˆ–ä½¿ç”¨ memo_commit_auto æ¥å—æ¨è

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Assistant: æˆ‘éœ€è¦ä¿®æ”¹æ‰€æœ‰ä¸‰å¤„ï¼Œå…ˆä»ç¬¬ä¸€ä¸ªå¼€å§‹

Tool: memory_notebook_replace
Args: {
  "old_text": "timeout: 30",
  "new_text": "timeout: 60",
  "match_id": "A"
}

Result:
å¾…å®šå˜æ›´ï¼š
[A] æ›¿æ¢ "timeout: 30" â†’ "timeout: 60" (ç¬¬ 12 è¡Œ)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: memory_notebook_replace
Args: {
  "old_text": "timeout: 30",
  "new_text": "timeout: 60",
  "match_id": "B"
}

Result:
å¾…å®šå˜æ›´ï¼š
[A] æ›¿æ¢ "timeout: 30" â†’ "timeout: 60" (ç¬¬ 12 è¡Œ)
[B] æ›¿æ¢ "timeout: 30" â†’ "timeout: 60" (ç¬¬ 45 è¡Œ)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: memory_notebook_replace
Args: {
  "old_text": "timeout: 30",
  "new_text": "timeout: 60",
  "match_id": "C"
}

Result:
å¾…å®šå˜æ›´ï¼š
[A] æ›¿æ¢ "timeout: 30" â†’ "timeout: 60" (ç¬¬ 12 è¡Œ)
[B] æ›¿æ¢ "timeout: 30" â†’ "timeout: 60" (ç¬¬ 45 è¡Œ)
[C] æ›¿æ¢ "timeout: 30" â†’ "timeout: 60" (ç¬¬ 78 è¡Œ)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: memo_commit
Args: { "summary": "ç»Ÿä¸€è¶…æ—¶æ—¶é—´ä¸º 60 ç§’" }

Result:
âœ… ç¼–è¾‘ä¼šè¯å·²æäº¤
å˜æ›´: 3 å¤„æ›¿æ¢, +6 å­—ç¬¦
```

### åœºæ™¯ï¼šåµŒå¥—ä»»åŠ¡ + å‘ç°ä¾èµ–

```
User: è¯·æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: memo_begin_task
Args: { "goal": "æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y" }

Result:
ğŸ“Š ä»»åŠ¡æ ˆ: [#2 æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y] (æ·±åº¦: 1)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Assistant: æˆ‘éœ€è¦å…ˆæ£€æŸ¥ä¾èµ–ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³è¦æ±‚

Tool: memo_begin_task
Args: {
  "goal": "æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬",
  "parent_task_id": "2"
}

Result:
ğŸ“Š ä»»åŠ¡æ ˆ:
â”Œâ”€ [#2] æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y
â”‚   â””â”€ [#3] æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬ (å½“å‰)
â””â”€ (æ·±åº¦: 2)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[è¿›è¡Œä¾èµ–æ£€æŸ¥å’Œæ›´æ–°...]

Tool: memo_commit
Args: {
  "summary": "ä¾èµ–ç‰ˆæœ¬å·²ç¡®è®¤æ»¡è¶³è¦æ±‚",
  "auto_pop_task": true
}

Result:
âœ… ä»»åŠ¡ #3 å®Œæˆ: "æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬"
ğŸ“Š ä»»åŠ¡æ ˆ: [#2 æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y] (æ·±åº¦: 1)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ç»§ç»­ä¸»ä»»åŠ¡...]

Tool: memo_commit
Args: { "summary": "åŠŸèƒ½æ¨¡å— Y æ·»åŠ å®Œæˆ" }

Result:
âœ… ä»»åŠ¡ #2 å®Œæˆ: "æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y"

ğŸŒ³ æœ¬æ¬¡ä¼šè¯å·²å®Œæˆä»»åŠ¡ï¼š
- âœ… å¯ç”¨å®éªŒæ€§åŠŸèƒ½ X
- âœ… æ·»åŠ æ–°åŠŸèƒ½æ¨¡å— Y
  â””â”€ âœ… æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
```

---

## é™„å½• B: æŠ€æœ¯å®ç°è¦ç‚¹

### B.1 EditingSession ç»“æ„

```csharp
internal sealed class EditingSession {
    public string SessionId { get; }
    public string BaseContent { get; }
    public List<PendingChange> Changes { get; }
    public DateTime StartedAt { get; }

    public record PendingChange(
        string ChangeId,        // "A", "B", "C"...
        int Position,
        int OldLength,
        string NewText,
        string ContextBefore,
        string ContextAfter
    );

    public string RenderPreview(PreviewMode mode);
    public string ApplyChanges();
    public void AddChange(PendingChange change);
    public void RemoveChange(string changeId);
}
```

### B.2 TaskStack ç»“æ„

```csharp
internal sealed class TaskStack {
    private readonly Stack<TaskNode> _stack = new();
    private readonly List<TaskNode> _completed = new();

    public record TaskNode(
        string TaskId,
        string Goal,
        DateTime StartedAt,
        TaskStatus Status,
        string? Summary,
        List<TaskNode> Children
    );

    public enum TaskStatus {
        Active,
        Completed,
        Reverted
    }

    public string RenderTree();
    public void Push(string goal);
    public TaskNode Pop(string summary, bool success);
}
```

### B.3 å†å²å‹ç¼©ç®—æ³•

```csharp
internal sealed class HistoryCompressor {
    public CompressedHistory Compress(
        IEnumerable<ChatMessage> messages,
        EditingSession session,
        string commitSummary
    ) {
        // 1. è¯†åˆ«ç¼–è¾‘ä¼šè¯è¾¹ç•Œ
        var sessionMessages = messages
            .SkipWhile(m => m.Timestamp < session.StartedAt)
            .TakeWhile(m => m.Type != MessageType.Commit);

        // 2. æå–å…³é”®ä¿¡æ¯
        var keyDecisions = ExtractDecisions(sessionMessages);

        // 3. ç”Ÿæˆæ‘˜è¦èŠ‚ç‚¹
        return new CompressedHistory {
            Summary = commitSummary,
            Changes = session.Changes.Select(c => c.ToSummary()),
            KeyDecisions = keyDecisions,
            TokensSaved = CalculateTokensSaved(sessionMessages)
        };
    }
}
```

---

## é™„å½• C: é…ç½®å‚æ•°

### å…¨å±€é…ç½®

```json
{
  "editing": {
    "auto_preview": true,
    "max_pending_changes": 26,
    "preview_context_lines": 3,
    "preview_max_length": 500
  },
  "tasks": {
    "max_stack_depth": 3,
    "auto_pop_on_commit": true,
    "show_tree_in_prompt": true
  },
  "history": {
    "enable_compression": true,
    "compression_threshold": 5,
    "keep_key_decisions": true
  },
  "matching": {
    "auto_select_single_match": true,
    "smart_recommendation": true,
    "max_candidates_shown": 5
  }
}
```

---

## é™„å½• D: å¼€æ”¾é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†éå¸¸å¤§çš„æ–‡ä»¶ï¼Ÿ
**å½“å‰æƒ³æ³•**ï¼š
- ç¼–è¾‘ä¼šè¯åªæ¸²æŸ“"å˜æ›´çª—å£"ï¼ˆå‰åå„ N è¡Œï¼‰
- å®Œæ•´ diff å¯æŒ‰éœ€é€šè¿‡ `memo_export_diff()` è·å–
- è€ƒè™‘å¼•å…¥"åˆ†å—ç¼–è¾‘"æ¨¡å¼

### Q2: å¤šä¸ª Agent å¹¶å‘ç¼–è¾‘åŒä¸€æ–‡ä»¶ï¼Ÿ
**å½“å‰æƒ³æ³•**ï¼š
- Phase 1 ä¸æ”¯æŒï¼ŒæŠ¥é”™æç¤ºå†²çª
- Phase 2 å¯å¼•å…¥"ç¼–è¾‘é”"æˆ–"åˆ†æ”¯"æœºåˆ¶

### Q3: å¦‚ä½•ä¸ä¼ ç»Ÿ Git å·¥ä½œæµé›†æˆï¼Ÿ
**å½“å‰æƒ³æ³•**ï¼š
- `memo_commit` å¯é€‰è§¦å‘ `git commit`
- ä»»åŠ¡æ ‘å¯æ˜ å°„ä¸º Git åˆ†æ”¯ç»“æ„
- å¾…è¯¦ç»†è®¾è®¡

---

## å˜æ›´æ—¥å¿—

### v0.1 (2025-10-08)
- åˆå§‹è®¾è®¡æ–‡æ¡£
- å®šä¹‰æ ¸å¿ƒçŠ¶æ€æœº
- è®¾è®¡å­—æ¯ç´¢å¼•ç³»ç»Ÿ
- è§„åˆ’é€’å½’ä»»åŠ¡æ ˆ
- ç¼–å†™å®Œæ•´ç¤ºä¾‹æµç¨‹
